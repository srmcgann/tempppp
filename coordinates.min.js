const e="https://srmcgann.github.io/Coordinates";import*as a from"https://srmcgann.github.io/GenHash/hash.js";const t=document.createElement("script");await t.setAttribute("src",e+"/zip.js"),await document.body.appendChild(t);const r=Math.sin,o=Math.cos,n=Math.random;var s=!1;const i=document.createElement("canvas"),c=i.getContext("2d",{alpha:!0,antialias:!0,imageSmoothingEnabled:!0,desynchronized:!0,premultipliedAlpha:!1});new Image;var l;const h={objFiles:[],customShapes:[],textures:[],geometry:[],texImages:[]},f=async e=>{var a=0,t=0,n=0,s=1920,i=1080,c=0,l=0,h=0,p=2e3,f=!0,u=10,m=!1,d=.2,g=!1,v=0,y="default",b=!1,x=0,R="",M={mode:"webgl2",options:{alpha:!0,antialias:!1,desynchronized:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0}},A=[],E=[0,0,0],T={data:[],items:[]};void 0!==e&&Object.keys(e).forEach(((r,o)=>{switch(r.toLowerCase()){case"plugins":e[r].map((e=>{if("post processing"===e.type.toLowerCase())if(void 0===e.enabled||e.enabled){var a={name:e.type.toLowerCase(),value:e.value.toLowerCase(),enabled:void 0===e.enabled||!!e.enabled,params:e?.params?e.params.map((e=>e.toLowerCase())):[]};A.push(a)}}));break;case"width":s=e[r];break;case"height":i=e[r];break;case"alpha":g=e[r];break;case"x":a=e[r];break;case"y":t=e[r];break;case"z":n=e[r];break;case"roll":c=e[r];break;case"pitch":l=e[r];break;case"yaw":h=e[r];break;case"fov":p=e[r];break;case"fog":e[r];break;case"fogcolor":E=e[r];break;case"clearcolor":v=e[r];break;case"attachtobody":f=!!e[r];break;case"exportgpuspecs":m=!!e[r];break;case"margin":u=e[r];break;case"cameramode":y=e[r];break;case"ambientlight":d=e[r];break;case"showcrosshair":b=!!e[r];break;case"dataarray":T=e[r];break;case"crosshairsel":x=e[r];break;case"crosshairmap":R=e[r];break;case"context":M.mode=e[r].mode,M.options=e[r].options}}));const w=document.createElement("canvas"),P=w.getContext(M.mode,M.options);w.width=s,w.height=i,w.tabIndex=0,w.style.outline="none";const _=M.mode;if("2d"!=M.mode&&(console.log(`GLSL version: ${P.getParameter(P.SHADING_LANGUAGE_VERSION)}`),P.pixelStorei(P.UNPACK_ALIGNMENT,4)),m&&Ie(P),"2d"===M.mode);else P.viewport(0,0,w.width,w.height);var L,I;f&&(w.style.display="block",w.style.position="absolute",w.style.left="50vw",w.style.top="50vh",w.style.transform="translate(-50%, -50%)",document.body.appendChild(w)),window.addEventListener("resize",L=e=>{var a,t=I.margin,r=document.body,o=0!==w.width?w.height/w.width:1;r.clientHeight/r.clientWidth>o?(w.style.width=(a=r.clientWidth)-2*t+"px",w.style.height=a*o-2*t+"px"):(w.style.height=(a=r.clientHeight)-2*t+"px",w.style.width=a/o-2*t+"px")}),I={c:w,ctx:P,contextType:_,t:0,alpha:g,width:s,height:i,x:a,y:t,z:n,roll:c,pitch:l,yaw:h,fov:p,ready:!1,ambientLight:d,clearColor:v,pointLights:[],pointLightCols:[],dataArray:T,glowQueue:[],alphaQueue:[],particleQueue:[],lineQueue:[],active:!0,cameraMode:y,showCrosshair:b,crosshairSel:x,crosshairMap:R,pageX:undefined,pageY:undefined,mouseX:undefined,mouseY:undefined,mouseButton:undefined,rsz:L,margin:u,optionalPlugins:A,fogColor:E},L(),I["2d"==_?"ctx":"gl"]=P;var k=I;k.Clear=()=>{if("2d"===_)w.width=k.c.width;else P.clearColor(...Le(k.clearColor),1),P.clear(P.COLOR_BUFFER_BIT),P.clear(P.DEPTH_BUFFER_BIT)};de(k,"NullDraw");return k.Draw=(e,a=!1,t=!1)=>{var n,s,i=e.shader.datasets[e.datasetIdx],c=i.program;if(1!=e.alpha||e.isLine||e.isParticle||e.isLight||e.isSprite?(P.blendFunc(P.SRC_ALPHA,P.ONE),P.enable(P.BLEND),P.cullFace(P.BACK)):(P.disable(P.CULL_FACE),("sprite"!=e.shapeType||"point light"!=e.shapeType&&e.showSource)&&P.disable(P.BLEND)),k.optionalPlugins.map((e=>{if("post processing"===e.name)if("equirectangular"===e.value)e.enabled&&(n=!0,k.equirectangularPlugin=!0,s=!(-1==e.params.indexOf("omitsplitcheck")));else n=!1,k.equirectangularPlugin=!1})),void 0!==e?.shader)if(!a&&(e.isSprite||e.isLight&&e.showSource)){switch(e.shapeType){case"sprite":case"point light":l="alphaQueue"}k[l]=[{x:e.x,y:e.y,z:e.z,roll:e.roll,pitch:e.pitch,yaw:e.yaw,size:e.size,shapeType:e.shapeType,vertices:e.vertices,offsets:e.offsets,geometry:e},...k[l]]}else{if(e.glow)k[l="glowQueue"]=[{x:e.x,y:e.y,z:e.z,roll:e.roll,pitch:e.pitch,yaw:e.yaw,size:e.size,shapeType:e.shapeType,geometry:e},...k[l]];if(!a&&(e.isLine||e.isParticle)){var l;switch(e.shapeType){case"particles":l="particleQueue";break;case"lines":l="lineQueue"}k[l]=[{x:e.x,y:e.y,z:e.z,roll:e.roll,pitch:e.pitch,yaw:e.yaw,size:e.size,shapeType:e.shapeType,vertices:e.vertices,offsets:e.offsets,geometry:e},...k[l]]}e.isShapeArray&&N(e),P.useProgram(c),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_MAG_FILTER,e.flatShading?P.NEAREST:P.LINEAR);for(var h=0;h<(n&&!s?2:1);h++){if(P.uniform1i(i.locRotationMode,e.rotationMode),k.locPlugin=P.getUniformLocation(i.program,"plugin"),k.locOmitSplitCheck=P.getUniformLocation(i.program,"omitSplitCheck"),k.locSplitCheckPass=P.getUniformLocation(i.program,"splitCheckPass"),P.uniform1f(k.locPlugin,n?1:0),P.uniform1f(k.locOmitSplitCheck,s?1:0),P.uniform1f(k.locSplitCheckPass,h),e.showBounding)O(e,k,e.showBounding,n,s,h);if("particles"==e.shapeType||e.isParticle||"lines"==e.shapeType||e.isLine){if(k.ctx.blendFunc(P.ONE,P.SRC_ALPHA),k.ctx.enable(P.BLEND),P.uniform1f(i.locPointSize,e.size*(t?3:1)),"lines"==e.shapeType&&P.lineWidth(e.size*(t?3:1)),P.uniform1f(i.locIsParticle,e.isParticle),P.uniform1f(i.locIsLine,e.isLine),P.uniform1f(i.locPenumbraPass,e.penumbraPass?1:0),P.uniform1f(i.locT,k.t),P.uniform1f(i.locColorMix,e.colorMix),P.uniform1f(i.locIsSprite,e.isSprite),P.uniform1f(i.locIsLight,e.isLight),P.uniform1f(i.locCameraMode,"fps"==k.cameraMode.toLowerCase()?1:0),P.uniform1f(i.locAlpha,Math.min(1,Math.max(0,t?e.alpha*e.penumbra:e.alpha))),P.uniform3f(i.locColor,...Le(e.color)),P.uniform1f(i.locAmbientLight,V/8),P.uniform2f(i.locResolution,k.width,k.height),P.uniform3f(i.locCamPos,k.x,k.y,k.z),P.uniform3f(i.locCamOri,k.roll,k.pitch,k.yaw),P.uniform3f(i.locGeoPos,e.x,e.y,e.z),P.uniform3f(i.locGeoOri,e.roll,e.pitch,e.yaw),P.uniform1f(i.locFov,k.fov),P.uniform1f(i.locEquirectangular,e.equirectangular?1:0),P.uniform1f(i.locRenderNormals,0),e?.vertices?.length){var p,f,u,m,d,g,v,y,b,x,R,M,A,E,T,w;if(e.isLine){m=[];for(var _=k.fov,L=e.size*(t?4:1)/50,I=0;I<e.vertices.length;I+=6)R=e.vertices[I+0],M=e.vertices[I+1],A=e.vertices[I+2],E=e.vertices[I+3],T=e.vertices[I+4],w=e.vertices[I+5],g=B(R,M,A,e,k),v=B(E,T,w,e,k),(g[2]>-200&&v[0]>-200||n)&&(d=Math.atan2(v[0]-g[0],v[1]-g[1])+Math.PI/2,g[0]-=k.width/2,g[1]-=k.height/2,v[0]-=k.width/2,v[1]-=k.height/2,g[0]/=_/2,g[1]/=_/2,v[0]/=_/2,v[1]/=_/2,x=g[2],y=g[0]+r(d)*L/x,b=g[1]+o(d)*L/x,m.push(y,-b,x),x=g[2],y=g[0]-r(d)*L/x,b=g[1]-o(d)*L/x,m.push(y,-b,x),x=v[2],y=v[0]-r(d)*L/x,b=v[1]-o(d)*L/x,m.push(y,-b,x),x=v[2],y=v[0]-r(d)*L/x,b=v[1]-o(d)*L/x,m.push(y,-b,x),x=v[2],y=v[0]+r(d)*L/x,b=v[1]+o(d)*L/x,m.push(y,-b,x),x=g[2],y=g[0]+r(d)*L/x,b=g[1]+o(d)*L/x,m.push(y,-b,x));m=new Float32Array(m),f=P.createBuffer(),P.bindBuffer(P.ARRAY_BUFFER,f),P.bufferData(P.ARRAY_BUFFER,m,P.STATIC_DRAW),P.bindBuffer(P.ARRAY_BUFFER,null),u=new Uint32Array(Array(m.length/3).fill().map(((e,a)=>a))),p=P.createBuffer(),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,p),P.bufferData(P.ELEMENT_ARRAY_BUFFER,u,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null)}else m=e.vertices,p=e.Vertex_Index_Buffer,f=e.vertex_buffer,u=e.vIndices;var F=[];for(I=0;I<e.vertices.length;I+=3)F.push(e.offsets[I+0],e.offsets[I+1],e.offsets[I+2]),F.push(e.offsets[I+0],e.offsets[I+1],e.offsets[I+2]),F.push(e.offsets[I+0],e.offsets[I+1],e.offsets[I+2]);F=new Float32Array(F);var z=new Uint32Array(Array(F.length/3).fill().map(((e,a)=>a)));P.bindBuffer(P.ARRAY_BUFFER,f),P.bufferData(P.ARRAY_BUFFER,m,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,p),P.bufferData(P.ELEMENT_ARRAY_BUFFER,u,P.STATIC_DRAW),P.bindBuffer(P.ARRAY_BUFFER,f),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,p),i.locPosition=P.getAttribLocation(i.program,"position"),P.vertexAttribPointer(i.locPosition,3,P.FLOAT,!1,0,0),P.enableVertexAttribArray(i.locPosition),e.isLine||(P.bindBuffer(P.ARRAY_BUFFER,e.offset_buffer),P.bufferData(P.ARRAY_BUFFER,F,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.Offset_Index_Buffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,z,P.STATIC_DRAW),i.locOffset=P.getAttribLocation(i.program,"offset"),P.vertexAttribPointer(i.locOffset,3,P.FLOAT,!1,0,0),P.enableVertexAttribArray(i.locOffset)),e.isLine?P.drawElements(P.TRIANGLES,m.length/3|0,P.UNSIGNED_INT,0):P.drawElements(P.POINTS,e.vertices.length/3|0,P.UNSIGNED_INT,0),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null)}if(k.ctx.blendFunc(P.ONE,P.ZERO),k.ctx.disable(P.BLEND),t)return}else{switch(P.activeTexture(P.TEXTURE0),e.textureMode){case"video":case"dataArray":U(P,i.resource,i.texture,e.textureMode,k.t,e);break;case"canvas":P.activeTexture(P.TEXTURE2),U(P,e.canvasTexture,i.texture,e.textureMode,k.t,e);break;case"image":e.rebindTextures&&U(P,e.image,i.texture,e.textureMode,k.t,e)}void 0!==e.canvasTexture&&(P.activeTexture(P.TEXTURE2),U(P,e.canvasTexture,i.supplementalTexture,"canvas",k.t,e),P.uniform1i(i.locSupplementalTexture,2),P.uniform1f(i.locSupplementalTextureMix,e.canvasTextureMix)),P.activeTexture(P.TEXTURE0),P.uniform1i(i.locTexture,i.texture),P.bindTexture(P.TEXTURE_2D,i.texture),e.heightMap?(P.activeTexture(P.TEXTURE4),P.uniform1i(i.locHeightMap,4),U(P,i.heightResource,i.heightTexture,e.heightMapIsCanvas?"canvas":e.heightTextureMode,k.t,e),P.uniform1i(i.locHeightTexture,i.heightTexture),P.uniform1f(i.locUseHeightMap,1),P.uniform1f(i.locHeightMapIntensity,e.heightMapIntensity),P.uniform1f(i.locMaxHeightmap,e.maxHeightmap),P.uniform1f(i.locEquirectangularHeightmap,e.equirectangularHeightmap?1:0),P.bindTexture(P.TEXTURE_2D,i.heightTexture),P.activeTexture(P.TEXTURE0)):P.uniform1f(i.locUseHeightMap,0),P.uniform1i(i.locPointLightCount,k.pointLights.length);var C=[],S=[];k.pointLights.map((e=>{C.push(e.x,e.y,e.z,e.lum);Le(e.color);S.push(...Le(e.color),1)})),C.length&&(P.uniform4fv(i.locPointLights,C),P.uniform4fv(i.locPointLightCols,S));var V=k.ambientLight;i.optionalLighting.map((e=>{if("ambientLight"===e.name)V=e.value})),P.useProgram(c),k.hasFog||(P.uniform1f(i.locFog,0),P.uniform3f(i.locFogColor,...k.fogColor)),i.optionalUniforms.map((a=>{if("object"==typeof a?.loc)switch("uniform4f"==a.dataType?P[a.dataType](a.loc,...a.value):P[a.dataType](a.loc,a.value),P.uniform1f(a.locFlatShading,a.flatShading?1:0),a.name){case"fog":P.uniform1f(i.locFog,a.value),P.uniform3f(i.locFogColor,...Le(a.color));break;case"reflection":P.activeTexture(P.TEXTURE1),"image"==a.textureMode&&e.rebindTextures&&U(P,a.image,a.refTexture,a.textureMode,k.t,a),"video"==a.textureMode&&U(P,a.video,a.refTexture,a.textureMode,k.t,a),P.activeTexture(P.TEXTURE1),P.uniform1i(a.locRefTexture,1),P.uniform1f(a.locRefTheta,a.theta),P.bindTexture(P.TEXTURE_2D,a.refTexture),P.uniform1f(a.locRefOmitEquirectangular,"rectangle"==e.shapeType||"point light"==e.shapeType||"sprite"==e.shapeType?1:0);break;case"refraction":P.activeTexture(P.TEXTURE5),"video"==a.textureMode&&U(P,a.video,a.refractionTexture,a.textureMode,k.t,a),P.activeTexture(P.TEXTURE5),P.uniform1i(a.locRefractionTexture,5),P.bindTexture(P.TEXTURE_2D,a.refractionTexture),P.uniform1f(a.locRefractionOmitEquirectangular,"rectangle"==e.shapeType||"point light"==e.shapeType||"sprite"==e.shapeType?1:0),a.locAngleOfRefraction=P.getUniformLocation(i.program,"angleOfRefraction"),P.uniform1f(a.locAngleOfRefraction,a.angleOfRefraction),P.bindBuffer(P.ARRAY_BUFFER,a.refractionVec_buffer),P.bufferData(P.ARRAY_BUFFER,a.refractionVecs,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,a.RefractionVec_Index_Buffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,a.refractionVecIndices,P.STATIC_DRAW),P.bindBuffer(P.ARRAY_BUFFER,a.refractionVec_buffer),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,a.RefractionVec_Index_Buffer),P.vertexAttribPointer(i.locRefractionlVec,3,P.FLOAT,!1,0,0),P.enableVertexAttribArray(i.locRefractionlVec),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null);break;case"phong":a.locPhongTheta=P.getUniformLocation(i.program,"phongTheta"),P.uniform1f(a.locPhongTheta,a.theta+Math.PI);break;case"custom":if(a.uniformName){a.value;-1!=a.name.indexOf("[0]")?(a.locCustomUniform=P.getUniformLocation(i.program,a.uniformName),P[a.dataType](a.locCustomUniform,a.value)):(a.locCustomUniform=P.getUniformLocation(i.program,a.uniformName),P[a.dataType](a.locCustomUniform,...a.value))}}})),P.uniform1f(i.locT,k.t),P.uniform1f(i.locIsParticle,e.isParticle),P.uniform1f(i.locIsLine,e.isLine),P.uniform1f(i.locPenumbraPass,0),P.uniform1f(i.locColorMix,e.colorMix),P.uniform1f(i.locIsSprite,e.isSprite),P.uniform1f(i.locIsLight,e.isLight),P.uniform1f(i.locCameraMode,"fps"==k.cameraMode.toLowerCase()?1:0),P.uniform1f(i.locAlpha,e.alpha),P.uniform3f(i.locColor,...Le(e.color)),P.uniform1f(i.locAmbientLight,V/8),P.uniform2f(i.locResolution,k.width,k.height),P.uniform3f(i.locCamPos,k.x,k.y,k.z),P.uniform3f(i.locCamOri,k.roll,k.pitch,k.yaw),P.uniform3f(i.locGeoPos,e.x,e.y,e.z),P.uniform3f(i.locGeoOri,e.roll,e.pitch,e.yaw),P.uniform1f(i.locFov,k.fov),P.uniform1f(i.locEquirectangular,e.equirectangular?1:0),P.uniform1f(i.locRenderNormals,0),P.bindBuffer(P.ARRAY_BUFFER,e.uv_buffer),P.bufferData(P.ARRAY_BUFFER,e.uvs,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.UV_Index_Buffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,e.uvIndices,P.STATIC_DRAW),P.vertexAttribPointer(i.locUv,2,P.FLOAT,!1,0,0),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null),e?.normalVecs.length&&(P.bindBuffer(P.ARRAY_BUFFER,e.normalVec_buffer),P.bufferData(P.ARRAY_BUFFER,e.normalVecs,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.NormalVec_Index_Buffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,e.nIndices,P.STATIC_DRAW),P.bindBuffer(P.ARRAY_BUFFER,e.normalVec_buffer),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.NormalVec_Index_Buffer),i.locNormalVec=P.getAttribLocation(i.program,"normalVec"),P.vertexAttribPointer(i.locNormalVec,3,P.FLOAT,!1,0,0),P.enableVertexAttribArray(i.locNormalVec),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null)),e?.vertices?.length&&(P.bindBuffer(P.ARRAY_BUFFER,e.vertex_buffer),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.Vertex_Index_Buffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,e.vIndices,P.STATIC_DRAW),P.bindBuffer(P.ARRAY_BUFFER,e.vertex_buffer),P.bufferData(P.ARRAY_BUFFER,e.vertices,P.STATIC_DRAW),i.locPosition=P.getAttribLocation(i.program,"position"),P.vertexAttribPointer(i.locPosition,3,P.FLOAT,!1,0,0),P.enableVertexAttribArray(i.locPosition),P.bindBuffer(P.ARRAY_BUFFER,e.offset_buffer),P.bufferData(P.ARRAY_BUFFER,e.offsets,P.STATIC_DRAW),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.Offset_Index_Buffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,e.oIndices,P.STATIC_DRAW),i.locOffset=P.getAttribLocation(i.program,"offset"),P.vertexAttribPointer(i.locOffset,3,P.FLOAT,!1,0,0),P.enableVertexAttribArray(i.locOffset),P.drawElements(e.wireframe?P.LINE_STRIP:P.TRIANGLES,e.vertices.length/3|0,P.UNSIGNED_INT,0),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null)),P.uniform1f(i.locRenderNormals,e.showNormals?1:0),e.showNormals&&e?.normals?.length&&(P.bindBuffer(P.ARRAY_BUFFER,e.normal_buffer),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,e.Normal_Index_Buffer),P.bufferData(P.ELEMENT_ARRAY_BUFFER,e.nIndices,P.STATIC_DRAW),i.locNormal=P.getAttribLocation(i.program,"normal"),P.vertexAttribPointer(i.locNormal,3,P.FLOAT,!1,0,0),P.bindBuffer(P.ARRAY_BUFFER,e.normal_buffer),P.bufferData(P.ARRAY_BUFFER,e.normals,P.STATIC_DRAW),P.enableVertexAttribArray(i.locNormal),P.drawElements(P.LINES,e.normals.length/3|0,P.UNSIGNED_INT,0),P.bindBuffer(P.ELEMENT_ARRAY_BUFFER,null),P.bindBuffer(P.ARRAY_BUFFER,null))}}}e.rebindTextures=!1},D(k,[{uniform:{type:"phong",value:0}}]).then((e=>{k.nullShader=e})),k.alphaShader=await D(k,[]),window.addEventListener("mousemove",(e=>{var a=k.c.getBoundingClientRect();k.mouseX=(e.pageX-a.left)/k.c.clientWidth*k.width,k.mouseY=(e.pageY-a.top)/k.c.clientHeight*k.height})),window.addEventListener("mousedown",(e=>{k.mouseButton=e.buttons})),window.addEventListener("mouseup",(e=>{k.mouseButton=-1})),k},u=(e,a,t)=>{if(e.width=a,e.height=t,e.c.width=a,e.c.height=t,e.rsz(),"2d"===e.ctx.mode);else e.ctx.viewport(0,0,e.c.width,e.c.height)},m=e=>{e.c.remove(),e.active=!1},g=e=>{if("point light"===e.shapeType)e.renderer.pointLights=e.renderer.pointLights.filter(((a,t)=>t!=e.pointLightID)),e.renderer.pointLights.map(((e,a)=>e.pointLightID=a))},v=(e,a,t,r,o,n)=>{var s;e.split("\n").forEach((e=>{var n=e.split(" ");switch(n[0]){case"v":n.shift(),a.push(n.map((e=>+e)));break;case"vt":n.shift(),r.push(n.map((e=>+e)));break;case"vn":n.shift(),t.push(n.map((e=>+e)));break;case"f":n.shift(),o.push(n.map((e=>e)))}})),o.map((e=>{var o,i,c,l=[],h=[],p=[],f=!1;if(e.map((e=>{var n=e.split("/");switch(n.length){case 1:o=n[0],l.push(a[o-1]);break;case 2:o=n[0],i=n[1],l.push(a[o-1]),h.push(r[i-1]),!0;break;case 3:o=n[0],i=n[1],c=n[2],l.push(a[o-1]),h.push(r[i-1]),p.push(t[c-1]),f=!0}})),void 0!==l[0]){var u=l[0][0],m=l[0][1],d=l[0][2],g=l[1][0],v=l[1][1],y=l[1][2],b=l[2][0],x=l[2][1],R=l[2][2];if(f)var M=p[0][0],A=p[0][1],E=p[0][2],T=p[1][0],w=p[1][1],P=p[1][2],_=p[2][0],L=p[2][1],I=p[2][2];if(4==l.length){var k=l[3][0],F=l[3][1],z=l[3][2];if(f)var U=p[3][0],C=p[3][1],S=p[3][2]}}switch(l.length){case 3:s=[],p.map(((e,a)=>{s.push([u,m,d,u+M,m+A,d+E],[g,v,y,g+T,v+w,y+P],[b,x,R,b+_,x+L,R+I])})),p=s,n.vertices.push(...l[0],...l[1],...l[2]),h.length&&void 0!==h[0]&&n.uvs.push(...h[0],...h[1],...h[2]),p.length&&void 0!==p[0]&&n.normals.push(...p[0],...p[1],...p[2]);break;case 4:s=[],p.map(((e,a)=>{s.push([u,m,d,u+M,m+A,d+E],[g,v,y,g+T,v+w,y+P],[b,x,R,b+_,x+L,R+I],[k,F,z,k+U,F+C,z+S])})),p=s,n.vertices.push(...l[0],...l[1],...l[2],...l[2],...l[3],...l[0]),h.length&&n.uvs.push(...h[0],...h[1],...h[2],...h[2],...h[3],...h[0]),p.length&&n.normals.push(...p[0],...p[1],...p[2],...p[2],...p[3],...p[0])}var B=n.normals.length-7;n.normals[B+3],n.normals[B+0],n.normals[B+4],n.normals[B+1],n.normals[B+5],n.normals[B+2]}))},y=(e,a=0,t=0,r=0,o=0,n=0,s=0)=>{for(var i=0;i<e.uvs.length;i+=2)e.uvs[i+1]=1-e.uvs[i+1];for(i=0;i<e.normals.length;i+=3)e.normals[i+1]=e.normals[i+1];for(i=0;i<e.vertices.length;i+=3){var c=[e.vertices[i+0],e.vertices[i+1],e.vertices[i+2]];c=A(...c,{roll:o,pitch:n,yaw:s}),e.vertices[i+0]=c[0],e.vertices[i+1]=c[1],e.vertices[i+2]=c[2];for(var l=2;l--;){var h=l?2*i:2*i+3;c=[e.normals[h+0],e.normals[h+1],e.normals[h+2]];c=A(...c,{roll:o,pitch:n,yaw:s}),e.normals[h+0]=c[0],e.normals[h+1]=c[1],e.normals[h+2]=c[2]}}},b=async(e,a,t,r,o,n,s,i,c=!1,p=!0)=>{var f={vertices:[],normals:[],uvs:[]};if(p&&(l=h.objFiles.filter((a=>a.url==e))).length)f=l[0].ret;else{var u=[],m=[],d=[],g=[];await fetch(e).then((e=>e.text())).then((e=>{v(e,u,m,d,g,f)})),h.objFiles=[...structuredClone(h.objFiles),{url:e,ret:f}]}return y(f,t,r,o,n,s,i),f},x=(e,a,t,r,o=700)=>[r.width/2+e/t*o,r.height/2+a/t*o],R=(e,a,t,n,s=!1)=>{var i,c,l=Math,h=l.hypot,p=l.atan2,f=n.roll,u=n.pitch,m=n.yaw;(e=r(i=p(e,a)+f)*(c=h(e,a)),a=o(i)*c,e=r(i=p(e,t)+m)*(c=h(e,t)),t=o(i)*c,a=r(i=p(a,t)+u)*(c=h(a,t)),t=o(i)*c,s)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},M=(e,a,t,n,s=!1)=>{var i,c,l=Math,h=l.hypot,p=l.atan2,f=n.roll,u=n.pitch,m=n.yaw;(e=r(i=p(e,t)+m)*(c=h(e,t)),t=o(i)*c,a=r(i=p(a,t)+u)*(c=h(a,t)),t=o(i)*c,e=r(i=p(e,a)+f)*(c=h(e,a)),a=o(i)*c,s)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},A=(e,a,t,n,s=!1)=>{var i,c,l=Math,h=l.hypot,p=l.atan2,f=n.roll,u=n.pitch,m=n.yaw;(a=r(i=p(a,t)+u)*(c=h(a,t)),t=o(i)*c,e=r(i=p(e,t)+m)*(c=h(e,t)),t=o(i)*c,e=r(i=p(e,a)+f)*(c=h(e,a)),a=o(i)*c,s)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},E=(e,a,t,n,s=!1)=>{var i,c,l=Math,h=l.hypot,p=l.atan2,f=n.roll,u=n.pitch,m=n.yaw;(e=r(i=p(e,a)+f)*(c=h(e,a)),a=o(i)*c,a=r(i=p(a,t)+u)*(c=h(a,t)),t=o(i)*c,e=r(i=p(e,t)+m)*(c=h(e,t)),t=o(i)*c,s)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},T=(e,a,t,n,s=!1)=>{var i,c,l=Math,h=l.hypot,p=l.atan2,f=n.roll,u=n.pitch,m=n.yaw;(e=r(i=p(e,a)+f)*(c=h(e,a)),a=o(i)*c,e=r(i=p(e,t)+m)*(c=h(e,t)),t=o(i)*c,a=r(i=p(a,t)+u)*(c=h(a,t)),t=o(i)*c,s)&&(e+=n.x,a+=n.y,t+=n.z);return[e,a,t]},w=(e,a,t)=>{var r=[],o=a.name,n={loaded:!1,curFrame:0,geometries:[],dir:1};return fetch(a.url).then((e=>e.blob())).then((s=>{new zip.ZipReader(new zip.BlobReader(s)).getEntries().then((s=>{var i=s.length;r=Array(i).fill().map((e=>({data:{}}))),s.forEach((async(s,c)=>{(await s.getData(await new zip.BlobWriter)).text().then((s=>{do{0}while("PK"==s.substr(0,2));if("custom shape"!=a.shapeType&&"lines"!=a.shapeType||(s=JSON.parse(s)),r[c].data=s,c==i-1){n.loaded=!0;var l=new zip.ZipWriter(new zip.BlobWriter);r.forEach(((r,s)=>{var c=(""+(s+1)).padStart(4,"0");s%1||!("lines"!=a.shapeType&&"custom shape"!=a.shapeType||void 0!==r.data.vertices&&r.data.vertices.length)||(a.geometryData=r.data,a.name=`${o?o+"_":""}frame${c}.json`,a.isFromZip=!0,k(e,a).then((async e=>{n.geometries[s/1|0]=e,await t.ConnectGeometry(e);for(var r=[],o=[],c=[],h=[],p=0;p<e.vertices.length;p++)r.push(Math.round(1e3*e.vertices[p])/1e3);for(p=0;p<e.uvs.length;p++)h.push(Math.round(1e3*e.uvs[p])/1e3);for(p=0;p<e.normals.length;p+=3)o.push(Math.round(1e3*e.normals[p+0])/1e3),o.push(Math.round(1e3*e.normals[p+1])/1e3),o.push(Math.round(1e3*e.normals[p+2])/1e3);for(p=0;p<e.normalVecs.length;p++)c.push(Math.round(1e3*e.normalVecs[p])/1e3);var f={vertices:r,uvs:h,normals:o,normalVecs:c},u=new zip.TextReader(JSON.stringify(f)),m=(""+(s+1)).padStart(4,"0");l.add(`frame_${m}.json`,u),s==i-1&&a.downloadShape&&await I(await l.close(),"animation.zip")})))}))}}))}))}))})),n},P=(e,a,t)=>{var r=e.t,o=0,n=0,s=0,i=0,c=0,l=0,h="reverse",p=1;if(void 0!==t&&Object.keys(t).forEach(((e,a)=>{switch(e.toLowerCase()){case"x":o=+t[e];break;case"y":n=+t[e];break;case"z":s=+t[e];break;case"roll":i=+t[e];break;case"pitch":c=+t[e];break;case"yaw":l=+t[e];break;case"loopmode":h=t[e];break;case"animationspeed":p=1/+t[e]|0}})),void 0!==a&&a.loaded&&a.geometries.length){for(var f=1;f--;){if(!p||(60*r|0)%p||(a.curFrame+=a.dir),a.curFrame>=a.geometries.length-("cycle"==h?0:1))if("cycle"===h)a.curFrame=0;else a.dir=-1;if(a.curFrame<("cycle"==h?0:1))if("cycle"===h)a.curFrame=a.geometries.length-1;else a.dir=1}var u=a.geometries[a.curFrame];void 0!==u&&void 0!==u.vertices&&u.vertices.length&&(u.x=o,u.y=n,u.z=s,u.roll=i,u.pitch=c,u.yaw=l,e.Draw(u))}},_=e=>{var a="",t=[],r=[],o=[],n=[];if(e?.vertices){t=e.vertices;for(var s=0,i=[],c=0;c<t.length;c+=3){var l=-Math.round(1e4*t[c+0])/1e4,h=Math.round(1e4*t[c+1])/1e4,p=Math.round(1e4*t[c+2])/1e4;a+=`v ${l} ${h} ${p}\n`,i.push(c/3),3==++s&&(s=0,n.push(i),i=[])}}if(e?.normalVecs){o=e.normalVecs;var f=e.resolved?1:-1;for(c=0;c<o.length;c+=3){var u=Math.round(1e4*o[c+0])/1e4*f,m=-Math.round(1e4*o[c+1])/1e4*f,d=-Math.round(1e4*o[c+2])/1e4*f;a+=`vn ${u} ${m} ${d}\n`}}if(e?.uvs){r=e.uvs;for(c=0;c<r.length;c+=2){var g=Math.round(1e4*r[c+0])/1e4,v=Math.round(1e4*r[c+1])/1e4;a+=`vt ${g} ${v}\n`}}return n.forEach(((e,t)=>{var r=t/1|0;a+=`f ${3*r+1}/${2*r+1}/${3*r+1} ${3*r+2}/${2*r+2}/${3*r+2} ${3*r+3}/${2*r+3}/${3*r+3}\n`})),a},L=e=>{if(e.preComputeNormalAssocs){console.log("downloading custom shape, detected preComputeNormalAssocs");var a=[]}for(var t=[],r=[],o=[],n=[],s=0;s<e.vertices.length;s++)t.push(Math.round(1e3*e.vertices[s])/1e3);if(e.equirectangular){var i,c,l,h,p,f,u;for(s=0;s<e.vertices.length;s+=3){p=e.vertices[s+0],f=e.vertices[s+1],u=e.vertices[s+2],i=Math.hypot(p,f,u)+1e-4,c=Math.atan2(p,u);for(var m=0;m<s%9/3|0;m++){var d=2*n[2*(s/3|0)-(2+2*m)]*Math.PI;Math.abs(d-c)>Math.PI&&(c+=(c<d?1:-1)*Math.PI*2)}l=c/Math.PI/2,h=Math.acos(f/i)/Math.PI,l=Math.round(1e3*l)/1e3,h=Math.round(1e3*h)/1e3,n.push(l,h)}}else for(s=0;s<e.uvs.length;s++)n.push(Math.round(1e3*e.uvs[s])/1e3);for(s=0;s<e.normals.length;s++)r.push(Math.round(1e3*e.normals[s])/1e3);for(s=0;s<e.normalVecs.length;s++)o.push(Math.round(1e3*e.normalVecs[s])/1e3);if(e.preComputeNormalAssocs)for(s=0;s<e.normalAssocs.length;s++)a.push(e.normalAssocs[s]);if(e.preComputeNormalAssocs)var g={vertices:t,uvs:n,normals:r,normalVecs:o,normalAssocs:a};else g={vertices:t,uvs:n,normals:r,normalVecs:o};var v=document.createElement("a");v.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(g)),e.name||e.name,v.download=(e.name?e.name:e.shapeType)+".json",v.click()},I=(e,a="downloaded_file")=>{var t=document.createElement("a");t.href=window.URL.createObjectURL(e),t.download=a,t.click(),window.URL.revokeObjectURL(e)},k=async(a,t)=>{var r,o,n,s,i,c,f,u,m,d,g,x,R,M,E,T,w,P,I,k,F,z,U,C;const S=a.gl;var B,O,D,N=!1,Y=!1,H=!1,q=!1,j=0,W=0,re=0,oe=!1,ne=!1,se=!1,le=0,he=0,pe=0,fe=1,ue=1,me=1,de=1,ge=1,ve=0,ye=0,be=0,xe=0,Re=0,Me=!1,Ae=16,Ee=40,Te="",we="",Pe=1,_e=!1,Le=0,Ie=0,ke=3355443,Fe=.1,ze=!1,Ue=-1,Ce=0,Se=-1,Be=!1,Oe=!1,Ve=!1,De="",Ne=!1,Ye=16777215,He=.25,qe=!1,Xe=1,je=1,We=a,$e=!1,Ge="",Qe=1,Ze=6e6,Ke=!1,Je=-1,ea=!0,aa=8978210,ta=!1,ra=0,oa=0,na=0,sa=0,ia=!1,ca=0,la=1,ha=!0,pa="image",fa=!1,ua=!1,ma=!1,da=512,ga=512,va=S.RGBA,ya=!1,ba=512,xa=512,Ra=S.RGBA,Ma=1,Aa=1,Ea=[],Ta=[],wa={};Object.keys(t).forEach(((e,a)=>{if("showsource"===e.toLowerCase())fa=!!t[e]})),Object.keys(t).forEach(((a,l)=>{switch(a.toLowerCase()){case"x":j=t[a];break;case"y":W=t[a];break;case"z":re=t[a];break;case"roll":le=t[a];break;case"pitch":he=t[a];break;case"yaw":pe=t[a];break;case"shapetype":switch(w=t[a].toLowerCase()){case"sprite":De=`${e}/resources/sprite.png`;break;case"point light":De=fa?`${e}/resources/stars/star.png`:""}break;case"size":Pe=t[a];break;case"subs":Le=t[a];break;case"equirectangular":Ue=!!t[a];break;case"equirectangularheightmap":Se=!!t[a];break;case"flipnormals":Oe=!!t[a];break;case"shownormals":Ve=!!t[a];break;case"offsetx":be=t[a];break;case"offsety":xe=t[a];break;case"offsetz":Re=t[a];break;case"sphereize":Ie=t[a];break;case"rotationmode":Ce=t[a];break;case"rebindtextures":Me=!!t[a];break;case"flipx":oe=t[a];break;case"flipy":ne=t[a];break;case"flipz":se=t[a];break;case"objx":r=t[a];break;case"objy":o=t[a];break;case"objz":n=t[a];break;case"objroll":s=t[a];break;case"objpitch":i=t[a];break;case"objyaw":c=t[a];break;case"scaleuvx":de=t[a];break;case"scaleuvy":ge=t[a];break;case"offsetuvx":ve=t[a];break;case"offsetuvy":ye=t[a];break;case"scalex":fe=t[a];break;case"scaley":ue=t[a];break;case"scalez":me=t[a];break;case"wireframe":ia=!!t[a];break;case"name":we=t[a];break;case"color":ke=t[a];break;case"colormix":Fe=t[a];break;case"mapisdataarray":ma=!!t[a];break;case"dataarraywidth":da=+t[a];break;case"dataarrayheight":ga=+t[a];break;case"dataarrayformat":va=t[a];break;case"heightmapisdataarray":ya=!!t[a];break;case"heightmapdataarraywidth":ba=+t[a];break;case"heightmapdataarrayheight":xa=+t[a];break;case"heightmapdataarrayformat":Ra=t[a];break;case"exportshape":N=!!t[a];break;case"downloadshape":Y=!!t[a];break;case"exportasobj":H=!!t[a];break;case"downloadasobj":q=!!t[a];break;case"penumbra":ca=t[a];break;case"url":Te=t[a];break;case"map":De=t[a];break;case"glow":Ne=!!t[a];break;case"glowcolor":Ye=t[a];break;case"glowalpha":He=t[a];break;case"glowincludeshape":qe=!!t[a];break;case"glowradius":Xe=t[a];break;case"glowresolution":je=t[a];break;case"glowrendertarget":We=t[a];break;case"heightmap":Ge=t[a];break;case"heightmapintensity":Qe=t[a];break;case"maxheightmap":Ze=+t[a];break;case"heightmapiscanvas":Ke=!!t[a];break;case"rows":Ae=t[a];break;case"cols":Ee=t[a];break;case"disabledepthtest":ua=t[a];break;case"canvastexturemix":Je=t[a];break;case"canvastexture":U=t[a],pa="canvas";break;case"involvecache":ha=!!t[a];break;case"muted":ea=!!t[a];break;case"lum":Ma=t[a];break;case"alpha":Aa=t[a];break;case"geometrydata":Ea=t[a];break;case"precomputenormalassocs":Be=!!t[a];break;case"texcoords":Ta=t[a];break;case"boundingcolor":aa=t[a];break;case"showbounding":ta=!!t[a];break;case"issprite":ra=t[a]?1:0;break;case"islight":oa=t[a]?1:0;break;case"isparticle":na=t[a]?1:0;break;case"isline":sa=t[a]?1:0;break;case"playbackspeed":la=t[a];break;case"averagenormals":_e=!!t[a];break;default:wa[a]=t[a]}})),void 0===r&&(r=0),void 0===o&&(o=0),void 0===n&&(n=0),void 0===s&&(s=0),void 0===i&&(i=0),void 0===c&&(c=0),void 0!==t.canvasTexture?(-1==Je&&(Je=1),O=t.canvasTexture,delete t.canvasTexture):Je=0,t.heightMapIsCanvas&&(D=t.heightMap,delete t.heightMap,t?.heightmap&&delete t.heightmap),t=structuredClone(t),void 0!==O&&(t.canvasTexture=O),void 0!==D&&(t.heightMap=D);var Pa,_a,La=[],Ia=[],ka=[],Fa=[],za=[],Ua=!1;if(-1!=w.indexOf("custom shape")||Te&&"lines"==w)Pa=Te,_a=`${w} ${we} (${Te})`;else if(_a=`${w}_${Le}`,Le<5&&_a)switch(_a){case"cylinder_0":case"cylinder_1":case"cylinder_2":case"cylinder_3":case"torus_0":case"torus knot_0":case"tetrahedron_0":case"tetrahedron_1":case"tetrahedron_2":case"tetrahedron_3":case"tetrahedron_4":case"tetrahedron_5":case"octahedron_0":case"octahedron_1":case"octahedron_2":case"octahedron_3":case"octahedron_4":case"octahedron_5":case"cube_0":case"cube_1":case"cube_2":case"cube_3":case"cube_4":case"cube_5":case"dodecahedron_0":case"dodecahedron_1":case"dodecahedron_2":case"dodecahedron_3":case"dodecahedron_4":case"dodecahedron_5":case"icosahedron_0":case"icosahedron_1":case"icosahedron_2":case"icosahedron_3":case"icosahedron_4":case"icosahedron_5":if(Ie<0&&(Ie/=-1!=_a.indexOf("tetrahedron")?3:1,Ie/=-1!=_a.indexOf("octahedron")?2:1,Ie/=-1!=_a.indexOf("cube")?1.5:1),"torus_0"!=_a||16==Ae&&40==Ee||"torus_0"==_a&&16==Ae&&40==Ee||"torus knot_0"==_a&&16==Ae&&40==Ee)if(ze=!0,Pa=`${Te=`${e}/new%20shapes/`}${_a}.json?4`,ha&&(l=h.geometry.filter((e=>e.url==Pa))).length)console.log(`found geometry (${_a}) in cache... using it`),void 0!==(Ca=l[0].data).normalAssocs&&(C=Ca.normalAssocs),ka=new Float32Array(Ca.vertices),Ia=new Float32Array(Ca.normals),za=new Float32Array(Ca.normalVecs),La=new Float32Array(Ca.uvs),Ua=!0,ze=!0;else await fetch(Pa).then((e=>e.json())).then((e=>{void 0!==e.normalAssocs&&(C=e.normalAssocs),ka=e.vertices,Ia=e.normals,za=e.normalVecs.map((e=>-e)),La=e.uvs,h.geometry.push({data:structuredClone(e),url:Pa})})),ze=!0}if(!ze)switch(w){case"custom shape":case"lines":if("lines"==w){if(!Te)break;sa=!0}var Ca;if(void 0===Ea.vertices&&ha&&(l=h.customShapes.filter((e=>e.url==Te))).length)console.log("found custom shape in cache... using it"),void 0!==(Ca=l[0].data).normalAssocs&&(C=Ca.normalAssocs),ka=Ca.vertices,Ia=Ca.normals,za=Ca.normalVecs,La=Ca.uvs,ze=!0,Ua=!0;ze||(void 0!==Ea.vertices&&Ea.vertices.length?(void 0!==Ea.normalAssocs&&(C=Ea.normalAssocs),ka=Ea.vertices,Ia=Ea.normals,za=Ea.normalVecs,La=Ea.uvs,ze=!0):await fetch(Pa).then((e=>e.json())).then((e=>{void 0!==e.normalAssocs&&(C=e.normalAssocs),ka=e.vertices,Ia=e.normals,za=e.normalVecs,La=e.uvs,ze=!0,h.customShapes.push({data:structuredClone(e),url:Te})})))}if(ze)switch(w){case"tetrahedron":case"octahedron":case"dodecahedron":case"icosahedron":-1==Ue&&(Ue=!0),-1==Se&&(Se=!0)}else switch(w){case"tetrahedron":Ie/=Ie<0?3:1,-1==Ue&&(Ue=!0),-1==Se&&(Se=!0),(B=await Z(Pe,Le,Ie,Oe,w)).geometry.map((e=>{ka.push(...e.position),Ia.push(...e.normal),La.push(...e.texCoord)}));break;case"octahedron":Ie/=Ie<0?2:1,-1==Ue&&(Ue=!0),-1==Se&&(Se=!0),(B=await K(Pe,Le,Ie,Oe,w)).geometry.map((e=>{ka.push(...e.position),Ia.push(...e.normal),La.push(...e.texCoord)}));break;case"icosahedron":-1==Ue&&(Ue=!0),-1==Se&&(Se=!0),(B=await J(Pe,Le,Ie,Oe,w)).geometry.map((e=>{ka.push(...e.position),Ia.push(...e.normal),La.push(...e.texCoord)}));break;case"torus":(B=await G(Pe,Le,Ie,Oe,w,Ae,Ee)).geometry.map((e=>{ka.push(...e.position),Ia.push(...e.normal),La.push(...e.texCoord)}));break;case"torus knot":(B=await Q(Pe,Le,Ae,Ee,Ie,Oe,w)).geometry.map((e=>{ka.push(...e.position),Ia.push(...e.normal),La.push(...e.texCoord)}));break;case"cylinder":(B=await $(Pe,Le,Ae,Ee,Ie,Oe,w)).geometry.map((e=>{ka.push(...e.position),Ia.push(...e.normal),La.push(...e.texCoord)}));break;case"dynamic":(B=await X(Ea,Ta,Pe,Le+1,Ie,Oe,!!Ea.filter((e=>4==e.length)).length,w)).geometry.map((e=>{ka.push(...e.position),Oe?Ia.push(...e.normal.map((e=>-1*e))):Ia.push(...e.normal),void 0!==e.texCoord&&e.texCoord.length&&La.push(...e.texCoord)}));break;case"lines":sa=1;for(var Sa=0;Sa<Ea.length;Sa++)for(var Ba=0;Ba<Ea[Sa].length;Ba++)ka.push(Ea[Sa][Ba]*(Ba%3?1:-1));break;case"bspline":sa=1,t.omitShape=!0,await ce(a,t).then((e=>{e.curve.map((e=>{ka.push(...e)}))}));break;case"curveto":sa=1,t.omitShape=!0,await ie(a,t).then((e=>{e.map((e=>{ka.push(...e)}))}));break;case"cube":Ie/=Ie<0?1.5:1,(B=await ae(Pe,Le,Ie,Oe,w)).geometry.map((e=>{ka.push(...e.position),Ia.push(...e.normal),La.push(...e.texCoord)}));break;case"rectangle":(B=await te(Pe,Le,Ie,Oe,w)).geometry.map((e=>{ka.push(...e.position),Ia.push(...e.normal),La.push(...e.texCoord)}));break;case"sprite":ra=!0,(B=await te(Pe,Le,Ie,Oe,w)).geometry.map((e=>{ka.push(...e.position),Ia.push(...e.normal),La.push(...e.texCoord)}));break;case"particles":na=1;for(Sa=0;Sa<Ea.length;Sa++)for(Ba=0;Ba<Ea[Sa].length;Ba++)ka.push(1*Ea[Sa][Ba]);break;case"point light":oa=!0,(B=fa?await te(Math.max(Pe,.5),Le+1,Ie,Oe,w):{geometry:[]}).geometry.map((e=>{ka.push(...e.position),Ia.push(...e.normal),La.push(...e.texCoord)}));break;case"obj":if(Ea.length){var Oa={vertices:[],normals:[],uvs:[]};v(Ea,[],[],[],[],Oa),y(Oa),ka=Oa.vertices,Ia=Oa.normals,La=Oa.uvs,ze=!0}else B=await b(Te,0,0,0,0,0,0,0,!1,!0),ka=B.vertices,Ia=B.normals,La=B.uvs;break;case"dodecahedron":-1==Ue&&(Ue=!0),-1==Se&&(Se=!0),(B=await ee(Pe,Le,Ie,Oe,w)).geometry.map((e=>{ka.push(...e.position),Ia.push(...e.normal),La.push(...e.texCoord)}))}if(0!=ve||0!=ye)for(Sa=0;Sa<La.length;Sa+=2)La[Sa+0]+=ve,La[Sa+1]+=ye;if(1!=de||1!=ge)for(Sa=0;Sa<La.length;Sa+=2)La[Sa+0]*=de,La[Sa+1]*=ge;if("lines"!=w&&"particles"!=w&&!na&&"custom shape"!=w&&"obj"!=w&&"dynamic"!=w||1!=fe||1!=ue||1!=me){var Va=Ie,Da=1-Ie,Na=-6e6;for(Sa=0;Sa<ka.length;Sa+=3){var Ya=ka[Sa+0],Ha=ka[Sa+1],qa=ka[Sa+2];(ja=Math.hypot(Ya,Ha,qa))>Na&&(Na=ja)}var Xa=-6e6;for(Sa=0;Sa<ka.length;Sa+=3){var ja;Ya=ka[Sa+0]/Na,Ha=ka[Sa+1]/Na,qa=ka[Sa+2]/Na;Ya/=ja=Math.hypot(Ya,Ha,qa)+1e-4,Ha/=ja,qa/=ja,Ya*=Va+ja*Da,Ha*=Va+ja*Da,qa*=Va+ja*Da,ka[Sa+0]=Ya,ka[Sa+1]=Ha,ka[Sa+2]=qa,(ja=Math.hypot(Ya,Ha,qa))>Xa&&(Xa=ja)}for(Sa=0;Sa<ka.length;Sa+=3){ka[Sa+0]/=Xa,ka[Sa+1]/=Xa,ka[Sa+2]/=Xa,ka[Sa+0]*=Pe*fe,ka[Sa+1]*=Pe*ue,ka[Sa+2]*=Pe*me;var Wa=Ia[2*Sa+0],$a=Ia[2*Sa+1],Ga=Ia[2*Sa+2];Ia[2*Sa+0]+=ka[Sa+0]-Wa,Ia[2*Sa+1]+=ka[Sa+1]-$a,Ia[2*Sa+2]+=ka[Sa+2]-Ga,Ia[2*Sa+3]+=ka[Sa+0]-Wa,Ia[2*Sa+4]+=ka[Sa+1]-$a,Ia[2*Sa+5]+=ka[Sa+2]-Ga}}if(_e&&V(ka,Ia,w,za,Oe),"dynamic"==w||Be){C=[];for(Sa=0;Sa<ka.length;Sa+=3){for(var Qa=ka[Sa+0],Za=ka[Sa+1],Ka=ka[Sa+2],Ja=[],et=0;et<ka.length;et+=3){var at=ka[et+0],tt=ka[et+1],rt=ka[et+2];Math.hypot(Qa-at,Za-tt,Ka-rt)<.001&&Ja.push(et)}C.push(Ja)}}if(("custom shape"==w||"obj"==w)&&(i||s||c||r||o||n))for(Sa=0;Sa<ka.length;Sa+=3){j=ka[Sa+0],W=ka[Sa+1],re=ka[Sa+2];var ot=A(j,W,re,{roll:s,pitch:i,yaw:c});if(ka[Sa+0]=ot[0]+r,ka[Sa+1]=ot[1]+o,ka[Sa+2]=ot[2]+n,Ia.length){for(Ba=2;Ba--;){j=Ia[2*Sa+0+3*Ba],W=Ia[2*Sa+1+3*Ba],re=Ia[2*Sa+2+3*Ba];ot=A(j,W,re,{roll:s,pitch:i,yaw:c});Ia[2*Sa+0+3*Ba]=ot[0]+r,Ia[2*Sa+1+3*Ba]=ot[1]+o,Ia[2*Sa+2+3*Ba]=ot[2]+n}j=za[Sa+0],W=za[Sa+1],re=za[Sa+2];ot=A(j,W,re,{roll:s,pitch:i,yaw:c});za[Sa+0]=ot[0],za[Sa+1]=ot[1],za[Sa+2]=ot[2]}}if(!(ze||na||sa||_e||Ua&&ze)){za=[];for(Sa=0;Sa<Ia.length;Sa+=6){let e=Ia[Sa+3]-Ia[Sa+0],a=Ia[Sa+4]-Ia[Sa+1],t=Ia[Sa+5]-Ia[Sa+2];za.push(e,a,t)}}if(oe)for(Sa=0;Sa<ka.length;Sa+=3)ka[Sa+1]*=-1;if(ne)for(Sa=0;Sa<ka.length;Sa+=3)ka[Sa+1]*=-1;if(se)for(Sa=0;Sa<ka.length;Sa+=3)ka[Sa+1]*=-1;if(Oe&&!_e){for(Sa=0;Sa<Ia.length;Sa+=6)Ia[Sa+3]=Ia[Sa+0]-(Ia[Sa+3]-Ia[Sa+0]),Ia[Sa+4]=Ia[Sa+1]-(Ia[Sa+4]-Ia[Sa+1]),Ia[Sa+5]=Ia[Sa+2]-(Ia[Sa+5]-Ia[Sa+2]);for(Sa=0;Sa<za.length;Sa+=3)za[Sa+0]*=-1,za[Sa+1]*=-1,za[Sa+2]*=-1}if(N){(it=document.createElement("div")).style.position="fixed",it.style.zIndex=1e5,it.style.left="50%",it.style.top="50%",it.style.transform="translate(-50%, -50%)",it.style.background="#0008",it.style.padding="20px",it.style.width="600px",it.style.height="350px",it.style.border="1px solid #fff4",it.style.borderRadius="5px",it.style.fontFamily="monospace",it.style.fontSize="20px",it.style.color="#fff",(ct=document.createElement("div")).style.fontSize="24px",ct.style.color="#0f8c",ct.innerHTML=`Export Coordinates File -> ${w} `+(t?.name?`(${t.name})`:"")+"<br><br>",it.appendChild(ct),(lt=document.createElement("div")).style.minWidth="100%",lt.style.height="250px",lt.style.background="#333",lt.style.border="1px solid #fff4",lt.style.overflowY="auto",lt.style.wordWrap="break-word",lt.style.color="#888",lt.style.fontSize="10px",it.appendChild(lt),(ht=document.createElement("button")).style.border="none",ht.style.padding="3px",ht.style.cursor="pointer",ht.fontSize="20px",ht.style.borderRadius="10px",ht.style.margin="10px",ht.style.minWidth="100px",ht.innerHTML="📋 copy",ht.title="copy shape data to clipboard",ht.onclick=()=>{var e=document.createRange();e.selectNode(lt),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),ht.innerHTML="COPIED!",setTimeout((()=>{ht.innerHTML="📋 copy"}),1e3)},it.appendChild(ht),(pt=document.createElement("button")).onclick=()=>it.remove(),pt.style.border="none",pt.style.padding="3px",pt.style.cursor="pointer",pt.fontSize="20px",pt.style.borderRadius="10px",pt.style.margin="10px",pt.style.background="#faa",pt.style.minWidth="100px",pt.innerHTML="close",it.appendChild(pt);var nt={vertices:[],normals:[],normalVecs:[],uvs:[]};ka.map((e=>nt.vertices.push(Math.round(1e3*e)/1e3))),wa.preComputeNormalAssocs&&(nt.normalAssocs=[],wa.normalAssocs.map((e=>nt.vertices.push(e))));for(Sa=0;Sa<Ia.length;Sa+=6){Qa=Ia[Sa+0],Za=Ia[Sa+1],Ka=Ia[Sa+2],at=Oe?Ia[Sa+0]-(Ia[Sa+3]-Ia[Sa+0]):Ia[Sa+3],tt=Oe?Ia[Sa+1]-(Ia[Sa+4]-Ia[Sa+1]):Ia[Sa+4],rt=Oe?Ia[Sa+2]-(Ia[Sa+5]-Ia[Sa+2]):Ia[Sa+5];Qa=Math.round(1e3*Qa)/1e3,Za=Math.round(1e3*Za)/1e3,Ka=Math.round(1e3*Ka)/1e3,at=Math.round(1e3*at)/1e3,tt=Math.round(1e3*tt)/1e3,rt=Math.round(1e3*rt)/1e3,nt.normals.push(Qa,Za,Ka,at,tt,rt)}for(Sa=0;Sa<za.length;Sa++)nt.normalVecs.push((Oe?11:1)*Math.round(1e3*za[Sa])/1e3);if(wa.equirectangular)for(Sa=0;Sa<wa.vertices.length;Sa+=3){hvx=wa.vertices[Sa+0],hvy=wa.vertices[Sa+1],hvz=wa.vertices[Sa+2],ja=Math.hypot(hvx,hvy,hvz)+1e-4,p=Math.atan2(hvx,hvz);for(Ba=0;Ba<Sa%9/3|0;Ba++){var st=2*La[2*(Sa/3|0)-(2+2*Ba)]*Math.PI;Math.abs(st-p)>Math.PI&&(p+=(p<st?1:-1)*Math.PI*2)}p1=p/Math.PI/2,p2=Math.acos(hvy/ja)/Math.PI,p1=Math.round(1e3*p1)/1e3,p2=Math.round(1e3*p2)/1e3,La.push(p1,p2)}else La.map((e=>nt.uvs.push(Math.round(1e3*e)/1e3)));lt.innerHTML=JSON.stringify(nt),document.body.appendChild(it)}if(H){var it,ct,lt,ht,pt;(it=document.createElement("div")).style.position="fixed",it.style.zIndex=1e5,it.style.left="50%",it.style.top="50%",it.style.transform="translate(-50%, -50%)",it.style.background="#0008",it.style.padding="20px",it.style.width="600px",it.style.height="350px",it.style.border="1px solid #fff4",it.style.borderRadius="5px",it.style.fontFamily="monospace",it.style.fontSize="20px",it.style.color="#fff",(ct=document.createElement("div")).style.fontSize="24px",ct.style.color="#0f8c",ct.innerHTML=`Export OBJ File -> ${w} `+(t?.name?`(${t.name})`:"")+"<br><br>",it.appendChild(ct),(lt=document.createElement("div")).style.minWidth="100%",lt.style.height="250px",lt.style.background="#333",lt.style.border="1px solid #fff4",lt.style.overflowY="auto",lt.style.wordWrap="break-word",lt.style.color="#888",lt.style.fontSize="10px",it.appendChild(lt),(ht=document.createElement("button")).style.border="none",ht.style.padding="3px",ht.style.cursor="pointer",ht.fontSize="20px",ht.style.borderRadius="10px",ht.style.margin="10px",ht.style.minWidth="100px",ht.innerHTML="📋 copy",ht.title="copy shape data to clipboard",ht.onclick=()=>{var e=document.createRange();e.selectNode(lt),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),ht.innerHTML="COPIED!",setTimeout((()=>{ht.innerHTML="📋 copy"}),1e3)},it.appendChild(ht),(pt=document.createElement("button")).onclick=()=>it.remove(),pt.style.border="none",pt.style.padding="3px",pt.style.cursor="pointer",pt.fontSize="20px",pt.style.borderRadius="10px",pt.style.margin="10px",pt.style.background="#faa",pt.style.minWidth="100px",pt.innerHTML="close",it.appendChild(pt);var ft=_({vertices:ka,normalVecs:za,uvs:La,shapeType:w,averageNormals:_e});ft=ft.replaceAll("\n","<br>"),lt.innerHTML=ft,document.body.appendChild(it)}if(Ua||(ka=new Float32Array(ka),Ia=new Float32Array(Ia),za=new Float32Array(za),La=new Float32Array(La)),f=S.createBuffer(),S.bindBuffer(S.ARRAY_BUFFER,f),S.bufferData(S.ARRAY_BUFFER,ka,S.STATIC_DRAW),S.bindBuffer(S.ARRAY_BUFFER,null),P=new Uint32Array(Array(ka.length/3).fill().map(((e,a)=>a))),u=S.createBuffer(),S.bindBuffer(S.ELEMENT_ARRAY_BUFFER,u),S.bufferData(S.ELEMENT_ARRAY_BUFFER,P,S.STATIC_DRAW),S.bindBuffer(S.ELEMENT_ARRAY_BUFFER,null),be||xe||Re){for(Ja=[],Sa=0;Sa<ka.length;Sa+=3)Ja.push(be,xe,Re);Fa=new Float32Array(Ja)}else Fa=new Float32Array(Array(ka.length).fill(0));m=S.createBuffer(),S.bindBuffer(S.ARRAY_BUFFER,m),S.bufferData(S.ARRAY_BUFFER,Fa,S.STATIC_DRAW),S.bindBuffer(S.ARRAY_BUFFER,null),z=new Uint32Array(Array(Fa.length/3).fill().map(((e,a)=>a))),d=S.createBuffer(),S.bindBuffer(S.ELEMENT_ARRAY_BUFFER,d),S.bufferData(S.ELEMENT_ARRAY_BUFFER,z,S.STATIC_DRAW),S.bindBuffer(S.ELEMENT_ARRAY_BUFFER,null),R=S.createBuffer(),S.bindBuffer(S.ARRAY_BUFFER,R),S.bufferData(S.ARRAY_BUFFER,za,S.STATIC_DRAW),S.bindBuffer(S.ARRAY_BUFFER,null),k=new Uint32Array(Array(za.length/3).fill().map(((e,a)=>a))),M=S.createBuffer(),S.bindBuffer(S.ELEMENT_ARRAY_BUFFER,M),S.bufferData(S.ELEMENT_ARRAY_BUFFER,k,S.STATIC_DRAW),S.bindBuffer(S.ELEMENT_ARRAY_BUFFER,null),g=S.createBuffer(),S.bindBuffer(S.ARRAY_BUFFER,g),S.bufferData(S.ARRAY_BUFFER,Ia,S.STATIC_DRAW),S.bindBuffer(S.ARRAY_BUFFER,null),I=new Uint32Array(Array(Ia.length/3).fill().map(((e,a)=>a))),x=S.createBuffer(),S.bindBuffer(S.ELEMENT_ARRAY_BUFFER,x),S.bufferData(S.ELEMENT_ARRAY_BUFFER,I,S.STATIC_DRAW),S.bindBuffer(S.ELEMENT_ARRAY_BUFFER,null),E=S.createBuffer(),S.bindBuffer(S.ARRAY_BUFFER,E),S.bufferData(S.ARRAY_BUFFER,La,S.STATIC_DRAW),S.bindBuffer(S.ARRAY_BUFFER,null),F=new Uint32Array(Array(La.length/2).fill().map(((e,a)=>a))),T=S.createBuffer(),S.bindBuffer(S.ELEMENT_ARRAY_BUFFER,T),S.bufferData(S.ELEMENT_ARRAY_BUFFER,F,S.STATIC_DRAW),S.bindBuffer(S.ELEMENT_ARRAY_BUFFER,null),-1==Ue&&(Ue=!1),-1==Se&&(Se=!1);var ut={x:j,y:W,z:re,rows:Ae,cols:Ee,roll:le,pitch:he,yaw:pe,color:ke,colorMix:Fe,size:Pe,subs:Le,name:we,url:Te,averageNormals:_e,showNormals:Ve,exportShape:N,downloadShape:Y,shapeType:na?"particles":sa?"lines":w,normalAssocs:C,sphereize:Ie,equirectangular:Ue,flipNormals:Oe,vertices:ka,normals:Ia,normalVecs:za,uvs:La,offsets:Fa,offset_buffer:m,Offset_Index_Buffer:d,vertex_buffer:f,Vertex_Index_Buffer:u,normal_buffer:g,Normal_Index_Buffer:x,muted:ea,normalVec_buffer:R,NormalVec_Index_Buffer:M,nVecIndices:k,uv_buffer:E,UV_Index_Buffer:T,oIndices:z,vIndices:P,nIndices:I,uvIndices:F,map:De,video:undefined,textureMode:pa,isSprite:ra,isLight:oa,playbackSpeed:la,disableDepthTest:ua,lum:Ma,alpha:Aa,involveCache:ha,renderer:a,isParticle:na,isLine:sa,penumbra:ca,wireframe:ia,canvasTexture:U,canvasTextureMix:Je,showBounding:ta,boundingColor:aa,heightMap:Ge,heightMapIntensity:Qe,glow:Ne,glowColor:Ye,glowAlpha:He,glowIncludeShape:qe,glowRadius:Xe,glowResolution:je,glowRenderTarget:We,heightMapIsCanvas:Ke,equirectangularHeightmap:Se,flipX:oe,flipY:ne,flipZ:se,isFromZip:$e,rotationMode:Ce,mapIsDataArray:ma,dataArrayFormat:va,maxHeightmap:Ze,dataArrayWidth:da,dataArrayHeight:ga,preComputeNormalAssocs:Be,heightmapIsDataArray:ya,heightmapDataArrayFormat:Ra,heightmapDataArrayWidth:ba,heightmapDataArrayHeight:xa,rebindTextures:Me,exportAsOBJ:H,downloadAsOBJ:q,resolved:ze,isShapeArray:!1};return Object.keys(ut).forEach(((e,a)=>{wa[e]=ut[e]})),"particles"==wa.shapeType||na||"lines"==wa.shapeType||sa?await a.alphaShader.ConnectGeometry(wa):("point light"!=w&&"sprite"!=w||(void 0===t.color&&(wa.color=11184810),"point light"==w&&(wa.pointLightID=a.pointLights.length,a.pointLights.push(wa))),await a.nullShader.ConnectGeometry(wa)),wa.downloadShape&&L(wa),wa.downloadAsOBJ&&(e=>{console.log(`downloading '${e.name?e.name:e.shapeType}' as OBJ file`);var a=document.createElement("a");a.href="data:text/plain;charset=utf-8,"+encodeURIComponent(_(e)),a.download=(e.name?e.name:e.shapeType)+".obj",a.click()})(wa),wa},F=async(e="",a=!1,t=(()=>{}),r=400,o=300)=>{var n=document.createElement("div");n.className="genericPopup",n.style.position="fixed",n.style.zIndex=1e5,n.style.left="50%",n.style.top="50%",n.style.transform="translate(-50%, -50%)",n.style.background="#0008",n.style.padding="20px",n.style.width=`${r}px`,n.style.height=`${o}px`,n.style.border="1px solid #fff4",n.style.borderRadius="5px",n.style.fontFamily="monospace",n.style.fontSize="20px",n.style.color="#fff";var s=document.createElement("div");if(s.style.fontSize="24px",s.style.color="#0f8c",s.innerHTML=e,n.appendChild(s),a){var i=document.createElement("button");i.onclick=()=>{t(),n.remove()},i.style.border="none",i.style.padding="3px",i.style.cursor="pointer",i.fontSize="20px",i.style.borderRadius="10px",i.style.margin="10px",i.style.background="#faa",i.style.minWidth="100px",i.innerHTML="SURE!",n.appendChild(i)}var c=document.createElement("button");c.onclick=()=>n.remove(),c.style.border="none",c.style.padding="3px",c.style.cursor="pointer",c.fontSize="20px",c.style.borderRadius="10px",c.style.margin="10px",c.style.background="#faa",c.style.minWidth="100px",c.innerHTML="close",n.appendChild(c),document.body.appendChild(n)},z=e=>{let a=e;if(!ne(e.width)||!ne(e.height)){let t,r,o=document.createElement("canvas"),n=o.getContext("2d",{imageSmoothingEnabled:!0}),s=8,i=0,c=6e6,l=Math.hypot(e.width,e.height);for(let e=0;e<16;e++)(t=Math.abs(i-l))<c&&(c=t,i=s*2**e,r=e);i-=s*2**(r-1),o.width=i,o.height=i,n.drawImage(e,0,0,o.width,o.height),a=new Image,a=o}return a},U=(e,a,t,r="image",o=-1,n={},s=!0)=>{let p;switch(r){case"canvas":case"heightImage":p=a;break;case"dataArray":p=n.map,e.pixelStorei(e.UNPACK_ALIGNMENT,4);break;case"heightmapDataArray":p=n.heightMap,e.pixelStorei(e.UNPACK_ALIGNMENT,4);break;case"video":s&&(l=h.texImages.filter((e=>e.url==n.map&&-1!=o&&e.tVal==o))).length?(console.log("found video texture in cache... using it"),p=l[0].texImage):(p=(e=>{if(void 0!==e){let a,t;if(i.width!=e.videoWidth||i.height!=e.videoHeight?(a=e.videoWidth,t=e.videoHeight):(a=i.width,t=i.height),!ne(a)||!ne(t)){let e,r,o=8,n=0,s=6e6,i=Math.hypot(a,t);for(let a=0;a<12;a++)(e=Math.abs(n-i))<s&&(s=e,n=o*2**a,r=a);n-=o*2**(r-1),n=Math.min(512,n),a=n/1,t=n/1}i.width==a&&i.width==t||(i.width=a,i.height=t),c.drawImage(e,0,0,a,t)}else i.width=1,i.height=1;return i})(a),-1==o&&h.texImages.push({url:n.map,tval:o,texImage:p}));break;case"image":s&&(l=h.texImages.filter((e=>e.url==n.map))).length?(console.log("found image texture in cache... using it"),p=l[0].texImage):(p=z(a),-1==o&&h.texImages.push({url:n.map,tval:o,texImage:p}))}e.bindTexture(e.TEXTURE_2D,t),"dataArray"==r?void 0!==n.dataArrayFormat&&e.texImage2D(e.TEXTURE_2D,0,n.dataArrayFormat,n.dataArrayWidth,n.dataArrayHeight,0,n.dataArrayFormat,e.UNSIGNED_BYTE,new Uint8Array(p)):"heightmapDataArray"==r?void 0!==n.heightmapDataArrayFormat&&e.texImage2D(e.TEXTURE_2D,0,n.heightmapDataArrayFormat,n.heightmapDataArrayWidth,n.heightmapDataArrayHeight,0,n.heightmapDataArrayFormat,e.UNSIGNED_BYTE,new Uint8Array(p)):void 0!==p&&p.width&&p.height&&e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,p),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),n.flatShading&&e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST)},C=e=>{var a=e.vertices;e.preComputeNormalAssocs=!0,e.normalAssocs=[];for(var t=0;t<a.length;t+=3){for(var r=a[t+0],o=a[t+1],n=a[t+2],s=[],i=0;i<a.length;i+=3){var c=a[i+0],l=a[i+1],h=a[i+2];Math.hypot(r-c,o-l,n-h)<.001&&s.push(i)}e.normalAssocs.push(s)}},S=(e,a=!1,t=!1,r=!0,o=0,n=0,s=0)=>{var i,c,l,h,p,f,u,m,d,g,v=[];void 0!==e.normals&&e.normals.length==2*e.vertices.length||(e.normals=Array(2*e.vertices.length).fill(0)),void 0!==e.normalVecs&&e.normalVecs.length==e.vertices.length||(e.normalVecs=Array(e.vertices.length).fill(0)),void 0!==e.uvs&&e.uvs.length==e.vertices.length/3*2||(e.uvs=Array(e.vertices.length/3*2).fill(0));for(var y=0;y<e.vertices.length;y+=9)i=e.vertices[y+0],c=e.vertices[y+1],l=e.vertices[y+2],h=e.vertices[y+3],p=e.vertices[y+4],f=e.vertices[y+5],u=e.vertices[y+6],m=e.vertices[y+7],d=e.vertices[y+8],g=ue([[i,c,l],[h,p,f],[u,m,d]],r,o,n,s),v.push(g);var b=t?1:-1;if(v.map(((a,t)=>{for(var r=0;r<3;r++)e.normals[18*t+6*r+0]=e.vertices[9*t+3*r+0],e.normals[18*t+6*r+1]=e.vertices[9*t+3*r+1],e.normals[18*t+6*r+2]=e.vertices[9*t+3*r+2],e.normals[18*t+6*r+3]=e.vertices[9*t+3*r+0]+(a[3]-a[0])*b,e.normals[18*t+6*r+4]=e.vertices[9*t+3*r+1]+(a[4]-a[1])*b,e.normals[18*t+6*r+5]=e.vertices[9*t+3*r+2]+(a[5]-a[2])*b,e.normalVecs[9*t+3*r+0]=e.normals[18*t+6*r+3]-e.normals[18*t+6*r+0],e.normalVecs[9*t+3*r+1]=e.normals[18*t+6*r+4]-e.normals[18*t+6*r+1],e.normalVecs[9*t+3*r+2]=e.normals[18*t+6*r+5]-e.normals[18*t+6*r+2]})),a){(void 0===e.normalAssocs||e.normalAssocs.length!=e.vertices.length/3|0)&&(console.log("generating normal assocs"),C(e));var x=structuredClone(e.normalVecs);for(y=0;y<e.normalVecs.length;y+=3){var R=y/3,M=[0,0,0];e.normalAssocs[R].forEach((e=>{0;for(var a=0;a<3;a++)M[a]+=x[e+a]}));for(var A=0;A<3;A++)e.normalVecs[y+A]=M[A]/=3,e.normals[2*y+A]=e.vertices[y+A],e.normals[2*y+A+3]=e.vertices[y+A]+M[A]}}},B=(e,a,t,n,s,i=0,c=0,l=0,h=0,p=0,f=!1,u=!0,m=0)=>{var d,g,v,y;if(a*=-1,n.heightMap&&Ce.length){var b;if(n.equirectangularHeightmap){var x,R=e,A=a,w=t,P=Math.hypot(R,A,w);b=[B=(x=Math.atan2(R,w))/Math.PI/2,V=Math.acos(A/(Math.hypot(R,A,w)+1e-5))/Math.PI]}else b=[h,p];var _=4*((Se.width*b[0]|0)+(Se.height*Se.width*b[1]|0)),L=Ce[_+0]/256,I=Ce[_+1]/256,k=Ce[_+2]/256,F=Math.min(n.maxHeightmap,(L+I+k)/3*n.heightMapIntensity/2);e+=i*F,a+=c*F,t+=l*F}e=-(y=T(e,a*=-1,t,{roll:-n.roll*(n.isParticle?-1:1)+1e-4,pitch:n.pitch*(n.isParticle,1),yaw:-n.yaw*(n.isParticle?-1:1)},!1))[0],a=y[1],t=y[2]*(n.isParticle?-1:1),n.isLight&&(e=(y=E(e,a,t,{roll:s.roll,pitch:s.pitch,yaw:-s.yaw},!1))[0],a=y[1],t=y[2]);var z=s.x,U=s.y,C=s.z;e+=-n.x,a+=n.y,t+=-n.z*(n.isParticle?-1:1),"fps"==s.cameraMode.toLowerCase()?(e=-(y=M(e+=-z,a+=U,t+=-C,{roll:s.roll,pitch:-s.pitch,yaw:s.yaw},!1))[0],a=-y[1],t=-y[2],z=0,U=0,C=0):(e=-(y=T(e,a,t,{roll:-s.roll*(n.isParticle?-1:1),pitch:s.pitch*(n.isParticle?-1:1),yaw:s.yaw*(n.isParticle,1)},!1))[0]*(n.isParticle?-1:1),a=-y[1]*(n.isParticle,1),t=-y[2]*(n.isParticle?-1:1));var S=!1;if(f){d=e+z,g=a-U,v=t+C;var B,O;P=Math.hypot(d,g,v);u?B=Math.atan2(d,v)/Math.PI:0==m?(x=Math.atan2(d,v)+Math.PI/2,O=Math.hypot(d,v),d=r(x)*O,v=o(x)*O,S=(B=(Math.atan2(d,v)/Math.PI+2)%2-1)<=-1,B+=.5):(x=Math.atan2(d,v)-Math.PI/2,O=Math.hypot(d,v),d=r(x)*O,v=o(x)*O,S=(B=(Math.atan2(d,v)/Math.PI+2)%2-1)>=1,B-=.5);var V=-(Math.acos(g/(P+1e-4))/Math.PI*2-1);return!S&&[s.width/2+B*s.width/2,s.height/2+V*s.height/2,P]}e+=z,a-=U,t-=C;var D=s.fov;return(v=t+(C/1e3*D+C))>0&&[d=s.width/2+e/v*D/2,g=s.height/2+a/v*D/2,v]},O=(e,a,t=!0,n=-1,s=!0,i=0,c=10)=>{if(-1==n&&(n=a.equirectangularPlugin),e.isLight)return[];var l,h,p,f,u,m,d=[],g=[];const v=(e,a,n=-1,s=9)=>{n!=a&&(n=a,d.push(a),P=e[a][0],_=e[a][1],f=u=-9,e.map(((t,n)=>{if(n!=a)for(var i=4;i--;)L=e[n][0]+.001*r(m=2*Math.PI/4*i+Math.PI/4),I=e[n][1]+.001*o(m),(b=Math.atan2(I-_,P-L))>f&&b<s&&(f=b,u=n)})),-9!=u&&(t&&g.push(e[u]),v(e,u,n,f)))};var y,b,x,R,M,A,E,T,w,P,_,L,I,k,F,z=[],U=-1,C=1e6,S=e.shader.datasets[e.datasetIdx];e.heightMap&&("video"==e.heightTextureMode?(Se.width=S.heightResource.videoWidth/2,Se.height=S.heightResource.videoHeight/2):(Se.width=S.heightResource.width/2,Se.height=S.heightResource.height/2),Be.drawImage(S.heightResource,0,0,Se.width,Se.height),Ce=Se.width?Be.getImageData(0,0,Se.width,Se.height).data:[]);for(var O=0;O<e.vertices.length;O+=3){!e.isLine&&(e.isLine||!e.isParticle&&(O/3|0)%3)||(x=R=0,y=[]),l=e.vertices[O+0],h=e.vertices[O+1],p=e.vertices[O+2],M=O+0<e.normalVecs.length?e.normalVecs[O+0]:0,A=O+1<e.normalVecs.length?e.normalVecs[O+1]:0,E=O+2<e.normalVecs.length?e.normalVecs[O+2]:0;var V=2*(O/3|0);T=V+0<e.uvs.length?e.uvs[V+0]:0,w=V+1<e.uvs.length?e.uvs[V+1]:0;var D=B(l,h,p,e,a,M,A,E,T,w,n,s,i);D&&(y.push([D[0],D[1]]),x+=D[0],R+=D[1],x/=3,R/=3,Math.hypot(x-U,R-C)>3&&(U=x,C=R,z.push(y)))}e.isParticle||e.isLine?(y=[],z.map(((e,a)=>{P=e[0][0],_=e[0][1],y.filter((e=>e[0]==P&&e[1]==_)).length||y.push([P,_])}))):(y=[],z.map(((e,a)=>{e.length>2&&(P=e[0][0],_=e[0][1],L=e[1][0],I=e[1][1],k=e[2][0],F=e[2][1],y.filter((e=>e[0]==P&&e[1]==_)).length||y.push([P,_]),y.filter((e=>e[0]==L&&e[1]==I)).length||y.push([L,I]),y.filter((e=>e[0]==k&&e[1]==F)).length||y.push([k,F]))})));var N,Y=6e6,H=-1;if(y.map(((e,a)=>{e[1]<=Y&&(H=a,Y=e[1])})),y.length&&(v(y,H),t)){var q=_e(e.boundingColor);Ue.ctx.strokeStyle=`rgba(${256*q[0]},${256*q[1]},${256*q[2]},.5)`,Ue.ctx.globalAlpha=1,Ue.ctx.beginPath(),g.map(((e,a)=>{Ue.ctx.lineWidth=c;var t=g[a][0],r=g[a][1],o=g[N=(a+1)%g.length][0],n=g[N][1];s?Ue.ctx.lineTo(o,n):0==i?t>=Ue.width/2-Ue.width/8&&t<Ue.width+Ue.width/8&&o>=Ue.width/2-Ue.width/8&&o<Ue.width+Ue.width/8&&(Ue.ctx.moveTo(t,r),Ue.ctx.lineTo(o,n)):t<=Ue.width/2+Ue.width/8&&t>-Ue.width/8&&o<=Ue.width/2+Ue.width/8&&o>-Ue.width/8&&(Ue.ctx.moveTo(t,r),Ue.ctx.lineTo(o,n))})),Ue.ctx.closePath(),Ue.ctx.stroke()}return d.map((e=>[y[e][0],y[e][1]]))},V=(e,a,t,r,o)=>{for(var n,s=[],i=q(t),c=o?-1:1,l=0;l<e.length;l+=3)l%9||(n=ue([[e[l+0],e[l+1],e[l+2]],[e[l+3],e[l+4],e[l+5]],[e[l+6],e[l+7],e[l+8]]],i)),s[2*l+0]=e[l+0],s[2*l+1]=e[l+1],s[2*l+2]=e[l+2],s[2*l+3]=e[l+0]-(n[3]-n[0])*c,s[2*l+4]=e[l+1]-(n[4]-n[1])*c,s[2*l+5]=e[l+2]-(n[5]-n[2])*c;var h,p,f,u,m,d,g,v,y,b,x,R,M,A=structuredClone(s);for(l=0;l<s.length;l+=6){m=s[l+0],d=s[l+1],g=s[l+2],p=s[l+3],f=s[l+4],u=s[l+5],h=1;for(var E=0;E<s.length;E+=6)E!=l&&(v=s[E+0],y=s[E+1],b=s[E+2],x=s[E+3],R=s[E+4],M=s[E+5],Math.hypot(m-v,d-y,g-b)<.01&&(p+=x,f+=R,u+=M,h++));A[l+3]=p/=h,A[l+4]=f/=h,A[l+5]=u/=h}A.map(((e,a)=>s[a]=e));var T="cylinder"==t||"torus"==t||"torus knot"==t?-1:1;for(l=0;l<s.length;l+=6)for(var w=3;w--;)a[l+2*w]=s[l+2*w],a[l+2*w+1]=s[l+2*w]-(s[l+2*w]+s[l+2*w+1])*c,r[l/2+w]=(s[l+3+w]-s[l+w])*c*T},D=async(e,a=[])=>{const t=e.gl;var r={iURL:null,locT:null,locUv:null,locFov:null,program:null,heightMapURL:null,optionalUniforms:[],optionalLighting:[]};await a.map((a=>{Object.keys(a).forEach(((t,o)=>{switch(t.toLowerCase()){case"lighting":if("ambientlight"===a[t].type.toLowerCase())if(void 0===a[t]?.enabled||a[t].enabled){var n={name:a[t].type,value:void 0===a[t].value?e.ambientLight:a[t].value};r.optionalLighting.push(n)}break;case"uniform":switch(a[t].type.toLowerCase()){case"custom":if(void 0===a[t]?.enabled||a[t].enabled){var s={name:a[t].type,playbackSpeed:void 0===a[t].playbackSpeed?1:a[t].playbackSpeed,uniformName:void 0===a[t].name?"":a[t].name,involveCache:void 0===a[t].involveCache||a[t].involveCache,muted:void 0===a[t].muted||a[t].muted,map:a[t].map,loc:"",value:void 0===a[t].value?0:a[t].value,flatShading:void 0!==a[t].flatShading&&a[t].flatShading,flipReflections:void 0===a[t].flipReflections?0:a[t].flipReflections,flipRefractions:void 0===a[t].flipRefractions?0:a[t].flipRefractions,dataType:void 0===a[t].dataType?"uniform1f":a[t].dataType,vertDeclaration:void 0===a[t].vertDeclaration?"":a[t].vertDeclaration,vertCode:void 0===a[t].vertCode?"":a[t].vertCode,fragDeclaration:void 0===a[t].fragDeclaration?"":a[t].fragDeclaration,fragCode:void 0===a[t].fragCode?"":a[t].fragCode};r.optionalUniforms.push(s)}break;case"fog":if(void 0===a[t]?.enabled||a[t].enabled){s={name:a[t].type,loc:"",value:void 0===a[t].value?.5:a[t].value,color:void 0===a[t].color?8947848:a[t].color,dataType:"uniform1f",vertDeclaration:"",vertCode:"",fragDeclaration:"",fragCode:""};e.clearColor=s.color,e.hasFog=!0,r.optionalUniforms.push(s)}break;case"reflection":if(void 0===a[t]?.enabled||a[t].enabled){s={name:a[t].type,playbackSpeed:void 0===a[t].playbackSpeed?1:a[t].playbackSpeed,involveCache:void 0===a[t].involveCache||a[t].involveCache,muted:void 0===a[t].muted||a[t].muted,map:a[t].map,loc:"",value:void 0===a[t].value?.5:a[t].value,flatShading:void 0!==a[t].flatShading&&a[t].flatShading,flipReflections:void 0===a[t].flipReflections?0:a[t].flipReflections,theta:void 0===a[t].theta?0:a[t].theta,flatShadingUniform:"refFlatShading",dataType:"uniform1f",vertDeclaration:"\n                  ",vertCode:" \n                  ",fragDeclaration:"\n                    uniform float reflection;\n                    uniform float refFlatShading;\n                    uniform float refTheta;\n                    uniform float refOmitEquirectangular;\n                    uniform float refFlipRefs;\n                    uniform sampler2D reflectionMap;\n                  ",fragCode:"\n                    //light.rgb *= .5;\n                    //light.rgb += .05;\n                    float refP1, refP2;\n                    if(refOmitEquirectangular != 1.0){\n                      vec3 reflectionPos = R_rpy(nV, vec3(0.0,\n                                                      camOri.y, -camOri.z));\n                      float px = reflectionPos.x;\n                      float py = reflectionPos.y;\n                      float pz = reflectionPos.z;\n                      refP1 = -atan(px, pz) / M_PI / 4.0;\n                      refP2 = acos( py / (.001 + sqrt(px * px + py * py + pz * pz))) / M_PI;\n                      if(refFlipRefs == 1.0) refP2 = 1.0 - refP2;\n                    } else {\n                      refP1 = vUv.x;\n                      refP2 = vUv.y;\n                    }\n                    \n                    vec2 refCoords = vec2(1.0 - refP1 * 2.0 + refTheta, refP2);\n                    vec4 refCol = vec4(texture2D(reflectionMap, refCoords).rgb * 1.25, reflection / 1.0);\n                    mixColor = merge(mixColor, refCol);\n                    baseColorIp = 1.0 - reflection; //min(1.0, 2.0 - reflection);\n                    //light += reflection / 4.0;\n                  "};r.optionalUniforms.push(s)}break;case"refraction":if(void 0===a[t]?.enabled||a[t].enabled){s={name:a[t].type,playbackSpeed:void 0===a[t].playbackSpeed?1:a[t].playbackSpeed,involveCache:void 0===a[t].involveCache||a[t].involveCache,angleOfRefraction:void 0===a[t].angleOfRefraction?1:a[t].angleOfRefraction,muted:void 0===a[t].muted||a[t].muted,map:a[t].map,loc:"",value:void 0===a[t].value?.5:a[t].value,flatShading:void 0!==a[t].flatShading&&a[t].flatShading,flipRefractions:void 0===a[t].flipRefractions?0:a[t].flipRefractions,flatShadingUniform:"refractionFlatShading",dataType:"uniform1f",vertDeclaration:"\n                    attribute vec3 nVecRefraction;\n                    varying vec3 nVrefraction;\n                  ",vertCode:"\n                    vec3 nVrefraction = nVecRefraction;\n                  ",fragDeclaration:"\n                    uniform float refraction;\n                    uniform float refractionFlatShading;\n                    uniform float refractionOmitEquirectangular;\n                    uniform float refractionFlipRefs;\n                    uniform float angleOfRefraction;\n                    uniform sampler2D refractionMap;\n                    varying vec3 nVrefraction;\n                  ",fragCode:"\n                    float refractionP1, refractionP2;\n                    float refractionP1a, refractionP2a;\n                    float refractionP1b, refractionP2b;\n                    if(refractionOmitEquirectangular != 1.0){\n\n                      vec3 refractionPos = R_rpy(nV, vec3(0.0,-camOri.y, -camOri.z));\n\n                      float px = refractionPos.x;\n                      float py = refractionPos.y;\n                      float pz = refractionPos.z;\n                      refractionP1a = -atan(px, pz) / M_PI / 4.0;\n                      refractionP2a = acos( py / (.001 + sqrt(px * px + py * py + pz * pz))) / M_PI;\n                      if(refractionFlipRefs == 1.0) refractionP2a = 1.0 - refractionP2a;\n\n                      refractionPos = R_rpy(nVrefraction, vec3(0.0,-camOri.y, -camOri.z));\n                      px = refractionPos.x;\n                      py = refractionPos.y;\n                      pz = refractionPos.z;\n                      refractionP1b = -atan(px, pz) / M_PI / 4.0;\n                      refractionP2b = acos( py / (.001 + sqrt(px * px + py * py + pz * pz))) / M_PI;\n                      if(refractionFlipRefs == 1.0) refractionP2b = 1.0 - refractionP2b;\n\n                      //refractionP1a *= 0.0; //angleOfRefraction;\n                      //refractionP2a *= 1.0; //angleOfRefraction;\n                      //refractionP1 = (refractionP1a + refractionP1b) / 2.0;\n                      //refractionP2 = (refractionP2a + refractionP2b) / 2.0;\n\n                      refractionP1 = refractionP1b;\n                      refractionP2 = refractionP2b;\n\n                    } else {\n                      refractionP1a = vUv.x;\n                      refractionP2a = vUv.y;\n                    }\n                    \n                    vec2 refractionCoords = vec2(1.0 - refractionP1 * 2.0, refractionP2);\n                    vec4 refractionCol = vec4(texture2D(refractionMap, vec2(refractionCoords.x, refractionCoords.y)).rgb * 1.25, refraction / 1.0);\n                    mixColor2 = merge(mixColor2, refractionCol);\n                    baseColorIp2 = 1.0 - refraction;\n                    //light += refraction / 4.0;\n                  "};r.optionalUniforms.push(s)}break;case"phong":if(void 0===a[t]?.enabled||a[t].enabled){s={name:a[t].type,loc:"",value:void 0===a[t].value?.3:a[t].value,flatShading:void 0!==a[t].flatShading&&a[t].flatShading,flatShadingUniform:"phongFlatShading",theta:void 0===a[t].theta?.5:a[t].theta,dataType:"uniform1f",vertDeclaration:"\n                  ",vertCode:"\n                    hasPhong = 1.0;\n                  ",fragDeclaration:"\n                    uniform float phong;\n                    uniform float phongTheta;\n                    uniform float phongFlatShading;\n                  ",fragCode:"\n                    if(isLight == 0.0 &&\n                       isSprite == 0.0 &&\n                       isParticle == 0.0 &&\n                       isLine == 0.0){\n                      //light.rgb *= .5;\n                      float phongP1, phongP2;\n                      float px, py, pz;\n                      if(phongFlatShading != 0.0){\n                        px = nVec.x;\n                        py = nVec.y;\n                        pz = nVec.z;\n                      }else{\n                        vec3 phongPos = R_rpy(nV, vec3(camOri.x, 0.0, 0.0));\n                        px = phongPos.x;\n                        py = phongPos.y;\n                        pz = phongPos.z;\n                      }\n\n                      phongP1 = atan(px, pz) + phongTheta;\n                      phongP2 = -acos( py / (.001 + sqrt(px * px + py * py + pz * pz)))-.2;\n                      \n                      //if(refFlipRefs == 1.0) phongP2 = M_PI - phongP2;\n\n                      float fact = pow(pow((1.0+cos(phongP1)) * (1.0+cos(phongP2+M_PI/2.0)), 3.0), 3.0) / 5e5 * phong +\n                      pow(pow((1.0+cos(phongP1 + M_PI)) * (1.0+cos(phongP2+M_PI/2.0)), 3.0), 3.0) / 5e5 * phong;\n                      light = vec4(light.rgb + fact, 1.0) * 15.0;\n                    }\n                  "};r.optionalUniforms.push(s)}}}}))}));let o={ConnectGeometry:null,datasets:[]};if("2d"!=e.contextType){t.cullFace(t.BACK),e.alpha?(t.blendFunc(t.SRC_ALPHA,t.ONE),t.enable(t.BLEND),t.disable(t.DEPTH_TEST)):t.enable(t.DEPTH_TEST);let a="";r.optionalUniforms.map((e=>{a+="\n"+e.vertDeclaration+"\n"}));let n="";r.optionalUniforms.map((e=>{n+="\n"+e.vertCode+"\n"}));let i="";r.optionalUniforms.map((e=>{i+="\n"+e.fragDeclaration+"\n"}));let c="";r.optionalUniforms.map((e=>{c+="\n"+e.fragCode+"\n"})),o.vert=`\n      precision highp float;\n      #define M_PI 3.14159265358979323\n      attribute vec2 uv;\n      ${a}\n      \n      uniform float t;\n      uniform vec3 color;\n      uniform float factor;\n      uniform float flatShading;\n      uniform float ambientLight;\n      uniform float plugin;\n      uniform vec3 camPos;\n      uniform vec3 camOri;\n      uniform vec3 geoPos;\n      uniform vec3 geoOri;\n      uniform int rotationMode;\n      uniform float omitSplitCheck;\n      uniform float splitCheckPass;\n      uniform float pointSize;\n      uniform float isSprite;\n      uniform float isLight;\n      uniform float cameraMode;\n      uniform float isParticle;\n      uniform float isLine;\n      uniform float penumbraPass;\n      uniform float fov;\n      uniform float equirectangular;\n      uniform float maxHeightmap;\n      uniform float equirectangularHeightmap;\n      uniform float renderNormals;\n      uniform vec2 resolution;\n      uniform float useHeightMap;\n      uniform float heightMapIntensity;\n      uniform sampler2D heightMap;\n      attribute vec3 offset;\n      attribute vec3 position;\n      attribute vec3 normal;\n      attribute vec3 normalVec;\n      varying float depth;\n      varying vec2 vUv;\n      varying vec2 uvi;\n      varying vec3 nVec;\n      varying vec3 nVeci;\n      varying vec3 fPos;\n      varying vec3 fPosi;\n      varying float skip;\n      varying float hasPhong;\n      \n      vec3 pFunc(vec3 pt, float cosa, float sina,\n                          float cosb, float sinb,\n                          float cosc, float sinc){\n        float xx, xy, xz, yx, yy, yz, zx, zy, zz;\n        xx = cosa*cosb;\n        xy = cosa*sinb*sinc - sina*cosc;\n        xz = cosa*sinb*cosc + sina*sinc;\n        yx = sina*cosb;\n        yy = sina*sinb*sinc + cosa*cosc;\n        yz = sina*sinb*cosc - cosa*sinc;\n        zx = -sinb;\n        zy = cosb*sinc;\n        zz = cosb*cosc;\n        return vec3(xx*pt.x + xy*pt.y + xz*pt.z,\n                    yx*pt.x + yy*pt.y + yz*pt.z,\n                    zx*pt.x + zy*pt.y + zz*pt.z);\n      }\n      vec3 Quat(vec3 pos, vec3 rot, int isGeo){\n        \n        if(isLine != 0.0) return pos;\n        float cosa, sina, cosb, sinb, cosc, sinc;\n        vec3 ret = vec3(pos.x, pos.y, pos.z);\n        if(rotationMode == 0 || isGeo == 0){\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        if(rotationMode == 1 && isGeo == 1){\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        if(rotationMode == 2 && isGeo == 1){\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        if(rotationMode == 3 && isGeo == 1){\n          cosa = cos(-rot.x); sina = sin(-rot.x);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(0.0);    sinb = sin(0.0);\n          cosc = cos(rot.y);  sinc = sin(rot.y);\n          ret = pFunc(ret, cosa, sina, cosb, sinb, cosc, sinc);\n          cosa = cos(0.0);    sina = sin(0.0);\n          cosb = cos(-rot.z); sinb = sin(-rot.z);\n          cosc = cos(0.0);    sinc = sin(0.0);\n          ret = pFunc(ret,    cosa, sina, cosb, sinb, cosc, sinc);\n        }\n        return ret;\n      }\n      \n      vec3 R(vec3 pos, vec3 rot, int isGeo){\n        if(isLine != 0.0) return pos;\n        \n        float p, d;\n        if(rotationMode == 0 || isGeo == 0) {\n          pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n          pos.y = cos(p)*d;\n        }\n        if(rotationMode == 1 && isGeo == 1) {\n          pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n          pos.y = cos(p)*d;\n        }\n        if(rotationMode == 2 && isGeo == 1) {\n          pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n          pos.y = cos(p)*d;\n          pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n          pos.z = cos(p)*d;\n          pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n          pos.z = cos(p)*d;\n        }\n        return pos;\n      }\n      \n      void main(){\n        \n        hasPhong = 0.0;\n        \n        float cx, cy, cz;\n        \n        if(renderNormals == 1.0){\n          cx = normal.x;\n          cy = normal.y;\n          cz = normal.z;\n        }else{\n          cx = position.x + offset.x;\n          cy = position.y + offset.y;\n          cz = position.z + offset.z;\n        }\n        \n        if(useHeightMap != 0.0 && renderNormals == 0.0){\n          nVeci = normalVec;\n          vec4 h;\n          float lum;\n\n          if(equirectangularHeightmap != 0.0){\n            float p;\n            float p2;\n            vec3 cpos = vec3(cx, cy, cz);\n            p = flatShading == 1.0 ? atan(nVeci.x, nVeci.z): atan(cpos.x, cpos.z);\n            float p1;\n            p1 = p / M_PI / 2.0;\n            p2 = flatShading == 1.0 ?\n                  acos(nVeci.y / (sqrt(nVeci.x*nVeci.x + nVeci.y*nVeci.y + nVeci.z*nVeci.z)+.00001)) / M_PI   :\n                  acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;\n            uvi = vec2(p1, p2);\n          } else {\n            uvi = uv;\n          }\n\n            \n          h = texture2D( heightMap, uvi);\n          lum = min(maxHeightmap, ((h.r + h.g + h.b) / 3.0) * (heightMapIntensity) / 2.0);\n          cx += normalVec.x * lum;\n          cy += normalVec.y * lum;\n          cz += normalVec.z * lum;\n\n          \n        }else{\n          uvi = uv / 2.0;\n          uvi = vec2(uvi.x, .5 - uvi.y);\n          nVeci = normalVec;\n        }\n        \n        fPosi = vec3(cx, cy, cz);\n        \n        // camera rotation\n        \n        vec3 geo, pos;\n        float cpx = camPos.x;\n        float cpy = camPos.y;\n        float cpz = camPos.z;\n        \n        if(cameraMode == 1.0){  // 'FPS' mode\n          if(isSprite != 0.0 || isLight != 0.0){\n            geo = Quat(geoPos, vec3(camOri.x, -camOri.y, -camOri.z), 0);\n            pos = vec3(cx, cy, cz);\n            pos = Quat(pos,  vec3(0.0, camOri.y, 0.0), 0);\n            pos = Quat(pos,  vec3(0.0, 0.0, camOri.z), 0);\n            pos = Quat(pos,  vec3(camOri.x, 0.0, 0.0), 0);\n            pos.x += cpx;\n            pos.y += cpy;\n            pos.z += cpz;\n            pos = Quat(pos,  vec3(-camOri.x, -camOri.y, -camOri.z), 0);\n            nVec = Quat(nVeci, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(0.0, -camOri.y, -camOri.z), 0);\n\n          }else{\n            geo = Quat(geoPos, vec3(camOri.x, -camOri.y, -camOri.z), 0);\n            pos = Quat(vec3(cx, cy, cz), vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            pos.x += cpx;\n            pos.y += cpy;\n            pos.z += cpz;\n            pos = Quat(pos,  vec3(-camOri.x, -camOri.y, -camOri.z), 0);\n            nVec = Quat(nVeci, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(0.0, -camOri.y, -camOri.z), 0);\n          }\n          cpx = 0.0;\n          cpy = 0.0;\n          cpz = 0.0;\n          fPos = pos;\n        }else{\n          if(isSprite != 0.0 || isLight != 0.0){\n            geo = Quat(geoPos, vec3(camOri.x, camOri.y, -camOri.z), 0);\n            pos = vec3(cx, cy, cz);\n            nVec = vec3(nVeci.x, nVeci.y, nVeci.z);\n            nVec = Quat(nVec, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(camOri.x, camOri.y, -camOri.z), 0);\n          }else{\n            geo = Quat(geoPos, vec3(camOri.x, camOri.y, -camOri.z), 0);\n            pos = vec3(cx, cy, cz);\n            pos = Quat(pos, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            pos = Quat(pos, vec3(camOri.x, camOri.y, -camOri.z), 0);\n            \n            nVec = vec3(nVeci.x, nVeci.y, nVeci.z);\n            nVec = Quat(nVec, vec3(geoOri.x, -geoOri.y, -geoOri.z), 1);\n            nVec = Quat(nVec, vec3(camOri.x, camOri.y, -camOri.z), 0);\n          }\n          fPos = pos;\n        }\n        \n        ${n}\n        \n        float camz = cpz / 1e3 * fov;\n        \n        float X, Y;\n        float Z = pos.z + camz + geo.z;\n        if((isLine != 0.0 || isParticle != 0.0) &&\n          penumbraPass != 0.0) Z += .001;\n        if(isLine != 0.0){\n          X = (position.x + offset.x) / resolution.x * fov;\n          Y = (position.y + offset.y) / resolution.y * fov;\n          Z = position.z + offset.z;\n          gl_Position = vec4(X, Y, Z/10000.0, 1.0);\n          depth = pow(1.0 + sqrt(X*X + Y*Y + Z*Z), 1.0) / 100.0;\n          skip = 0.0;\n          vUv = uv;\n        }else{\n          if( plugin ==  1.0 ){   // equirectangular post-processing plugin\n            X = pos.x + cpx + geo.x;\n            Y = pos.y + cpy + geo.y;\n            Z = pos.z + cpz + geo.z;\n            float dist = sqrt(X*X + Y*Y + Z*Z);\n            float p1;\n            if(omitSplitCheck == 0.0){\n              if(splitCheckPass == 0.0){\n                vec3 rot = R(vec3(X, Y, Z), vec3(0,0,M_PI/2.0), 0);\n                X = rot.x;\n                Y = rot.y;\n                Z = rot.z;\n                p1 = mod(atan(X, Z) / M_PI + 2.0, 2.0) - 1.0;\n                skip = p1 <= -0.75 ? 1.0 : 0.0;\n                p1 += .5;\n              }else{\n                vec3 rot = R(vec3(X, Y, Z), vec3(0,0,-M_PI/2.0), 0);\n                X = rot.x;\n                Y = rot.y;\n                Z = rot.z;\n                p1 = mod(atan(X, Z) / M_PI + 2.0, 2.0) - 1.0;\n                skip = p1 >= 0.75 ? 1.0 : 0.0;\n                p1 -= .5;\n              }\n            }else{\n              skip = 0.0;\n              p1 = atan(X, Z) / M_PI;\n            }\n            if(skip == 0.0){\n              float p2 = - (acos(Y / (dist + .0001)) / M_PI * 2.0 - 1.0) * 1.05;\n              gl_PointSize = 100.0 * pointSize / dist;\n              gl_Position = vec4(p1, p2, dist/10000.0, 1.0);\n              vUv = uv;\n            }\n          } else {  // default projection\n            X = (pos.x + cpx + geo.x) / Z / resolution.x * fov;\n            Y = (pos.y + cpy + geo.y) / Z / resolution.y * fov;\n            if(Z > 0.0) {\n              gl_PointSize = 100.0 * pointSize / Z;\n              gl_Position = vec4(X, Y, Z/10000.0, 1.0);\n              float nx = pos.x + cpx + geo.x;\n              float ny = pos.y + cpy + geo.y;\n              float nz = pos.z + cpz + geo.z;\n              depth = sqrt(nx*nx + ny*ny + nz*nz) / 200.0;\n              skip = 0.0;\n              vUv = uv;\n            }else{\n              skip = 1.0;\n            }\n          }\n        }\n      }\n    `,o.frag=`\n      #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n      #else\n        precision mediump float;\n      #endif\n      #define M_PI 3.14159265358979323\n      ${i}\n      uniform float t;\n      //uniform float factor;\n      uniform vec2 resolution;\n      uniform float plugin;\n      uniform float flatShading;\n      uniform float isSprite;\n      uniform float isLight;\n      uniform float isParticle;\n      uniform float isLine;\n      uniform float cameraMode;\n      uniform vec4 pointLightPos[16];\n      uniform vec4 pointLightCol[16];\n      uniform int pointLightCount;\n      uniform float ambientLight;\n      uniform float renderNormals;\n      uniform float equirectangular;\n      uniform float equirectangularHeightmap;\n      uniform float colorMix;\n      //uniform float penumbraPass;\n      uniform vec3 color;\n      uniform float useHeightMap;\n      uniform float heightMapIntensity;\n      uniform float maxHeightmap;\n      uniform sampler2D heightMap;\n      uniform sampler2D baseTexture;\n      uniform sampler2D supplementalTexture;\n      uniform float supplementalTextureMix;\n      uniform float alpha;\n      uniform vec3 camPos;\n      uniform vec3 camOri;\n      uniform vec3 geoPos;\n      uniform vec3 geoOri;\n      \n        // fog //\n      uniform vec3 fogColor;\n      uniform float fog;\n        /////////\n        \n      varying float depth;\n      varying vec2 vUv;\n      varying vec2 uvi;\n      varying vec3 nVec;\n      varying vec3 nVeci;\n      varying vec3 fPos;\n      varying vec3 fPosi;\n      varying float skip;\n      varying float hasPhong;\n      vec3 rgeoPos;\n      float rheightMapIntensity;\n      float rmaxHeightmap;\n\n      vec4 merge (vec4 col1, vec4 col2){\n        return vec4((col1.rgb * col1.a) + (col2.rgb * col2.a), 1.0);\n      }\n      \n      vec2 Coords(float flatShading, vec3 nV) {\n        vec2 ret;\n        if(equirectangular == 1.0){\n          float p;\n          float p2;\n          vec3 cpos = fPosi;\n          p = flatShading == 1.0 ? atan(nV.x, nV.z): atan(cpos.x, cpos.z) * 1.0;\n          float p1;\n          p1 = p / M_PI / 2.0;\n          p2 = flatShading == 1.0 ?\n                acos(nV.y / (sqrt(nV.x*nV.x + nV.y*nV.y + nV.z*nV.z)+.00001)) / M_PI   :\n                p2 = acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;\n          ret = vec2(p1, p2);\n        }else{\n          ret = vUv;\n        }\n        return ret;\n      }\n\n      vec3 R_ypr(vec3 pos, vec3 rot){\n        if(isLine != 0.0) return pos;\n        float p, d;\n        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n        pos.y = cos(p)*d;\n        return pos;\n      }\n      \n      vec3 R_yrp(vec3 pos, vec3 rot){\n        if(isLine != 0.0) return pos;\n        float p, d;\n        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n        pos.y = cos(p)*d;\n        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        return pos;\n      }\n      \n      vec3 R_rpy(vec3 pos, vec3 rot){\n        if(isLine != 0.0) return pos;\n        float p, d;\n        pos.x = sin(p=atan(pos.x,pos.y)+rot.x)*(d=sqrt(pos.x*pos.x+pos.y*pos.y));\n        pos.y = cos(p)*d;\n        pos.y = sin(p=atan(pos.y,pos.z)+rot.y)*(d=sqrt(pos.y*pos.y+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        pos.x = sin(p=atan(pos.x,pos.z)+rot.z)*(d=sqrt(pos.x*pos.x+pos.z*pos.z));\n        pos.z = cos(p)*d;\n        return pos;\n      }\n      \n      vec4 GetPointLight(){\n        \n        float ret = 0.0;\n        vec4 rgba = vec4(0.0, 0.0, 0.0, 1.0);\n        for(int i=0; i < 16; i++){\n          //if(i >= pointLightCount) break;\n          vec3 lpos = pointLightPos[i].xyz;\n          lpos.x -= rgeoPos.x; //- camPos.x;\n          lpos.y -= rgeoPos.y; //- camPos.y;\n          lpos.z -= rgeoPos.z; //- camPos.z;\n          lpos = R_yrp(lpos, vec3(camOri.x, camOri.y, camOri.z ));\n\n          float mag = pointLightPos[i].w;\n          ret = mag / (1.0 + pow(1.0 + sqrt((lpos.x-fPos.x) * (lpos.x-fPos.x) + (lpos.y-fPos.y) * (lpos.y-fPos.y) +\n          + (lpos.z-fPos.z) * (lpos.z-fPos.z)), 2.0) / 3.0) * 20.0;\n          \n          rgba.r += ret * pointLightCol[i].r;\n          rgba.g += ret * pointLightCol[i].g;\n          rgba.b += ret * pointLightCol[i].b;\n        }\n        return pointLightCount > 0 ? vec4(rgba.rgb + ambientLight, 1.0) : vec4(ambientLight, ambientLight, ambientLight, 1.0);\n      }\n\n      void main() {\n        float factor = 1.0;\n        rgeoPos = geoPos / factor;\n        rheightMapIntensity = heightMapIntensity / factor;\n        rmaxHeightmap = maxHeightmap / factor;\n\n\n        if(isParticle != 0.0 || isLine != 0.0){\n          gl_FragColor = merge(gl_FragColor, vec4(color.rgb, alpha));\n        }else{\n          float mixColorIp = colorMix;\n          float mixColorIp2 = 1.0;\n          float baseColorIp = 1.0 - mixColorIp;\n          float baseColorIp2 = 1.0 - mixColorIp2;\n          vec4 mixColor = vec4(color.rgb, mixColorIp);\n          vec4 mixColor2 = vec4(color.rgb, mixColorIp2);\n          vec4 light = hasPhong == 1.0 ? GetPointLight() :\n                vec4(ambientLight, ambientLight, ambientLight, 1.0);\n          float colorMag = 1.0;\n          if(skip != 1.0){\n            if(renderNormals == 1.0){\n              gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n            }else{\n              float p;\n              vec3 nV, nVi;\n              if(useHeightMap != 0.0){\n                \n                float rad = .02;\n                float rad2 = -.25;\n                vec2 cr1, cr2, cr3;\n                float lum1, lum2, lum3;\n                for(float j=0.0; j<3.0; j+=1.0){\n                  \n                  float tx, ty;\n                  p = M_PI * 2.0 / 3.0 * j;\n                  tx = -sin(p) * rad;\n                  ty = -cos(p) * rad;\n                \n                  vec2 hcoords;\n                  if(equirectangularHeightmap == 1.0){\n                    float p;\n                    float p2;\n                    vec3 cpos = fPosi;\n                    p = flatShading == 1.0 ? atan(nV.x, nV.z): atan(cpos.x, cpos.z) * 1.0;\n                    float p1;\n                    p1 = p / M_PI / 2.0;\n                    p2 = flatShading == 1.0 ?\n                          acos(nV.y / (sqrt(nV.x*nV.x + nV.y*nV.y + nV.z*nV.z)+.00001)) / M_PI   :\n                          p2 = acos(cpos.y / (sqrt(cpos.x*cpos.x + cpos.y*cpos.y + cpos.z*cpos.z)+.00001)) / M_PI;\n                    tx += p1;\n                    ty += p2;\n                    hcoords = vec2(tx, ty);\n                  }else{\n                    hcoords = vUv + vec2(tx, ty);\n                  }\n                  \n                  vec4 htexel = texture2D( heightMap, hcoords);\n                  float lum = (htexel.r + htexel.g + htexel.b) / 3.0;\n                  if(j == 0.0) {\n                    lum1 = lum;\n                    cr1 = hcoords;\n                  }\n                  if(j == 1.0) {\n                    lum2 = lum;\n                    cr1 = hcoords;\n                  }\n                  if(j == 2.0) {\n                    lum3 = lum;\n                    cr2 = hcoords;\n                  }\n                }\n\n                float a1 = cr1.x;\n                float a2 = cr1.y;\n                float a3 = (lum1 - 0.5) * rad2;\n                \n                float b1 = cr2.x - a1;\n                float b2 = cr2.y - a2;\n                float b3 = (lum2 - 0.5) * rad2 - a3;\n                float c1 = cr3.x - cr2.x;\n                float c2 = cr3.y - cr2.y;\n                float c3 = (lum3 - 0.5) * rad2 - (lum2 - 0.5) * rad2;\n                vec3 anorm =  vec3(b2*c3-b3*c2, b3*c1-b1*c3, b1*c2-b2*c1) * min(maxHeightmap / 5.0, (1.0 + heightMapIntensity) / 2.0);\n                nV = normalize( nVec + anorm);\n                nVi = normalize( nVeci + anorm);\n              }else{\n                nV = nVec;\n                nVi = nVeci;\n              }\n              \n              \n              vec2 coords = Coords(0.0, nVi);\n              \n              ${c}\n              \n              vec4 texel = texture2D( baseTexture, coords);\n              texel = merge(texel, vec4(texture2D( supplementalTexture, coords).rgb, supplementalTextureMix));\n              float fv;\n              if(isSprite != 0.0 || isLight != 0.0){\n                if(fog != 0.0){\n                  vec4 preFog = vec4(texel.rgb * 3.0, texel.a);\n                  fv = min(1.0, depth * fog) * min(alpha * 2.0, 1.0);\n                  gl_FragColor = merge(vec4(preFog.rgb, (1.0 - fv)), vec4(fogColor.rgb, 0.0));\n                }else{\n                  gl_FragColor = vec4(texel.rgb * 2.0, texel.a * alpha);\n                }\n              }else{\n                \n                texel.a = baseColorIp / 2.0;\n                vec4 col = merge(mixColor, texel);\n                col.a = 1.0;\n                if(baseColorIp2 != 0.0){\n                  mixColor2.a = baseColorIp2;\n                  col = merge(mixColor2, col); // refractions\n                }\n                col.rgb *= light.rgb;\n                \n                \n                if(fog != 0.0){\n                  vec4 preFog = vec4(col.rgb * colorMag, 1.0);\n                  fv = min(1.0, depth * fog);\n                  gl_FragColor = merge(vec4(preFog.rgb, 1.0 - fv), vec4(fogColor.rgb, fv));\n                }else{\n                  gl_FragColor = vec4(col.rgb * colorMag, 1.0);\n                }\n              }\n            }\n          }\n        }\n      }\n    `;const p=t.createShader(t.VERTEX_SHADER);t.shaderSource(p,o.vert),t.compileShader(p);const f=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(f,o.frag),t.compileShader(f),o.ConnectGeometry=(a,n=!1)=>{var i=a.involveCache,c=structuredClone(r);o.datasets.push(c),c.program=t.createProgram(),t.attachShader(c.program,p),t.attachShader(c.program,f),t.linkProgram(c.program),a.shader=o;var u=a.map,m=a.heightMap;if(a.datasetIdx=o.datasets.length-1,t.getProgramParameter(c.program,t.LINK_STATUS)){if(t.useProgram(c.program),t.bindBuffer(t.ARRAY_BUFFER,a.vertex_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.Vertex_Index_Buffer),c.locPosition=t.getAttribLocation(c.program,"position"),t.vertexAttribPointer(c.locPosition,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(c.locPosition),t.bindBuffer(t.ARRAY_BUFFER,a.offset_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.Offset_Index_Buffer),c.locOffset=t.getAttribLocation(c.program,"offset"),t.vertexAttribPointer(c.locOffset,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(c.locOffset),t.bindBuffer(t.ARRAY_BUFFER,a.uv_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.UV_Index_Buffer),c.locUv=t.getAttribLocation(c.program,"uv"),t.vertexAttribPointer(c.locUv,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(c.locUv),t.bindBuffer(t.ARRAY_BUFFER,a.normal_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.Normal_Index_Buffer),c.locNormal=t.getAttribLocation(c.program,"normal"),t.vertexAttribPointer(c.locNormal,3,t.FLOAT,!0,0,0),t.enableVertexAttribArray(c.locNormal),t.bindBuffer(t.ARRAY_BUFFER,a.normalVec_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a.NormalVec_Index_Buffer),c.locNormalVec=t.getAttribLocation(c.program,"normalVec"),t.vertexAttribPointer(c.locNormalVec,3,t.FLOAT,!0,0,0),t.enableVertexAttribArray(c.locNormalVec),!n){if(a.isLight||c.optionalUniforms.map((async e=>{switch(e.name){case"fog":break;case"reflection":if(n=e.map){let a,p=(a=n.split("."))[a.length-1].toLowerCase();switch(e.refTexture=t.createTexture(),e.locRefTheta=t.getUniformLocation(c.program,"refTheta"),p){case"mp4":case"webm":case"avi":case"mkv":case"ogv":e.textureMode="video",i&&(l=h.textures.filter((e=>e.url==n))).length?(console.log("found video in cache... using it"),e.video=l[0].resource,o.datasets.push({texture:l[0].texture,iURL:n})):(e.video=document.createElement("video"),e.video.muted=!0,e.video.playbackRate=e.playbackSpeed,e.video.defaultPlaybackRate=e.playbackSpeed,o.datasets.push({texture:e.refTexture,iURL:n}),e.video.loop=!0,e.muted||s||(s=!0,F("play audio OK?",!0,(()=>{h.textures.filter((e=>e.url==n))[0].resource.muted=!1,h.textures.filter((e=>e.url==n))[0].resource.currentTime=0,h.textures.filter((e=>e.url==n))[0].resource.play()}))),e.video.playbackRate=e.video.defaultPlaybackRate=e.playbackSpeed,e.video.oncanplay=async()=>{e.video.play()},t.activeTexture(t.TEXTURE1),U(t,e.video,e.refTexture,e.textureMode,-1,{url:n}),h.textures.push({url:n,resource:e.video,texture:e.refTexture}),await fetch(n).then((e=>e.blob())).then((a=>{e.video.src=URL.createObjectURL(a)})));break;default:e.textureMode="image";var r=new Image;o.datasets.push({texture:e.refTexture,iURL:n}),t.uniform1f(e.locRefFlipRefs,e.flipReflections),t.bindTexture(t.TEXTURE_2D,e.refTexture),r.onload=()=>{t.activeTexture(t.TEXTURE1),U(t,r,e.refTexture,e.textureMode,-1,{url:n})},e.image=r,h.textures.push({url:n,resource:r,texture:e.refTexture}),await fetch(n).then((e=>e.blob())).then((e=>{r.src=URL.createObjectURL(e)}))}}t.useProgram(c.program),t.activeTexture(t.TEXTURE1),e.locRefOmitEquirectangular=t.getUniformLocation(c.program,"refOmitEquirectangular"),t.uniform1f(e.locRefOmitEquirectangular,"rectangle"==a.shapeType||"point light"==a.shapeType||"sprite"==a.shapeType||"particles"==a.shapeType||"lines"==a.shapeType?1:0),e.locRefFlipRefs=t.getUniformLocation(c.program,"refFlipRefs"),t.uniform1f(e.locRefFlipRefs,e.flipReflections),e.locRefTexture=t.getUniformLocation(c.program,"reflectionMap"),t.bindTexture(t.TEXTURE_2D,e.refTexture),t.uniform1i(e.locRefTexture,1),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,e.refTexture);break;case"refraction":var n;if(n=e.map){var p,f,u,m;e.refractionVecs=[];for(var g=0;g<a.normalVecs.length;g+=3){for(var v=a.vertices[g+0],y=a.vertices[g+1],b=a.vertices[g+2],x=a.normalVecs[g+0],R=a.normalVecs[g+1],M=a.normalVecs[g+2],A=6e6,E=0;6e6==A&&E<a.vertices.length;E+=9)if(6e6==A){var T=[];p=a.vertices[E+0],f=a.vertices[E+1],u=a.vertices[E+2],T.push(p,f,u),p=a.vertices[E+3],f=a.vertices[E+4],u=a.vertices[E+5],T.push(p,f,u),p=a.vertices[E+6],f=a.vertices[E+7],u=a.vertices[E+8],T.push(p,f,u),(m=se(v-.01*x,y-.01*R,b-.01*M,v-1e4*x,y-1e4*R,b-1e4*M,T,!0))&&(d=Math.hypot(m[0][0]-v,m[0][1]-y,m[0][2]-b))<A&&(E,A=d)}3*(g%9/3|0),e.refractionVecs.push(a.normalVecs[g+0]),e.refractionVecs.push(a.normalVecs[g+1]),e.refractionVecs.push(a.normalVecs[g+2])}let c;e.refractionVecs=new Float32Array(e.refractionVecs),e.refractionVec_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.refractionVec_buffer),t.bufferData(t.ARRAY_BUFFER,e.refractionVecs,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),e.refractionVecIndices=new Uint32Array(Array(e.refractionVecs.length/3).fill().map(((e,a)=>a))),e.RefractionVec_Index_Buffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.RefractionVec_Index_Buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e.refractionVecIndices,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindBuffer(t.ARRAY_BUFFER,e.refractionVec_buffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.RefractionVec_Index_Buffer);let w=(c=n.split("."))[c.length-1].toLowerCase();switch(e.refractionTexture=t.createTexture(),w){case"mp4":case"webm":case"avi":case"mkv":case"ogv":e.textureMode="video",i&&(l=h.textures.filter((e=>e.url==n))).length?(console.log("found video in cache... using it"),e.video=l[0].resource,o.datasets.push({texture:l[0].texture,iURL:n})):(e.video=document.createElement("video"),e.video.muted=!0,e.video.playbackRate=e.playbackSpeed,e.video.defaultPlaybackRate=e.playbackSpeed,o.datasets.push({texture:e.refractionTexture,iURL:n}),e.video.loop=!0,e.muted||s||(s=!0,F("play audio OK?",!0,(()=>{h.textures.filter((e=>e.url==n))[0].resource.muted=!1,h.textures.filter((e=>e.url==n))[0].resource.currentTime=0,h.textures.filter((e=>e.url==n))[0].resource.play()}))),e.video.playbackRate=e.video.defaultPlaybackRate=e.playbackSpeed,e.video.oncanplay=async()=>{e.video.play()},t.activeTexture(t.TEXTURE5),U(t,e.video,e.refractionTexture,e.textureMode,-1,e),h.textures.push({url:n,resource:e.video,texture:e.refractionTexture}),await fetch(n).then((e=>e.blob())).then((a=>{e.video.src=URL.createObjectURL(a)})));break;default:e.textureMode="image";r=new Image;o.datasets.push({texture:e.refractionTexture,iURL:n}),t.activeTexture(t.TEXTURE5),t.uniform1f(e.locRefractionFlipRefs,e.flipRefractionlections),t.bindTexture(t.TEXTURE_2D,e.refractionTexture),r.onload=()=>{U(t,r,e.refractionTexture,e.textureMode,-1,e)},h.textures.push({url:n,resource:r,texture:e.refractionTexture}),await fetch(n).then((e=>e.blob())).then((e=>{r.src=URL.createObjectURL(e)}))}}t.useProgram(c.program),t.activeTexture(t.TEXTURE5),t.uniform1i(e.locRefractionTexture,5),c.locRefractionlVec=t.getAttribLocation(c.program,"nVecRefraction"),t.vertexAttribPointer(c.locRefractionVec,3,t.FLOAT,!0,0,0),t.enableVertexAttribArray(c.locRefractionVec),e.locRefractionOmitEquirectangular=t.getUniformLocation(c.program,"refractionOmitEquirectangular"),t.uniform1f(e.locRefractionOmitEquirectangular,"rectangle"==a.shapeType||"point light"==a.shapeType||"sprite"==a.shapeType||"particles"==a.shapeType||"lines"==a.shapeType?1:0),e.locRefractionFlipRefs=t.getUniformLocation(c.program,"refractionFlipRefs"),t.uniform1f(e.locRefractionFlipRefs,e.flipRefractions),e.locRefractionTexture=t.getUniformLocation(c.program,"refractionMap"),t.bindTexture(t.TEXTURE_2D,e.refractionTexture),t.uniform1i(e.locRefractionTexture,5),t.activeTexture(t.TEXTURE5),t.bindTexture(t.TEXTURE_2D,e.refractionTexture);break;case"phong":e.locPhongTheta=t.getUniformLocation(c.program,e.theta),t.uniform1f(e.locPhongTheta,e.theta)}e.locFlatShading=t.getUniformLocation(c.program,e.flatShadingUniform),t.uniform1f(e.locFlatShading,e.flatShading?1:0),e.loc=t.getUniformLocation(c.program,e.name),"uniform4f"==e.dataType?t[e.dataType](e.loc,...e.value):t[e.dataType](e.loc,e.value)})),c.locColor=t.getUniformLocation(c.program,"color"),t.uniform3f(c.locColor,...Le(a.color)),("particles"==a.shapeType||a.isParticle||"lines"==a.shapeType||a.isLine)&&(c.locPointSize=t.getUniformLocation(c.program,"pointSize"),t.uniform1f(c.locPointSize,a.size)),c.locColorMix=t.getUniformLocation(c.program,"colorMix"),t.uniform1f(c.locColorMix,a.colorMix),c.locIsSprite=t.getUniformLocation(c.program,"isSprite"),t.uniform1f(c.locIsSprite,a.isSprite?1:0),c.locCameraMode=t.getUniformLocation(c.program,"cameraMode"),t.uniform1f(c.locCameraMode,"fps"==e.cameraMode.toLowerCase()?1:0),c.locSupplementalTextureMix=t.getUniformLocation(c.program,"supplementalTextureMix"),t.uniform1f(c.locSupplementalTextureMix,a.canvasTextureMix),c.locFog=t.getUniformLocation(c.program,"fog"),c.locFogColor=t.getUniformLocation(c.program,"fogColor"),c.locIsLight=t.getUniformLocation(c.program,"isLight"),t.uniform1f(c.locIsLight,a.isLight?1:0),c.locIsParticle=t.getUniformLocation(c.program,"isParticle"),t.uniform1f(c.locIsParticle,a.isParticle?1:0),c.locIsLine=t.getUniformLocation(c.program,"isLine"),t.uniform1f(c.locIsLine,a.isLine?1:0),c.locPenumbraPass=t.getUniformLocation(c.program,"penumbraPass"),c.locAlpha=t.getUniformLocation(c.program,"alpha"),t.uniform1f(c.locAlpha,a.alpha),c.locPointLights=t.getUniformLocation(c.program,"pointLightPos[0]"),c.locPointLightCols=t.getUniformLocation(c.program,"pointLightCol[0]"),c.locPointLightCount=t.getUniformLocation(c.program,"pointLightCount"),t.uniform1i(c.locPointLightCount,0),c.locResolution=t.getUniformLocation(c.program,"resolution"),t.uniform2f(c.locResolution,e.width,e.height),c.locEquirectangular=t.getUniformLocation(c.program,"equirectangular"),t.uniform1f(c.locEquirectangular,a.equirectangular?1:0),c.locT=t.getUniformLocation(c.program,"t"),t.uniform1f(c.locT,0),c.locAmbientLight=t.getUniformLocation(c.program,"ambientLight"),t.uniform1f(c.locAmbientLight,e.ambientLight),c.locRotationMode=t.getUniformLocation(c.program,"rotationMode"),t.uniform1i(c.locRotationMode,a.rotationMode),c.texture=t.createTexture(),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,c.texture),c.locTexture=t.getUniformLocation(c.program,"baseTexture"),a.heightMap&&(c.heightTexture=t.createTexture(),c.locHeightMap=t.getUniformLocation(c.program,"heightMap"),c.locEquirectangularHeightmap=t.getUniformLocation(c.program,"equirectangularHeightmap"),c.locUseHeightMap=t.getUniformLocation(c.program,"useHeightMap"),c.locHeightMapIntensity=t.getUniformLocation(c.program,"heightMapIntensity"),c.locMaxHeightmap=t.getUniformLocation(c.program,"maxHeightmap"),t.activeTexture(t.TEXTURE0)),c.supplementalTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,c.supplementalTexture),c.locSupplementalTexture=t.getUniformLocation(c.program,"supplementalTexture"),u)if(Re(u))a.textureMode="dataArray",a.mapIsDataArray=!0,U(t,"",c.texture,a.textureMode,0,a);else{let e;switch(c.iURL=u,(e=u.split("."))[e.length-1].toLowerCase()){case"mp4":case"webm":case"avi":case"mkv":case"ogv":a.textureMode="video",i&&(l=h.textures.filter((e=>e.url==c.iURL))).length?(console.log("found video in cache... using it"),c.resource=l[0].resource,c.texture=l[0].texture):(c.resource=document.createElement("video"),c.resource.muted=!0,c.resource.addEventListener("canplay",(()=>{c.resource.playbackRate=c.resource.defaultPlaybackRate=a.playbackSpeed})),c.resource.loop=!0,a.muted||s||(s=!0,F("play audio OK?",!0,(()=>{c.resource.muted=!1,c.resource.currentTime=0,c.resource.play()}))),c.resource.playbackRate=c.resource.defaultPlaybackRate=a.playbackSpeed,c.resource.oncanplay=async()=>{c.resource.play()},h.textures.push({url:u,resource:c.resource,texture:c.texture}),fetch(u).then((e=>e.blob())).then((e=>{c.resource.src=URL.createObjectURL(e)})));break;default:a.textureMode="image";var g=new Image;a.image=g,h.textures.push({url:u,resource:g,texture:c.texture}),g.onload=async()=>{t.activeTexture(t.TEXTURE0),U(t,g,c.texture,a.textureMode,-1,{map:u})},fetch(u).then((e=>e.blob())).then((e=>{g.src=URL.createObjectURL(e)}))}}if(t.useProgram(c.program),t.activeTexture(t.TEXTURE0),t.uniform1i(c.locTexture,0),t.bindTexture(t.TEXTURE_2D,c.texture),a.heightMapIsCanvas)c.heightResource=m;else if(m)if(Re(m))a.heightTextureMode="heightmapDataArray",a.heightmapIsDataArray=!0,U(t,"",c.texture,a.heightTextureMode,0,{map:m});else{let e;switch(c.heightMapURL=m,(e=m.split("."))[e.length-1].toLowerCase()){case"mp4":case"webm":case"avi":case"mkv":case"ogv":a.heightTextureMode="video",i&&(l=h.textures.filter((e=>e.url==c.heightMapURL))).length?(console.log("found video in cache... using it"),c.heightResource=l[0].resource,c.heightTexture=l[0].texture):(c.heightResource=document.createElement("video"),c.heightResource.muted=!0,c.heightResource.addEventListener("canplay",(()=>{c.heightResource.playbackRate=c.heightResource.defaultPlaybackRate=a.playbackSpeed})),c.heightResource.loop=!0,a.muted||s||(s=!0,F("play audio OK?",!0,(()=>{c.heightResource.muted=!1,c.heightResource.currentTime=0,c.heightResource.play()}))),c.heightResource.playbackRate=c.heightResource.defaultPlaybackRate=a.playbackSpeed,c.heightResource.oncanplay=async()=>{c.heightResource.play()},h.textures.push({url:m,resource:c.heightResource,texture:c.heightTexture}),fetch(m).then((e=>e.blob())).then((e=>{c.heightResource.src=URL.createObjectURL(e)})));break;default:a.heightTextureMode="heightImage";var v=new Image;c.heightResource=v,h.textures.push({url:m,resource:v,texture:c.heightTexture}),v.onload=async()=>{t.useProgram(c.program),t.activeTexture(t.TEXTURE4),t.uniform1i(c.locHeightMap,4),U(t,v,c.heightTexture,a.heightTextureMode,-1,{heightMapURL:m}),t.activeTexture(t.TEXTURE0)},fetch(m).then((e=>e.blob())).then((e=>{v.src=URL.createObjectURL(e)}))}}t.useProgram(c.program),c.locCamPos=t.getUniformLocation(c.program,"camPos"),c.locCamOri=t.getUniformLocation(c.program,"camOri"),c.locGeoPos=t.getUniformLocation(c.program,"geoPos"),c.locGeoOri=t.getUniformLocation(c.program,"geoOri"),c.locFov=t.getUniformLocation(c.program,"fov"),c.locRenderNormals=t.getUniformLocation(c.program,"renderNormals"),t.uniform3f(c.locCamPos,e.x,e.y,e.z),t.uniform3f(c.locCamOri,e.roll,e.pitch,e.yaw),t.uniform3f(c.locGeoPos,e.x,e.y,e.z),t.uniform3f(c.locGeoOri,a.roll,a.pitch,a.yaw),t.uniform1f(c.locFov,e.fov),t.uniform1f(c.locRenderNormals,0)}}else{var y=t.getProgramInfoLog(c.program),b=t.getShaderInfoLog(p),x=t.getShaderInfoLog(f);console.error(`bad shader :( ${y}`),console.error(`vShader info : ${b}`,o.vert),console.error(`fShader info : ${x}`,o.frag)}}}return o},N=e=>{var a,t,n,s,i,c,l,h,p=e.shapeData;const f=e=>{p[e].mx=p[e].x,p[e].my=p[e].y,p[e].mz=p[e].z,p[e].wx=p[e].x+p[e].ox+p[e].offsetx,p[e].wy=p[e].y+p[e].oy+p[e].offsety,p[e].wz=p[e].z+p[e].oz+p[e].offsetz,p[e].mroll=p[e].roll,p[e].mpitch=p[e].pitch,p[e].myaw=p[e].yaw};for(var u=0;u<e.vertices.length;u+=e.stride){var m=u/e.stride;if(p[m].moffsetx!=p[m].offsetx||p[m].moffsety!=p[m].offsety||p[m].moffsetz!=p[m].offsetz){a=p[m].offsetx,t=p[m].offsety,n=p[m].offsetz;for(var d=0;d<e.stride;d+=3)e.offsets[u+d+0]=a,e.offsets[u+d+1]=t,e.offsets[u+d+2]=n;p[m].moffsetx=p[m].offsetx,p[m].moffsety=p[m].offsety,p[m].moffsetz=p[m].offsetz,f(m)}if(p[m].mx!=p[m].x||p[m].my!=p[m].y||p[m].mz!=p[m].z||p[m].mroll!=p[m].roll||p[m].mpitch!=p[m].pitch||p[m].myaw!=p[m].yaw){a=p[m].ox,t=p[m].oy,n=p[m].oz;for(d=0;d<e.stride;d+=3)for(var g=2;g-- >0;){var v;s=e[v=g?"vstate":"nvstate"][u+d+0]-a*g,i=e[v][u+d+1]-t*g,c=e[v][u+d+2]-n*g,l=Math.atan2(i,c)+p[m].pitch,h=Math.hypot(i,c),i=r(l)*h,c=o(l)*h,l=Math.atan2(s,i)+p[m].roll,h=Math.hypot(s,i),s=r(l)*h,i=o(l)*h,l=Math.atan2(s,c)+p[m].yaw,h=Math.hypot(s,c),s=r(l)*h,c=o(l)*h,e[v=g?"vertices":"normalVecs"][u+d+0]=s+(a+p[m].x)*g,e[v][u+d+1]=i+(t+p[m].y)*g,e[v][u+d+2]=c+(n+p[m].z)*g,e.showNormals&&(s=e.nstate[2*(u+d)+0+3*g]-a,i=e.nstate[2*(u+d)+1+3*g]-t,c=e.nstate[2*(u+d)+2+3*g]-n,l=Math.atan2(i,c)+p[m].pitch,h=Math.hypot(i,c),i=r(l)*h,c=o(l)*h,l=Math.atan2(s,c)+p[m].yaw,h=Math.hypot(s,c),s=r(l)*h,c=o(l)*h,l=Math.atan2(s,i)+p[m].roll,h=Math.hypot(s,i),s=r(l)*h,i=o(l)*h,e.normals[2*(u+d)+0+3*g]=s+a,e.normals[2*(u+d)+1+3*g]=i+t,e.normals[2*(u+d)+2+3*g]=c+n)}f(m)}}},Y=async(e,a,t={})=>{var r={vertices:[],normals:[],normalVecs:[],uvs:[]},o=e.vertices.length,n=e.vertices,s=e.normals,i=e.uvs,c=e.normalVecs,l=(o=e.vertices.length,[]);a.map(((e,a)=>{for(var t=e[0],o=e[1],h=e[2],p=0;p<n.length;p+=3)r.vertices.push(t+n[p+0],o+n[p+1],h+n[p+2]),s&&r.normals.push(t+s[2*p+0],o+s[2*p+1],h+s[2*p+2]),s&&r.normals.push(t+s[2*p+3],o+s[2*p+4],h+s[2*p+5]),i&&r.uvs.push(i[p/3*2+0],t+i[p/3*2+1]),c&&r.normalVecs.push(c[p+0],c[p+1],c[p+2]);l.push({ox:t,oy:o,oz:h,wx:t,wy:o,wz:h,x:0,y:0,z:0,roll:0,pitch:0,yaw:0,mx:t,my:o,mz:h,mroll:0,mpitch:0,myaw:0,moffsetx:0,moffsety:0,moffsetz:0,offsetx:0,offsety:0,offsetz:0})})),void 0!==t?.shapeData&&(t.shapeData.forEach(((e,a)=>{Object.keys(e).forEach(((t,r)=>{l[a][t]=e[t]}))})),delete t.shapeData);var h,p=e.shapeType,f={shapeData:l};return e.canvasTexture&&e.canvasTexture,["x","y","z","rows","cols","size","url","roll","pitch","yaw","color","colorMix","showNormals","exportShape","downloadShape","normalAssocs","equirectangular","flipNormals","textureMode","isSprite","isLight","playbackSpeed","disableDepthTest","lum","alpha","involveCache","isParticle","isLine","penumbra","wireframe","canvasTextureMix","showBounding","boundingColor","heightMap","heightMapIntensity","heightMapIsCanvas","equirectangularHeightmap","isFromZip","rotationMode","mapIsDataArray","dataArrayFormat","maxHeightmap","dataArrayWidth","dataArrayHeight","preComputeNormalAssocs","heightmapIsDataArray","heightmapDataArrayFormat","heightmapDataArrayWidth","heightmapDataArrayHeight","rebindTextures","exportAsOBJ","downloadAsOBJ","resolved","map","video","muted"].forEach((a=>{f[a]=e[a]})),f.name=e.name,Object.keys(t).forEach(((e,a)=>{f[e]=t[e]})),e.canvasTexture&&(f.canvasTexture=e.canvasTexture),f.shapeType="custom shape",f.geometryData=r,await k(e.renderer,f).then((async a=>{for(var t=0;t<a.vertices.length;t+=o)for(var r=0;r<o;r+=3){var n=(t+r)/3*2;a.uvs[n+0]=e.uvs[n%e.uvs.length+0],a.uvs[n+1]=e.uvs[n%e.uvs.length+1]}a.vstate=structuredClone(a.vertices),a.nstate=structuredClone(a.normals),a.uvs=structuredClone(a.uvs),a.nvstate=structuredClone(a.normalVecs),a.shapeType=p,a.stride=o,a.isShapeArray=!0,h=a})),h},H=async(e,a={})=>{var t=!0,r=[],o={size:1,alpha:.8,penumbra:.5,shapeType:"lines",color:16777215};Object.keys(e).forEach(((a,t)=>{switch(a.toLowerCase()){case"shapetype":default:break;case"x":case"y":case"z":case"roll":case"pitch":case"yaw":o[a]=e[a]}})),Object.keys(a).forEach(((e,r)=>{switch(e.toLowerCase()){case"shapetype":break;case"closepaths":t=a[e];break;default:o[e]=a[e]}}));const n=(e,a,t,o,n,s)=>{for(var i,c,l,h,p,f,u=!0,m=r,d=0;u&&d<m.length;d+=6)i=m[d+0],c=m[d+1],l=m[d+2],h=m[d+3],p=m[d+4],f=m[d+5],(i==e&&c==a&&l==t&&h==o&&p==n&&f==s||i==o&&c==n&&l==s&&h==e&&p==a&&f==t)&&(u=!1);return u};for(var s,i=e.vertices,c=0;c<i.length;c+=9){var l,h,p,f,u,m,d,g,v;l=-i[c+0],h=-i[c+1],p=-i[c+2],f=-i[c+3],u=-i[c+4],m=-i[c+5],d=-i[c+6],g=-i[c+7],v=-i[c+8],s=[],n(l,h,p,f,u,m)&&s.push(l,h,p,f,u,m),n(f,u,m,d,g,v)&&s.push(f,u,m,d,g,v),t&&n(d,g,v,l,h,p)&&s.push(d,g,v,l,h,p),r.push(...s)}var y=[];for(c=0;c<r.length;c+=3)y.push([r[c+0],r[c+1],r[c+2]]);o.geometryData=y;var b={shape:null};return await k(e.renderer,o).then((e=>{b.shape=e})),b},q=e=>{var a;switch(e){case"tetrahedron":case"cube":case"octahedron":case"dodecahedron":case"icosahedron":case"tetrahedron":a=!0;break;default:a=!1}return a},X=(e,a,t,r,o,n,s=!1,i="")=>{var c,l,h,p,f,u=[],m=[],d=e,g=[],v=`${i}_${r}`,y=q(i);if("obj"===i)f=j(0,1,o,d,a,v);else f=j(r+(y?1:0),1,o,d,a,v);for(f.map(((e,a)=>{var r=e.verts;//!flipNormals ? shape[shape.length-vidx-1].verts : v.verts
r.map((e=>{e[0]*=t,e[1]*=t,e[2]*=t})),s||4==r.length?(u.push(r[2],r[1],r[0],r[0],r[3],r[2]),void 0!==e.uvs&&e.uvs.length&&m.push(e.uvs[2],e.uvs[1],e.uvs[0],e.uvs[0],e.uvs[3],e.uvs[2])):(u.push(...r),void 0!==e.uvs&&e.uvs.length&&m.push(...e.uvs))})),l=0;l<u.length;l++){var b;h=[u[3*(c=l/3|0)+2],u[3*c+1],u[3*c+0]],l%3||(b=ue(h,!1),n&&(b[3]=b[0]-(b[0]-b[3]),b[4]=b[1]-(b[1]-b[4]),b[5]=b[2]-(b[2]-b[5]))),p=n?u.length-l-1:l,g.push({position:u[p],normal:[...u[p],u[p][0]-(b[3]-b[0]),u[p][1]-(b[4]-b[1]),u[p][2]-(b[5]-b[2])],texCoord:m[p]})}return{geometry:g}},j=(e,a,t,r,o,n="")=>{var s,i,c,l,h,p,f,u,m,d,g,v,y,b,x,R,M,A,E,T,w,P,_,L,I,k,F,z,U,C,S,B,O,V,D,N,Y,H,q,X,j,W,$,G,Q,Z,K,J,ee,ae,te,re,oe,ne,se,ie,ce,le,he,pe,fe,ue,me,de,ge=!1;if(!ge)for(var ve=e;ve--;)s=r,i=o,r=[],o=[],s.map(((e,a)=>{switch(f=e[c=0][0],u=e[c][1],m=e[c][2],i.length&&i[a].length>c&&(de=i[a],I=de[c][0],k=de[c][1]),d=e[c=1][0],g=e[c][1],v=e[c][2],i.length&&i[a].length>c&&(F=de[c][0],z=de[c][1]),y=e[c=2][0],b=e[c][1],x=e[c][2],i.length&&i[a].length>c&&(U=de[c][0],C=de[c][1]),e.length>3&&(R=e[c=3][0],M=e[c][1],A=e[c][2],i.length&&i[a].length>c&&(S=de[c][0],B=de[c][1]),e.length>4&&(E=e[c=4][0],T=e[c][1],w=e[c][2],i.length&&i[a].length>c&&(O=de[c][0],V=de[c][1]),e.length>5&&(P=e[c=5][0],_=e[c][1],L=e[c][2],i.length&&i[a].length>c&&(D=de[c][0],N=de[c][1])))),Y=(f+d)/2,H=(u+g)/2,q=(m+v)/2,X=(d+y)/2,j=(g+b)/2,W=(v+x)/2,void 0!==I&&(ee=(I+F)/2,ae=(k+z)/2,te=(F+U)/2,re=(z+C)/2),pe=[],fe=[],e.length){case 3:$=(y+f)/2,G=(b+u)/2,Q=(x+m)/2,void 0!==I&&(oe=(U+I)/2,ne=(C+k)/2,l=I,h=k,fe.push([l,h]),l=ee,h=ae,fe.push([l,h]),l=oe,h=ne,fe.push([l,h]),o.push(fe),(fe=[]).push([l=ee,h=ae]),l=F,h=z,fe.push([l,h]),l=te,h=re,fe.push([l,h]),o.push(fe),(fe=[]).push([l=oe,h=ne]),l=te,h=re,fe.push([l,h]),l=U,h=C,fe.push([l,h]),o.push(fe),(fe=[]).push([l=ee,h=ae]),l=te,h=re,fe.push([l,h]),l=oe,h=ne,fe.push([l,h]),o.push(fe)),l=f,h=u,p=m,pe.push([l,h,p]),l=Y,h=H,p=q,pe.push([l,h,p]),l=$,h=G,p=Q,pe.push([l,h,p]),r.push(pe),(pe=[]).push([l=Y,h=H,p=q]),l=d,h=g,p=v,pe.push([l,h,p]),l=X,h=j,p=W,pe.push([l,h,p]),r.push(pe),(pe=[]).push([l=$,h=G,p=Q]),l=X,h=j,p=W,pe.push([l,h,p]),l=y,h=b,p=x,pe.push([l,h,p]),r.push(pe),(pe=[]).push([l=Y,h=H,p=q]),l=X,h=j,p=W,pe.push([l,h,p]),l=$,h=G,p=Q,pe.push([l,h,p]),r.push(pe);break;case 4:$=(y+R)/2,G=(b+M)/2,Q=(x+A)/2,Z=(R+f)/2,K=(M+u)/2,J=(A+m)/2,void 0!==I&&(oe=(U+S)/2,ne=(C+B)/2,se=(S+I)/2,ie=(B+k)/2,ue=(I+F+U+S)/4,me=(k+z+C+B)/4,l=I,h=k,fe.push([l,h]),l=ee,h=ae,fe.push([l,h]),l=ue,h=me,fe.push([l,h]),l=se,h=ie,fe.push([l,h]),o.push(fe),(fe=[]).push([l=ee,h=ae]),l=F,h=z,fe.push([l,h]),l=te,h=re,fe.push([l,h]),l=ue,h=me,fe.push([l,h]),o.push(fe),(fe=[]).push([l=ue,h=me]),l=te,h=re,fe.push([l,h]),l=U,h=C,fe.push([l,h]),l=oe,h=ne,fe.push([l,h]),o.push(fe),(fe=[]).push([l=se,h=ie]),l=ue,h=me,fe.push([l,h]),l=oe,h=ne,fe.push([l,h]),l=S,h=B,fe.push([l,h]),o.push(fe)),ce=(f+d+y+R)/4,le=(u+g+b+M)/4,he=(m+v+x+A)/4,l=f,h=u,p=m,pe.push([l,h,p]),l=Y,h=H,p=q,pe.push([l,h,p]),l=ce,h=le,p=he,pe.push([l,h,p]),l=Z,h=K,p=J,pe.push([l,h,p]),r.push(pe),(pe=[]).push([l=Y,h=H,p=q]),l=d,h=g,p=v,pe.push([l,h,p]),l=X,h=j,p=W,pe.push([l,h,p]),l=ce,h=le,p=he,pe.push([l,h,p]),r.push(pe),(pe=[]).push([l=ce,h=le,p=he]),l=X,h=j,p=W,pe.push([l,h,p]),l=y,h=b,p=x,pe.push([l,h,p]),l=$,h=G,p=Q,pe.push([l,h,p]),r.push(pe),(pe=[]).push([l=Z,h=K,p=J]),l=ce,h=le,p=he,pe.push([l,h,p]),l=$,h=G,p=Q,pe.push([l,h,p]),l=R,h=M,p=A,pe.push([l,h,p]),r.push(pe);break;case 5:ce=(f+d+y+R+E)/5,le=(u+g+b+M+T)/5,he=(m+v+x+A+w)/5,void 0!==I&&(ue=(I+F+U+S+O)/5,me=(k+z+C+B+V)/5,oe=(U+S)/2,ne=(C+B)/2,se=(S+O)/2,ie=(B+V)/2,(O+I)/2,(V+k)/2,l=I,h=k,fe.push([l,h]),l=F,h=z,fe.push([l,h]),l=ue,h=me,fe.push([l,h]),o.push(fe),(fe=[]).push([l=F,h=z]),l=U,h=C,fe.push([l,h]),l=ue,h=me,fe.push([l,h]),o.push(fe),(fe=[]).push([l=U,h=C]),l=S,h=B,fe.push([l,h]),l=ue,h=me,fe.push([l,h]),o.push(fe),(fe=[]).push([l=S,h=B]),l=O,h=V,fe.push([l,h]),l=ue,h=me,fe.push([l,h]),o.push(fe),(fe=[]).push([l=O,h=V]),l=I,h=k,fe.push([l,h]),l=ue,h=me,fe.push([l,h]),o.push(fe),fe=[]),$=(y+R)/2,G=(b+M)/2,Q=(x+A)/2,Z=(R+E)/2,K=(M+T)/2,J=(A+w)/2,(E+f)/2,(T+u)/2,(w+m)/2,l=f,h=u,p=m,pe.push([l,h,p]),l=d,h=g,p=v,pe.push([l,h,p]),l=ce,h=le,p=he,pe.push([l,h,p]),r.push(pe),(pe=[]).push([l=d,h=g,p=v]),l=y,h=b,p=x,pe.push([l,h,p]),l=ce,h=le,p=he,pe.push([l,h,p]),r.push(pe),(pe=[]).push([l=y,h=b,p=x]),l=R,h=M,p=A,pe.push([l,h,p]),l=ce,h=le,p=he,pe.push([l,h,p]),r.push(pe),(pe=[]).push([l=R,h=M,p=A]),l=E,h=T,p=w,pe.push([l,h,p]),l=ce,h=le,p=he,pe.push([l,h,p]),r.push(pe),(pe=[]).push([l=E,h=T,p=w]),l=f,h=u,p=m,pe.push([l,h,p]),l=ce,h=le,p=he,pe.push([l,h,p]),r.push(pe),pe=[];break;case 6:ce=(f+d+y+R+E)/5,le=(u+g+b+M+T)/5,he=(m+v+x+A+w)/5,void 0!==I&&(ue=(I+F+U+S+O+D)/6,me=(k+z+C+B+V+N)/6,oe=(U+S)/2,ne=(C+B)/2,se=(S+O)/2,ie=(B+V)/2,(O+D)/2,(V+N)/2,(D+I)/2,(N+k)/2,l=I,h=k,fe.push([l,h]),l=F,h=z,fe.push([l,h]),l=ue,h=me,fe.push([l,h]),o.push(fe),(fe=[]).push([l=F,h=z]),l=U,h=C,fe.push([l,h]),l=ue,h=me,fe.push([l,h]),o.push(fe),(fe=[]).push([l=U,h=C]),l=S,h=B,fe.push([l,h]),l=ue,h=me,fe.push([l,h]),o.push(fe),(fe=[]).push([l=S,h=B]),l=O,h=V,fe.push([l,h]),l=ue,h=me,fe.push([l,h]),o.push(fe),(fe=[]).push([l=O,h=V]),l=D,h=N,fe.push([l,h]),l=ue,h=me,fe.push([l,h]),o.push(fe),(fe=[]).push([l=D,h=N]),l=I,h=k,fe.push([l,h]),l=ue,h=me,fe.push([l,h]),o.push(fe),fe=[]),$=(y+R)/2,G=(b+M)/2,Q=(x+A)/2,Z=(R+E)/2,K=(M+T)/2,J=(A+w)/2,(E+P)/2,(T+_)/2,(w+L)/2,(P+f)/2,(_+u)/2,(L+m)/2,(pe=[]).push([l=f,h=u,p=m]),l=d,h=g,p=v,pe.push([l,h,p]),l=ce,h=le,p=he,pe.push([l,h,p]),r.push(pe),(pe=[]).push([l=d,h=g,p=v]),l=y,h=b,p=x,pe.push([l,h,p]),l=ce,h=le,p=he,pe.push([l,h,p]),r.push(pe),(pe=[]).push([l=y,h=b,p=x]),l=R,h=M,p=A,pe.push([l,h,p]),l=ce,h=le,p=he,pe.push([l,h,p]),r.push(pe),(pe=[]).push([l=R,h=M,p=A]),l=E,h=T,p=w,pe.push([l,h,p]),l=ce,h=le,p=he,pe.push([l,h,p]),r.push(pe),(pe=[]).push([l=E,h=T,p=w]),l=P,h=_,p=L,pe.push([l,h,p]),l=ce,h=le,p=he,pe.push([l,h,p]),r.push(pe),(pe=[]).push([l=P,h=_,p=L]),l=f,h=u,p=m,pe.push([l,h,p]),l=ce,h=le,p=he,pe.push([l,h,p]),r.push(pe),pe=[]}}));return r.map(((e,a)=>({verts:e,uvs:o[a]})))},W=(e,a,t,r,o)=>{let s,i,c,l,h,p,f,u,m,d,g,v,y,b,x=Array(r).fill().map((e=>(s=n()-.5,i=n()-.5,c=n()-.5,[s,i,c])));for(let e=50;e--;)x.map(((e,a)=>{s=e[0],i=e[1],c=e[2],x.map(((e,t)=>{t!=a&&(f=e[0],u=e[1],m=e[2],g=1+(Math.hypot(s-f,i-u,c-m)*(3+r/80)*3)**3,s+=9*(s-f)/g,i+=9*(i-u)/g,c+=9*(c-m)/g)})),g=Math.hypot(s,i,c),e[0]=s/g,e[1]=i/g,e[2]=c/g}));return d=6e6,x.map(((e,a)=>{l=e[0],h=e[1],p=e[2],x.map(((e,t)=>{f=e[0],u=e[1],m=e[2],a!=t&&(g=Math.hypot(v=l-f,y=h-u,b=p-m),g<d&&(d=g))}))})),v=[],x.map(((e,a)=>{l=e[0],h=e[1],p=e[2],x.map(((e,t)=>{f=e[0],u=e[1],m=e[2],a!=t&&(g=Math.hypot(l-f,h-u,p-m),g<2*d&&(v.filter((e=>e[0]==f&&e[1]==u&&e[2]==m&&e[3]==l&&e[4]==h&&e[5]==p)).length||v.push([l*o,h*o,p*o,f*o,u*o,m*o])))}))})),x.map((r=>{r[0]*=o/1.3333,r[1]*=o/1.3333,r[2]*=o/1.3333,r[0]+=e,r[1]+=a,r[2]+=t})),[e,a,t,o,x,v]},$=(e=1,a=0,t,n,s=0,i=!1,c="cylinder")=>{for(var l,h,p,f,u,m,d,g,v,y,b,x,R,M,A,E,T,w,P,_,L=[],I=[],k=0;k<t;k++)for(var F=k,z=.5,U=0;U<n;U++){l=r(2*Math.PI/n*U)*z,h=1/t*F-.5,p=o(2*Math.PI/n*U)*z,f=r(2*Math.PI/n*(U+1))*z,u=1/t*F-.5,m=o(2*Math.PI/n*(U+1))*z,d=r(2*Math.PI/n*(U+1))*z,g=1/t*(F+1)-.5,v=o(2*Math.PI/n*(U+1))*z,y=r(2*Math.PI/n*U)*z,b=1/t*(F+1)-.5,x=o(2*Math.PI/n*U)*z;var C=Math.atan2(l,p),S=Math.atan2(f,m),B=Math.atan2(d,v),O=Math.atan2(y,x);Math.abs(C-S)>Math.PI&&(C-=2*Math.PI,O-=2*Math.PI),R=(C+Math.PI)/Math.PI/2,M=h+.5,A=(S+Math.PI)/Math.PI/2,E=u+.5,T=(B+Math.PI)/Math.PI/2,w=g+.5,P=(O+Math.PI)/Math.PI/2,_=b+.5,L.push([[l,h,p],[f,u,m],[d,g,v],[y,b,x]]),I.push([[R,M],[A,E],[T,w],[P,_]])}return X(L,I,1,a,s,i,!0,c)},G=async(e=1,a=0,t=0,n=!1,s="torus",i,c)=>{for(var l,h,p,f,u,m,d,g,v,y,b,x,R,M,A,E,T,w,P,_,L,I,k,F,z=[],U=[],C=4*i,S=1/6,B=2/6,O=0;O<C;O++)for(var V=O+.5,D=0;D<c;D++){l=r(k=2*Math.PI/c*(D-1))*S+B,h=o(k)*S,0,k=Math.atan2(l,0)+2*Math.PI/C*V+Math.PI/2,F=Math.hypot(l,0),p=r(k)*F,f=h,u=o(k)*F,l=r(k=2*Math.PI/c*D)*S+B,h=o(k)*S,k=Math.atan2(l,0)+2*Math.PI/C*V+Math.PI/2,F=Math.hypot(l,0),m=r(k)*F,d=h,g=o(k)*F,l=r(k=2*Math.PI/c*D)*S+B,h=o(k)*S,k=Math.atan2(l,0)+2*Math.PI/C*(V+1)+Math.PI/2,F=Math.hypot(l,0),v=r(k)*F,y=h,b=o(k)*F,l=r(k=2*Math.PI/c*(D-1))*S+B,h=o(k)*S,k=Math.atan2(l,0)+2*Math.PI/C*(V+1)+Math.PI/2,F=Math.hypot(l,0),x=r(k)*F,R=h,M=o(k)*F;var N=Math.atan2(p,u),Y=Math.atan2(m,g),H=Math.atan2(v,b),q=Math.atan2(x,M);Math.abs(N-H)>Math.PI&&(H+=2*Math.PI,q+=2*Math.PI),A=(N+Math.PI)/Math.PI/2,E=f+.5,T=(Y+Math.PI)/Math.PI/2,w=d+.5,P=(H+Math.PI)/Math.PI/2,_=y+.5,L=(q+Math.PI)/Math.PI/2,I=R+.5,z.push([[p,f,u],[x,R,M],[v,y,b],[m,d,g]]),U.push([[A,E],[T,w],[P,_],[L,I]])}return X(z,U,e,a,t,n,!0,s)},Q=async(e=1,a=0,t,n,s=0,i=!1,c="torus knot")=>{var l,h,p,f,u,m,d,g,v=[],y=[];y=[],d=[],n*=4,t*=2;for(var b=1/3,x=0;x<2*n;x++)for(var R=0;R<t+1;R++)l=1+r(u=2*Math.PI/t*R)/4+r(m=2*Math.PI*1.5/n*x)*b,h=o(u)/4,p=0,g=Math.atan2(h,p)+r(m),f=Math.hypot(h,p),h=r(g)*f+o(m)*b*2,p=o(g)*f,u=Math.atan2(l,p)+2*Math.PI/n*x,f=Math.hypot(l,p),l=r(u)*f,p=o(u)*f,y.push([l,h,p]),l=1+r(u=2*Math.PI/t*R)/4+r(m=2*Math.PI*1.5/n*(x+1))*b,h=o(u)/4,p=0,g=Math.atan2(h,p)+r(m),f=Math.hypot(h,p),h=r(g)*f+o(m)*b*2,p=o(g)*f,u=Math.atan2(l,p)+2*Math.PI/n*(x+1),f=Math.hypot(l,p),l=r(u)*f,p=o(u)*f,d.push([l,h,p]);y.forEach(((a,r)=>{if(r%(t+1)!=t){var o=(r+1)%y.length,n=y[r][0]*e/3.2,s=y[r][1]*e/3.2,i=y[r][2]*e/3.2,c=d[r][0]*e/3.2,l=d[r][1]*e/3.2,h=d[r][2]*e/3.2,p=d[o][0]*e/3.2,f=d[o][1]*e/3.2,u=d[o][2]*e/3.2,m=y[o][0]*e/3.2,g=y[o][1]*e/3.2,b=y[o][2]*e/3.2;v.push([[n,s,i],[c,l,h],[p,f,u],[m,g,b]])}}));var M,A,E=v,T=[];for(R=0;R<E.length;R++){y=[];for(var w=E[R].length;w--;){switch(w){case 0:M=0,A=0;break;case 1:M=1,A=0;break;case 2:M=1,A=1;break;case 3:M=0,A=.5;break;case 4:M=0,A=1}y.push([M,A])}T.push(y)}return X(v,T,1,a,s,i,!0,c)},Z=async(e=1,a=0,t=0,n=!1,s="tetrahedron")=>{var i,c,l,h,p,f,u,m,d,g,v,y,b,x=[];y=[];let R=1/1.4142/1.75;for(g=0;g<3;g++)i=1*r(h=2*Math.PI/3*g)/1.75,c=1*o(h)/1.75,l=R,y.push([i,c,l]);for(x.push(y),v=3;v--;)(y=[]).push([i=0,c=0,l=-R]),i=1*r(h=2*Math.PI/3*v)/1.75,c=1*o(h)/1.75,l=R,y.push([i,c,l]),i=1*r(h=2*Math.PI/3*(v-1))/1.75,c=1*o(h)/1.75,l=R,y.push([i,c,l]),x.push(y);u=m=d=b=0,x.map((e=>{e.map((e=>{u+=e[0],m+=e[1],d+=e[2],b++}))})),u/=b,m/=b,d/=b,x.map((e=>{e.map((e=>{e[0]-=u,e[1]-=m,e[2]-=d}))}));var M=x,A=[];for(g=0;g<M.length;g++){y=[];for(var E=M[g].length;E--;){switch(E){case 0:p=0,f=0;break;case 1:p=1,f=0;break;case 2:p=1,f=1;break;case 3:p=0,f=.5;break;case 4:p=0,f=1}y.push([p,f])}A.push(y)}return X(M,A,1,a,t,n,!1,s)},K=async(e=1,a=0,t=0,n=!1,s="octahedron")=>{var i,c,l,h,p,f,u,m,d,g=[];for(m=8;m--;)d=[],i=0,c=0,m<4?(l=.5,d.push([i,c,l]),i=1*r(h=2*Math.PI/4*m)/2,c=1*o(h)/2,l=0,d.push([i,c,l]),i=1*r(h=2*Math.PI/4*(m+1))/2,c=1*o(h)/2):(l=-.5,d.push([i,c,l]),i=1*r(h=2*Math.PI/4*m)/2,c=1*o(h)/2,l=0,d.push([i,c,l]),i=1*r(h=2*Math.PI/4*(m-1))/2,c=1*o(h)/2),l=0,d.push([i,c,l]),g.push(d);var v=g,y=[];for(u=0;u<v.length;u++){d=[];for(var b=v[u].length;b--;){switch(b){case 0:p=0,f=0;break;case 1:p=1,f=0;break;case 2:p=1,f=1;break;case 3:p=0,f=.5;break;case 4:p=0,f=1}d.push([p,f])}y.push(d)}return X(v,y,1,a,t,n,!1,s)},J=async(e=1,a=0,t=0,r=!1,o="icosahedron")=>{var n,s,i,c,l,h,p,f,u,m,d,g,v,y,b,x=[];for(f=[[-(p=.5+5**.5/2),-1,0],[p,-1,0],[p,1,0],[-p,1,0]],h=3;h--;x.push(s))for(s=[],n=4;n--;)s.push([f[n][h],f[n][(h+1)%3],f[n][(h+2)%3]]);x.map((a=>{a.map((a=>{a[0]*=1/2.25*e*.7,a[1]*=1/2.25*e*.7,a[2]*=1/2.25*e*.7}))})),u=JSON.parse(JSON.stringify(x)),l=[],f=[],[[[0,3],[1,0],[2,2]],[[1,3],[1,0],[0,3]],[[0,3],[2,3],[1,3]],[[0,2],[2,1],[1,0]],[[1,0],[1,3],[0,2]],[[0,2],[1,3],[2,0]],[[0,3],[2,2],[0,0]],[[2,1],[2,2],[1,0]],[[1,1],[2,2],[2,1]],[[0,0],[2,2],[1,1]],[[1,1],[2,1],[0,1]],[[0,1],[2,1],[0,2]],[[2,3],[1,2],[2,0]],[[2,3],[0,3],[0,0]],[[2,3],[2,0],[1,3]],[[2,3],[0,0],[1,2]],[[0,1],[2,0],[1,2]],[[1,1],[1,2],[0,0]],[[0,1],[1,2],[1,1]],[[0,2],[2,0],[0,1]]].map(((e,a)=>{m=e[0][0],d=e[1][0],g=e[2][0],v=e[0][1],y=e[1][1],b=e[2][1],f.push([u[g][b],u[d][y],u[m][v]])})),l.push(...f);var R=l,M=[];for(n=0;n<R.length;n++){f=[];for(var A=R[n].length;A--;){switch(A){case 0:i=0,c=0;break;case 1:i=1,c=0;break;case 2:i=1,c=1;break;case 3:i=0,c=.5;break;case 4:i=0,c=1}f.push([i,c])}M.push(f)}return X(R,M,1,a,t,r,!1,o)},ee=async(e=1,a=0,t=0,n=!1,s="dodecahedron")=>{var i,c,l,h,p,f,u,m,d,g,v=[],y=[];let b=-6e6;for(g=5;g--;)i=r(f=2*Math.PI/5*g+Math.PI/5),c=o(f),l=0,c>b&&(b=c),y.push([i,c,l]);y=y.map((e=>(i=e[0],c=e[1]-=b,l=e[2],R(i,c,l,{x:0,y:0,z:0,roll:0,pitch:.553573,yaw:0})))),(p=structuredClone(y)).map((e=>{var a=Math.atan2(e[0],e[1])+Math.PI,t=Math.hypot(e[0],e[1]);e[0]=r(a)*t,e[1]=o(a)*t})),v.push(y,p),b=-6e6,v.map((e=>{e.map((e=>{i=e[0],c=e[1],(l=e[2])>b&&(b=l)}))})),h=Math.hypot(v[0][0][0]-v[0][1][0],v[0][0][1]-v[0][1][1],v[0][0][2]-v[0][1][2]),v.map((e=>{e.map((e=>{e[2]-=b+h/2}))})),(p=structuredClone(v)).map((e=>{e.map((e=>{var a=Math.atan2(e[0],e[2])+Math.PI,t=Math.hypot(e[0],e[2]);e[0]=r(a)*t,e[2]=o(a)*t}))})),v.push(...p),(p=structuredClone(v)).map((e=>{e.map((e=>{i=e[0],c=e[1],l=e[2],u=M(i,c,l,{x:0,y:0,z:0,roll:0,pitch:Math.PI/2,yaw:Math.PI/2}),e[0]=u[0],e[1]=u[1],e[2]=u[2]}))})),(x=structuredClone(v)).map((e=>{e.map((e=>{i=e[0],c=e[1],l=e[2],u=M(i,c,l,{x:0,y:0,z:0,roll:Math.PI/2,pitch:0,yaw:Math.PI/2}),e[0]=u[0],e[1]=u[1],e[2]=u[2]}))})),v.push(...p,...x);var x=v.map(((e,a)=>e.map(((a,t)=>{var r=t;return[e[r][0],e[r][1],e[r][2]]})))),A=[];for(g=0;g<x.length;g++){y=[];for(var E=x[g].length;E--;){switch(E){case 0:m=0,d=0;break;case 1:m=1,d=0;break;case 2:m=1,d=1;break;case 3:m=0,d=.5;break;case 4:m=0,d=1}y.push([m,d])}A.push(y)}return X(x,A,e/Math.max(1,2-t)/1.5,a,t,n,!1,s)},ae=(e=1,a=0,t=0,n=!1,s="cube")=>{var i,c,l,h,p,f,u,m,d=Math.PI,g=[];for(p=6;p--;g.push(l))for(l=[],f=4;f--;)p<3?l.push([(c=[r(i=2*d/4*f+d/4),o(i),2**.5/2])[(p+0)%3]*(h=2**.5/2),c[(p+1)%3]*h,c[(p+2)%3]*h]):l.push([(c=[r(i=2*d/4*f+d/4),o(i),2**.5/2])[(p+2)%3]*(h=-(2**.5)/2),c[(p+1)%3]*h,c[(p+0)%3]*h]);var v=[];for(p=0;p<g.length;p++){c=[];for(var y=g[p].length;y--;){switch(y){case 0:u=0,m=0;break;case 1:u=1,m=0;break;case 2:u=1,m=1;break;case 3:u=0,m=1}c.push([u,m])}v.push(c)}return X(g,v,e,a,t,n,!0,s)},te=async(e=1,a=0,t=0,r=!1,o="rectangle")=>{Math.PI;return X([[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]]],[[[0,0],[1,0],[1,1],[0,1]]],e/1.5,Math.max("sprite"==o?0:2,a),"sprite"==o||"point light"==o?0:t,r,!0,o)},re=async e=>{await f({attachToBody:!1,width:85,height:85,context:{mode:"2d",options:{willReadFrequently:!0}}}).then((a=>{var t=[],r=a.c,o=a.ctx;o.font=64+"px courier new",o.textAlign="left";for(var n=6e6,s=-6e6,i=33;i<127;i++)switch(i){case 35:case 96:break;default:o.fillStyle="#000",o.fillRect(0,0,r.width,r.height),o.fillStyle="#fff";var c=String.fromCharCode(i);o.fillText(c,5,64);for(var l=o.getImageData(0,0,r.width,r.height),h=0,p=0,f=0;f<l.data.length;f+=4){p+=(l.data[f+0]+l.data[f+1]+l.data[f+2])/3/256>=.5?1:0,h++}(p/=h)<n&&(n=p),p>s&&(s=p),t.push({chr:c,cumlum:p})}var u=s-n;t.map((e=>{e.cumlum-=n,e.cumlum/=u})),t.sort(((e,a)=>e.cumlum-a.cumlum)),e.glyphLuminosities=t,e.glyphScratchCanvas=a}))},oe=(e,a={})=>{if(void 0===e.glyphLuminosities&&re(e),void 0!==e.glyphScratchCanvas){var t=Ue,r=t.ctx,o=10,n=!1,s=!1,i=!1,c=!1,l=65348,h="#000000",p=!0;if(void 0===e?.hasOutputtedASCII&&(e.hasOutputtedASCII=!1),Object.keys(a).forEach((e=>{switch(e.toLowerCase()){case"monochrome":n=!!a[e];break;case"outputtoconsole":s=!!a[e];break;case"outputtoconsoleonce":i=!!a[e];break;case"colorizeoutput":c=!!a[e];break;case"monochromecolor":l=a[e];break;case"fontsize":o=a[e];break;case"backcolor":h="#"+(+a[e]).toString(16);break;case"opaquebackground":p=a[e]}})),h.length<7){var f=h.split("");f.shift();var u="";f.forEach((e=>u+=e)),f=u;for(var m=0;m<7-h.length;m++)f="0"+f;h="#"+f}var d=e.glyphScratchCanvas.c,g=e.glyphScratchCanvas.ctx,v=.1/(o**.45/2.5);d.width=t.c.width*v|0,d.height=t.c.height*v|0;var y=t.c.height/(t.c.height/d.height)/16*(t.c.width<1e3?1:2)/10*o;p?(r.fillStyle=h,r.fillRect(0,0,t.c.width,t.c.height)):r.clearRect(0,0,t.c.width,t.c.height),r.font=y+"px courier new",g.drawImage(e.c,0,0,d.width,d.height);var b=g.getImageData(0,0,d.width,d.height);if(n)var x=256*(j=_e(l))[0],R=256*j[1],M=256*j[2];for(var A="",E=" ",T="",w="",P="",_=6e6,L=!1,I=!1,k=0;k<b.data.length;k+=4){var F=b.data[k+0],z=b.data[k+1],U=b.data[k+2],C=(F+z+U)/3/256;if(C>.025){var S=k/4,B=S%d.width,O=S/d.width|0,V=6e6,D=-1;e.glyphLuminosities.forEach(((e,a)=>{var t=Math.abs(e.cumlum-C);t<V&&(V=t,D=a)})),r.fillStyle=n?`rgb(${64+C*x*.75}, ${64+C*R*.75}, ${64+C*M*.75})`:`rgb(${64+.75*F}, ${64+.75*z}, ${64+.75*U})`;var N=e.glyphLuminosities[D].chr;if(r.fillText(N,B/d.width*t.c.width/1,O/d.height*t.c.height/1+y/1.5),w+=N+N,c){var Y,H=n?ve(x,R,M):ve(F,z,U),q=H[2]**.6-H[1]/2.6;if(q>=.25&&q<.75){for(H[0]*=1.2,H[0]-=20;H[0]<0;)H[0]+=360;switch(H[0]=+H[0]%360,H[0]/360*7|0){case 6:Y=q>=.5?"04":"05";break;case 0:Y="07";break;case 1:Y=q>=.5?"08":"07";break;case 2:Y=q>=.5?"09":"03";break;case 3:Y=q>=.5?"11":"10";break;case 4:Y=q>=.5?"12":"02";break;case 5:Y=q>=.5?"13":"06"}}else Y=q<.25?q<.125?1:14:q>.8625?0:15;P+=String.fromCharCode(3)+Y+N+N}}else w+=E.repeat(2),P+=E.repeat(2);if(!((k/4+1)%d.width)){var X=-1;w.split("").forEach(((e,a)=>{-1==X&&e!=E&&(X=a)})),-1!=X&&X<_&&(_=X),L?(A+=w+"\n",T+=P+"\n"):w.split("").filter((e=>e==E)).length!=w.length&&(A+=w+"\n",T+=P+"\n",L=!0),w="",P=""}}if(A.length){var j,W="";for(m=(j=(c?T:A).split("\n")).length;m--;)I?W=j[m]+"\n"+W:j[m].split(E).length!=j[m].length+1&&(W=j[m],I=!0);var $=W.split("\n").map((e=>e.substr(_).trimRight())).join("\n").replaceAll("%%","%%%%");return(s||i&&!e.hasOutputtedASCII)&&(e.hasOutputtedASCII=!0,console.log($)),$}}},ne=(e,a=0)=>!(a>300)&&(2==e||ne(e/2,a+1)),se=(e,a,t,n,s,i,c,l=!1)=>{let h,p,f,u,m,d,g,v,y,b=(e,a,t,r,o,n,s,i)=>(d=((s-o)*(a-n)-(i-n)*(e-o))/(g=(i-n)*(t-e)-(s-o)*(r-a)))>=0&&d<=1&&(v=((t-e)*(a-n)-(r-a)*(e-o))/g)>=0&&v<=1?[e+d*(t-e),a+d*(r-a)]:0,x=(e,a,t,n)=>{let s=Math,i=s.atan2,c=s.hypot;h=r(y=i(h,p)+e)*(u=c(h,p)),p=o(y)*u,h=r(y=i(h,f)+t)*(u=c(h,f)),f=o(y)*u,p=r(y=i(p,f)+a)*(u=c(p,f)),f=o(y)*u,n&&(h+=oX,p+=oY,f+=oZ)},R=e=>{switch(e){case 0:x(0,0,Math.PI/2);break;case 1:x(0,Math.PI/2,0);break;case 2:x(Math.PI/2,0,Math.PI/2)}},M=0,A=0,E=0;c.map((e=>{M+=e[0],A+=e[1],E+=e[2]})),M/=c.length,A/=c.length,E/=c.length;let T=c[2][0]-c[1][0],w=c[2][1]-c[1][1],P=c[2][2]-c[1][2],_=c[1][0]-c[0][0],L=c[1][1]-c[0][1],I=c[1][2]-c[0][2],k=[w*I-P*L,P*_-T*I,T*L-w*_];u=Math.hypot(...k)+.001;k=k.map((e=>e/u*1));let F=M,z=A,U=E,C=1;if(l){let r=Math.hypot(F-e,z-a,U-t);C=Math.hypot(e-(M+k[0]/99),a-(A+k[1]/99),t-(E+k[2]/99))>r?-1:1}let S=M+(k[0]*=C),B=A+(k[1]*=C),O=E+(k[2]*=C),V=Math.atan2(S-F,O-U),D=-(Math.acos((B-z)/(Math.hypot(S-F,B-z,O-U)+.001))+Math.PI/2),N=!1,Y=[!1,!1,!1];h=e,p=a,f=t,x(0,-D,-V);let H=h,q=p,X=f;for(let e=3;e--;)!1===N&&(h=H,p=q,f=X,R(e),F=h,z=p,U=f=5,h=n,p=s,f=i,x(0,-D,-V),R(e),S=h,B=p,O=f,c.map(((a,t)=>{if(!1===N){let a=t;h=c[a][0],p=c[a][1],f=c[a][2],x(0,-D,-V),R(e);let r=h,o=p;a=(t+1)%c.length,h=c[a][0],p=c[a][1],f=c[a][2],x(0,-D,-V),R(e);(m=b(F,z,S,B,r,o,h,p))&&(Y[e]=m)}})));if(3==Y.filter((e=>!1!==e)).length){let e=Y[1][0],a=Y[0][1],t=Y[0][0],r=!0;M=0,A=0,E=0,c.map(((e,a)=>{M+=e[0],A+=e[1],E+=e[2]})),M/=c.length,A/=c.length,E/=c.length,h=M,p=A,f=E,x(0,-D,-V),F=h,z=p,U=f,S=e,B=a,O=t,c.map(((e,a)=>{if(r){let e=a;h=c[e][0],p=c[e][1],f=c[e][2],x(0,-D,-V);let t=h,o=p;e=(a+1)%c.length,h=c[e][0],p=c[e][1],f=c[e][2],x(0,-D,-V);b(F,z,S,B,t,o,h,p)&&(r=!1)}})),r&&(h=e,p=a,f=t,x(0,D,0),x(0,0,V),N=[[h,p,f],[k[0],k[1],k[2]]])}return N},ie=async(e,a)=>{var t,r=[],o=a.omitShape;(a.omitShape=!0,a.geometryData.map((async t=>{var o,n,s,i,c,l,h=t[0][0],p=t[0][1],f=t[0][2],u=t[1][0],m=t[1][1],d=t[1][2];"horizontal"!=a.alignment&&(Math.abs(u-h)>Math.abs(m-p)||"vertical"==a.alignment)?(o=h,n=(p+m)/2,s=(f+d)/2,i=u,c=(p+m)/2,l=(f+d)/2):(o=(h+u)/2,n=p,s=(f+d)/2,i=(h+u)/2,c=m,l=(f+d)/2),a.geometryData=[[h,-p,f],[o,-n,s],[i,-c,l],[u,-m,d]],await ce(e,a).then((e=>{r.push(...e.curve)}))})),o)||(a.shapeType="lines",a.geometryData=r,k(e,a).then((e=>{t=e})),r=t);return r},ce=async(e,a)=>{var t=[],r=10;void 0!==a&&Object.keys(a).forEach(((e,t)=>{if("steps"===e.toLowerCase())r=Math.floor(a[e])}));var o,n,s,i=structuredClone(a.geometryData);o=i[0][0]-(i[1][0]-i[0][0]),n=i[0][1]-(i[1][1]-i[0][1]),s=i[0][2]-(i[1][2]-i[0][2]),i[0][0]=o,i[0][1]=n,i[0][2]=s;var c=i.length-1;o=i[c][0]+(i[c][0]-i[c-1][0]),n=i[c][1]+(i[c][1]-i[c-1][1]),s=i[c][2]+(i[c][2]-i[c-1][2]),i[c][0]=o,i[c][1]=n,i[c][2]=s,i.map(((e,a)=>{var o=e[0],n=e[1],s=e[2];if(a<i.length-2){var c=a+1,l=a+2,h=i[c][0],p=i[c][1],f=i[c][2],u=i[l][0],m=i[l][1],d=i[l][2],g=(o+h)/2,v=(n+p)/2,y=(s+f)/2,b=(h+u)/2,x=(p+m)/2,R=(f+d)/2;t.push([g,v,y]),a==i.length-3&&t.push([b,x,R]);for(var M=0;M<r+1;M++);}}));var l,h=[];return i.map(((e,a)=>{var o=e[0],n=e[1],s=e[2];if(a<i.length-2){var c=a+1,l=a+2,p=i[c][0],f=i[c][1],u=i[c][2],m=(o+p)/2,d=(n+f)/2,g=(s+u)/2,v=(p+i[l][0])/2,y=(f+i[l][1])/2,b=(u+i[l][2])/2;t.push([m,d,g]);for(var x=m,R=d,M=g,A=0;A<r+1;A++){if(A){var E=fe(m+(p-m)/r*A,d+(f-d)/r*A,p+(v-p)/r*A,f+(y-f)/r*A,m+(p-m)/r*(A+1),d+(f-d)/r*(A+1),p+(v-p)/r*(A+1),f+(y-f)/r*(A+1));A<r&&(E?(h.push([x,R,M],[...E,0]),x=E[0],R=E[1],M=0):(h.push([x,R,M],[v,y,b]),x=v,R=y,M=b)),A>=r&&h.push([x,R,M],[v,y,0])}}}})),a.omitShape?{curve:h,midPoints:t,controlPoints:i}:(a.shapeType="lines",a.geometryData=h,k(e,a).then((async e=>l=e)),{curve:h,shape:l,midPoints:t,controlPoints:i})},le=(e,a=16777215,t=.25,n=!1,s=1,i=1,c)=>{var l,h,p,f,u=!n;void 0===c&&(c=e.renderer);var m=8/(1+(i=Math.max(.01,Math.min(4,i))))+1,d=1500/c.fov*5.6666;if(void 0===c.glowShape){var g={shapeType:"custom shape",geometryData:{vertices:Array(3e3).fill(1e5)}};k(c,g).then((async e=>{c.glowShape=e}))}if(void 0!==c.glowShape&&void 0!==c.glowShape.vertices){var v=e.renderer.width/e.renderer.height,y=c.x,b=c.y,x=c.z,R=c.roll,M=c.pitch,A=c.yaw,E=O(e,e.renderer,!1);if(c.x=0,c.y=0,c.z=0,c.roll=0,c.pitch=0,c.yaw=0,E.length){for(var T=0,w=0;w<c.glowShape.vertices.length;w+=3)c.glowShape.vertices[w+0]=1e5,c.glowShape.vertices[w+1]=1e5,c.glowShape.vertices[w+2]=1e5;var P=[],_=0,L=0,I=0;do{if(T<E.length){var F=(E[T][0]/e.renderer.width-.5)*d,z=(1-E[T][1]/e.renderer.height-.5)/v*d,U=(E[T+1][0]/e.renderer.width-.5)*d,C=(1-E[T+1][1]/e.renderer.height-.5)/v*d,S=Math.hypot(U-F,C-z),B=Math.max(1,Math.min(100,S*m));for(w=0;w<B;w++)l=F+(U-F)/B*w,h=z+(C-z)/B*w,p=0/B*w-1,P.push([l,h,p]),_+=l,L+=h,I+=Math.hypot(e.x-e.renderer.x,e.y-e.renderer.y,e.z-e.renderer.z)}T++}while(T<E.length-1&&T<100);if(P.length){var V,D,N,Y=Le(a),H=ve(256*Y[0]|0,256*Y[1]|0,256*Y[2]|0);_/=P.length,L/=P.length,I/=P.length,s=10*s/(1+Math.hypot(e.x-y,e.y-b,e.z-x)),i*=16;for(var q=10,X=0;X<i;X++){var j=s/i*X/(1+I);P.map(((e,a)=>{B=(a+1)%P.length,f=Math.atan2(P[B][0]-_,P[B][1]-L),S=Math.hypot(P[B][0]-_,P[B][1]-L),V=l=P[B][0]+r(f)*j,D=h=P[B][1]+o(f)*j,N=p=P[B][2],c.glowShape.vertices[18*a+0]=l/q,c.glowShape.vertices[18*a+1]=h/q,c.glowShape.vertices[18*a+2]=p/q,l=u?P[B][0]:_,h=u?P[B][1]:L,p=e[2],c.glowShape.vertices[18*a+3]=l/q,c.glowShape.vertices[18*a+4]=h/q,c.glowShape.vertices[18*a+5]=p/q,B=a,l=u?P[B][0]:_,h=u?P[B][1]:L,p=e[2],c.glowShape.vertices[18*a+6]=l/q,c.glowShape.vertices[18*a+7]=h/q,c.glowShape.vertices[18*a+8]=p/q,c.glowShape.vertices[18*a+9]=l/q,c.glowShape.vertices[18*a+10]=h/q,c.glowShape.vertices[18*a+11]=p/q,f=Math.atan2(P[B][0]-_,P[B][1]-L),S=Math.hypot(P[B][0]-_,P[B][1]-L),l=P[B][0]+r(f)*j,h=P[B][1]+o(f)*j,p=P[B][2],c.glowShape.vertices[18*a+12]=l/q,c.glowShape.vertices[18*a+13]=h/q,c.glowShape.vertices[18*a+14]=p/q,c.glowShape.vertices[18*a+15]=V/q,c.glowShape.vertices[18*a+16]=D/q,c.glowShape.vertices[18*a+17]=N/q})),c.glowShape.alpha=.1,c.glowShape.color=Me(H[0]+90/i*X-65,H[1],H[2]),c.glowShape.colorMix=(1/X/1e32)**.05*t*100/(1+i),c.glowShape.z=(-X/i/5+3.3333)/q,c.Draw(c.glowShape)}}}c.x=y,c.y=b,c.z=x,c.roll=R,c.pitch=M,c.yaw=A}},he=(e,a)=>{let t=Math.hypot(...e)+1e-5,r=Math.hypot(...a)+1e-5;e[0]/=t,e[1]/=t,e[2]/=t,a[0]/=r,a[1]/=r,a[2]/=r;let o=-e[0]*a[0]+-e[1]*a[1]+-e[2]*a[2];return[-(-e[0]-2*a[0]*o)*t,-(-e[1]-2*a[1]*o)*t,-(-e[2]-2*a[2]*o)*t]},pe=(e,a,t)=>{var r,o,n,s,i,c,l,h=0;return t.map((e=>{e[0],e[1],h++})),h,h,r=e,o=a,1e6,1e6,h=0,t.map(((e,a)=>{n=t[l=a][0],s=t[l][1],l=(a+1)%t.length,i=t[l][0],c=t[l][1],fe(r,o,1e6,1e6,n,s,i,c)&&h++})),1==h},fe=(e,a,t,r,o,n,s,i)=>{var c,l,h;return(c=((s-o)*(a-n)-(i-n)*(e-o))/(l=(i-n)*(t-e)-(s-o)*(r-a)))>=0&&c<=1&&(h=((t-e)*(a-n)-(r-a)*(e-o))/l)>=0&&h<=1&&[e+c*(t-e),a+c*(r-a)]},ue=(e,a=!1,t=0,r=0,o=0)=>{var n,s,i=0,c=0,l=0;e.map((e=>{i+=e[0],c+=e[1],l+=e[2]})),i/=e.length,c/=e.length,l/=e.length;var h=e[2][0]-e[1][0],p=e[2][1]-e[1][1],f=e[2][2]-e[1][2],u=e[1][0]-e[0][0],m=e[1][1]-e[0][1],d=e[1][2]-e[0][2];n=[p*d-f*m,f*u-h*d,h*m-p*u],s=Math.hypot(...n)+1e-4;n=n.map((e=>e/s*1));var g=i,v=c,y=l,b=1;if(a){var x=Math.hypot(g-t,v-r,y-o);b=Math.hypot(t-(i+n[0]/99),r-(c+n[1]/99),o-(l+n[2]/99))>x?-1:1}return[g,v,y,i+(n[0]*=b),c+(n[1]*=b),l+(n[2]*=b)]},me=async(a,t)=>{a.grav=.01,a.mspeed=1,a.rspeed=1,a.cameraMode="fps",a.crosshairMap="",a.showCrosshair=!0,a.crosshairSize=1,a.lastInteraction=0,a.hasTraction=!0,a.focusRequiredForMouse=!0,a.flyMode=!1,a.useKeys=!0,a.crosshairSel=0,a.crosshairAlpha=.6,a.useFPSControls=!0;var n=Array(4).fill().map(((a,t)=>`${e}/resources/crosshairs/crosshair${t+1}.png`));void 0!==t&&Object.keys(t).forEach(((e,r)=>{switch(e.toLowerCase()){case"mspeed":a.mspeed=+t[e];break;case"rspeed":a.rspeed=+t[e];break;case"grav":a.grav=+t[e];break;case"crosshairsel":a.crosshairSel=+t[e];break;case"crosshairsize":a.crosshairSize=+t[e];break;case"flymode":a.flyMode=!!t[e];break;case"usekeys":a.useKeys=!!t[e];break;case"crosshairmap":a.crosshairMap=t[e];break;case"crosshairalpha":a.crosshairAlpha=+t[e];break;case"showcrosshair":a.showCrosshair=!!t[e];break;case"focusrequiredformouse":a.focusRequiredForMouse=!!t[e]}}));if(a.crosshairImages=Array(n.length).fill(),a.crosshairImages.map((async(e,t)=>{a.crosshairImages[t]={img:new Image,loaded:!1},a.crosshairImages[t].img.onload=()=>{a.crosshairImages[t].loaded=!0},await fetch(n[t]).then((e=>e.blob())).then((e=>{a.crosshairImages[t].img.src=URL.createObjectURL(e)}))})),a.crosshairMap&&(a.crosshairSel=n.length,a.crosshairImages.push({img:new Image,loaded:!1}),a.crosshairImages[a.crosshairImages.length-1].img.onload=()=>{a.crosshairImages[a.crosshairImages.length-1].loaded=!0},await fetch(a.crosshairMap).then((e=>e.blob())).then((e=>{a.crosshairImages[a.crosshairImages.length-1].img.src=URL.createObjectURL(e)}))),a.useKeys){var s=.1*a.mspeed,i=.005*a.rspeed,c=0,l=0,h=0,p=0,f=0,u=1;a.rdrag=1.66,a.pdrag=1.2;a.keys=Array(256).fill().map(((e,a)=>!1)),a.keyTimers=Array(256).fill(0),a.keyTimerInterval=.2,window.addEventListener("keydown",(e=>{a.keys[e.keyCode]=!0,a.lastInteraction=a.t})),window.addEventListener("keyup",(e=>{a.keys[e.keyCode]=!1,a.lastInteraction=a.t})),window.addEventListener("mousedown",(e=>{(a.lastInteraction=a.t,0===e.button)&&(!0,document.querySelectorAll(".genericPopup").length||document.body.requestPointerLock({unadjustedMovement:!0}))})),window.addEventListener("mouseup",(e=>{a.lastInteraction=a.t,0===e.button&&!1})),window.addEventListener("mousemove",(e=>{if(a.lastInteraction=a.t,null!=document.pointerLockElement||!a.focusRequiredForMouse){var t=a.c.getBoundingClientRect();(e.pageX-t.left)/a.c.clientWidth*a.c.width,(e.pageY-t.top)/a.c.clientHeight*a.c.height,c-=e.movementX*i,l+=e.movementY*i}})),a.doKeys=async()=>{if(s=.1*a.mspeed,i=.005*a.rspeed,a.yaw+=c,a.pitch+=l,a.pitch=Math.min(Math.PI/2,Math.max(-Math.PI/2,a.pitch)),c/=a.rdrag,l/=a.rdrag,a.x+=h,a.y+=p,a.z+=f,(a.hasTraction||a.flyMode)&&(h/=a.pdrag,p/=a.pdrag,f/=a.pdrag),a.flyMode){var e=-a.yaw+Math.PI,t=a.pitch;switch(a.mouseButton){case 1:h-=r(e)*r(t)*s*u,p+=o(t)*s*u,f-=o(e)*r(t)*s*u;break;case 2:h+=r(e)*r(t)*s*u,p-=o(t)*s*u,f+=o(e)*r(t)*s*u}}u=1,(a.hasTraction||a.flyMode)&&a.keys.map(((e,t)=>{if(a.keys[t])switch(t){case 16:u=3;break;case 37:c+=12*i;break;case 38:l-=12*i;break;case 39:c-=12*i;break;case 40:l+=12*i;break;case 87:var n=-a.yaw+Math.PI,m=a.pitch+Math.PI/2;a.flyMode?(h+=r(n)*r(m)*s*u,p-=o(m)*s*u,f+=o(n)*r(m)*s*u):(h+=r(n)*s*u,f+=o(n)*s*u);break;case 65:n=-a.yaw+Math.PI/2,m=a.pitch+Math.PI/2;a.flyMode,h+=r(n)*s*u,f+=o(n)*s*u;break;case 83:n=-a.yaw+Math.PI,m=a.pitch+Math.PI/2;a.flyMode?(h-=r(n)*r(m)*s*u,p+=o(m)*s*u,f-=o(n)*r(m)*s*u):(h-=r(n)*s*u,f-=o(n)*s*u);break;case 68:n=-a.yaw+Math.PI/2,m=a.pitch+Math.PI/2;a.flyMode,h+=-r(n)*s*u,f+=-o(n)*s*u}}))}}},de=(e,a)=>{const t=async()=>{Ue.margin=e.margin,Ue.rsz(),Ue.width=e.width,Ue.height=e.height,Ue.c.width=e.c.width,Ue.c.height=e.c.height,e.ready&&void 0!==window[a]&&await window[a]();if(["alphaQueue","lineQueue","particleQueue","glowQueue"].forEach((a=>{if(e[a].length){if("glowQueue"==a){var t=[];e.ctx.blendFunc(e.ctx.SRC_ALPHA,e.ctx.ONE),e.ctx.enable(e.ctx.BLEND),e[a].map(((a,o)=>{var n=a.x+e.x,s=a.y+e.y,i=a.z+e.z;r=R(n,s,i,{roll:e.roll,pitch:e.pitch,yaw:e.yaw},!1),t.push({idx:o,z:Math.hypot(e.x+r[0],e.y+r[1],e.z+r[2])})})),t.sort(((e,a)=>a.z-e.z)),e[a].map(((r,o)=>{var n=e[a][t[o].idx].geometry;le(n,n.glowColor,n.glowAlpha,n.glowIncludeShape,n.glowRadius,n.glowResolution,n.glowRenderTarget)})),e.ctx.blendFunc(e.ctx.ONE,e.ctx.ZERO),e.ctx.disable(e.ctx.BLEND)}else{var r;t=[];e.ctx.blendFunc(e.ctx.SRC_ALPHA,e.ctx.ONE),e.ctx.enable(e.ctx.BLEND),e[a].map(((a,o)=>{var n=a.x+e.x,s=a.y+e.y,i=a.z+e.z;r=R(n,s,i,{roll:e.roll,pitch:e.pitch,yaw:e.yaw},!1),t.push({idx:o,z:Math.hypot(e.x+r[0],e.y+r[1],e.z+r[2])})})),t.sort(((e,a)=>a.z-e.z)),e[a].map((async(r,o)=>{var n=e[a][t[o].idx].geometry,s=n.vertices,i=n.size;n.size=e[a][t[o].idx].size,n.vertices=e[a][t[o].idx].vertices,n.x=e[a][t[o].idx].x,n.y=e[a][t[o].idx].y,n.z=e[a][t[o].idx].z,n.roll=e[a][t[o].idx].roll,n.pitch=e[a][t[o].idx].pitch,n.yaw=e[a][t[o].idx].yaw;for(var c=n.penumbra,l=1+((n.isLine||n.isParticle)&&c?1:0);l--;)e.Draw(n,!0,(n.isParticle||n.isLine)&&c&&!l);n.vertices=s,n.size=i})),e.ctx.blendFunc(e.ctx.ONE,e.ctx.ZERO),e.ctx.disable(e.ctx.BLEND)}e[a]=[]}})),e.t+=1/60,requestAnimationFrame(t),"fps"==e.cameraMode&&(e.useKeys&&e.doKeys&&await e.doKeys(),e.showCrosshair&&e.crosshairImages[e.crosshairSel].loaded)){var r=200*e.crosshairSize;Ue.ctx.globalAlpha=e.crosshairAlpha,Ue.ctx.drawImage(e.crosshairImages[e.crosshairSel].img,Ue.width/2-r/2,Ue.height/2-r/2,r,r),Ue.ctx.globalAlpha=1}};window.addEventListener("load",(()=>{e.ready=!0,t()}))},ge=(e,a,t)=>ve(e,a,t),ve=(e,a,t)=>{let r=e/255,o=a/255,n=t/255,s=Math.min(r,o,n),i=Math.max(r,o,n),c=i,l=i-s,h=i?l/i:0,p=Math.min(e,a,t),f=Math.max(e,a,t),u=0;for(l&&(e>=a&&e>=t&&(u=(a-t)/(f-p)),a>=e&&a>=t&&(u=2+(t-e)/(f-p)),t>=a&&t>=e&&(u=4+(e-a)/(f-p))),u*=60;u<0;)u+=360;for(;u>=360;)u-=360;return[u,h,c]},ye=(e,a)=>{for(var t=Array(e.length).fill(),r=0;r<e.length;r++){var o=r%e.length;switch(a){case"left":o--;break;case"right":o++}o<0&&(o=width-1);var n=o%=width;t[r]=e[n]}for(r=0;r<e.length;r++)e[r]=t[r];return t},be=(e,a,t)=>{for(var r=Array(e.length).fill(),o=0;o<e.length;o++){var n=o%t,s=o/t|0;switch(a){case"left":n--;break;case"up":s++;break;case"right":n++;break;case"down":s--}n<0&&(n=t-1),s<0&&(s+=e.length/t|0);var i=(n%=t)+(s%=e.length/t|0)*t;r[o]=e[i]}for(o=0;o<e.length;o++)e[o]=r[o];return r},xe=(e,a,t,r)=>{for(var o=Array(e.length).fill(),n=0;n<e.length;n++){var s=n%t,i=(n/t|0)%r,c=n/t/r|0;switch(a){case"left":s--;break;case"up":i++;break;case"right":s++;break;case"down":i--;break;case"forward":c++;break;case"backward":c--}s<0&&(s=t-1),i<0&&(i+=r),c<0&&(c+=e.length/t/r|0);var l=(s%=t)+(i%=r)*t+(c%=e.length/t/r|0)*t*r;o[n]=e[l]}for(n=0;n<e.length;n++)e[n]=o[n];return o},Re=e=>void 0!==e.length&&void 0!==e.forEach,Me=(e,a,t)=>Ae(e,a,t),Ae=(e,a,t)=>{let r=Te(e,a,t);return Pe(...r)},Ee=(e,a,t)=>Te(e,a,t),Te=(e,a,t)=>{for(;e<0;)e+=360;for(;e>=360;)e-=360;let r,o,n,s=t*a,i=s*(1-Math.abs(e/60%2-1)),c=t-s;return e>=0&&e<60&&(r=s,o=i,n=0),e>=60&&e<120&&(r=i,o=s,n=0),e>=120&&e<180&&(r=0,o=s,n=i),e>=180&&e<240&&(r=0,o=i,n=s),e>=240&&e<300&&(r=i,o=0,n=s),e>=300&&e<360&&(r=s,o=0,n=i),[255*(r+c),255*(o+c),255*(n+c)]},we=(e,a,t)=>Pe(e,a,t),Pe=(e,a,t)=>{let r="0123456789abcdef",o="";return o+=r[e/16|0],o+=r[e-16*(e/16|0)|0],o+=r[a/16|0],o+=r[a-16*(a/16|0)|0],o+=r[t/16|0],o+=r[t-16*(t/16|0)|0],Number("0x"+o)},_e=e=>Le(e),Le=e=>[e/256**3-(e/256**3|0),e/65536-(e/65536|0),e/256-(e/256|0)],Ie=e=>{var a=Object.keys(Object.getPrototypeOf(e));a.sort();var t=[];a.map((a=>{t.push({name:a,val:e.getParameter(e[a])})}));var r=document.createElement("div");r.style.position="fixed",r.style.zIndex=1e5,r.style.left="50%",r.style.top="50%",r.style.transform="translate(-50%, -50%)",r.style.background="#0008",r.style.padding="20px",r.style.width="600px",r.style.height="350px",r.style.border="1px solid #fff4",r.style.borderRadius="5px",r.style.fontFamily="monospace",r.style.fontSize="20px",r.style.color="#fff";var o=document.createElement("div");o.style.fontSize="24px",o.style.color="#0f8c",o.innerHTML="rendering context parameters<br><br>",r.appendChild(o);var n=document.createElement("div");n.style.minWidth="100%",n.style.height="250px",n.style.background="#333",n.style.border="1px solid #fff4",n.style.overflowY="auto",n.style.wordWrap="break-word",n.style.color="#888",n.style.fontSize="10px",r.appendChild(n);var s=document.createElement("button");s.style.border="none",s.style.padding="3px",s.style.cursor="pointer",s.fontSize="20px",s.style.borderRadius="10px",s.style.margin="10px",s.style.minWidth="100px",s.innerHTML="📋 copy",s.title="copy shape data to clipboard",s.onclick=()=>{var e=document.createRange();e.selectNode(n),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),document.execCommand("copy"),window.getSelection().removeAllRanges(),s.innerHTML="COPIED!",setTimeout((()=>{s.innerHTML="📋 copy"}),1e3)},r.appendChild(s);var i=document.createElement("button");i.onclick=()=>r.remove(),i.style.border="none",i.style.padding="3px",i.style.cursor="pointer",i.fontSize="20px",i.style.borderRadius="10px",i.style.margin="10px",i.style.background="#faa",i.style.minWidth="100px",i.innerHTML="close",r.appendChild(i),n.innerHTML=JSON.stringify(t),document.body.appendChild(r)},ke=e=>{var a=Math.sin,t=Math.cos,r=t(e[0]),o=a(e[0]),n=t(e[1]),s=a(e[1]),i=t(e[2]),c=a(e[2]);return[r*n+(r*s*c-o*i)+(r*s*i+o*c),o*n+(o*s*c+r*i)+(o*s*i-r*c),-s+n*c+n*i]},Fe={push:async(e,a)=>{console.log("push"),e.dataArray.items.push(a)},pop:async(e,a)=>{console.log("pop")},insert:async(e,a)=>{console.log("insert")},slice:async(e,a)=>{console.log("slice")},test:(e,a,t,n,s)=>{var i,c,l,h,p,f=a.length**.5|0,u=0,m=f;f+=1,i=n/2,c=s/2;var d,g,v,y=!1;if(e.dataArray.items.length){y=!1;do{for(var b=Math.hypot(n,s),x=0;!y&&x<b;x+=1*f|0){for(var R=3;!y&&R--;)if(!y&&(h=i+r(l=2*Math.PI/3*R+u/3+16*e.t)*x-f/2|0,p=c+o(l)*x/(16/9)-f/2|0,h>=0&&h+f<n&&p>=0&&p+f<s)){var M=[[h,p],[h+f,p],[h+f,p+f],[h,p+f]];v=!1,e.dataArray.items.forEach(((e,a)=>{if(!v){var t=[[e.posx,e.posy],[e.posx+e.width,e.posy],[e.posx+e.width,e.posy+e.width],[e.posx,e.posy+e.width]];M.forEach((e=>{pe(e[0],e[1],t)&&(v=!0)})),t.forEach((e=>{pe(e[0],e[1],M)&&(v=!0)}))}})),v||y||(y=!0,d=h,g=p)}u++}}while(u<1e4&&!y)}else y=!0,d=0|i,g=0|c;e.dataArray.items.push({array:a,posx:d,posy:g,width:f}),a.forEach(((e,a)=>{var r=4*(d+a%m+(g+a/m|0)*n|0)|0;t[r+0]=0|e[0],t[r+1]=0|e[1],t[r+2]=0|e[2],t[r+3]=255}));var A=-6e6,E=-6e6,T=6e6,w=6e6;return e.dataArray.items.forEach(((e,a)=>{e.posx<T&&(T=e.posx),e.posx>A&&(A=e.posx),e.posy<w&&(w=e.posy),e.posy>E&&(E=e.posy)})),[A,E]}},ze=e=>a.GenHash(e);var Ue;(Ue=await f({context:{mode:"2d",margin:0}})).c.style.background="#0000",Ue.c.style.zIndex=10;var Ce,Se=document.createElement("canvas"),Be=Se.getContext("2d",{willReadFrequently:!0});export{f as Renderer,k as LoadGeometry,D as BasicShader,m as DestroyRenderer,u as ResizeRenderer,g as DestroyShape,de as AnimationLoop,Z as Tetrahedron,ae as Cube,K as Octahedron,J as Icosahedron,ee as Dodecahedron,$ as Cylinder,Fe as ShapeArray,Y as ShapeFromArray,G as Torus,L as DownloadCustomShape,w as LoadAnimationFromZip,P as DrawAnimation,Q as TorusKnot,te as Rectangle,x as Q,R,M as R_ypr,A as R_pyr,E as R_rpy,C as ComputeNormalAssocs,S as SyncNormals,fe as Intersects,pe as PointInPoly2D,se as PointInPoly3D,H as ShapeToLines,O as ShowBounding,N as ProcessShapeArray,B as GetShaderCoord,he as Reflect,ue as Normal,ce as BSpline,ke as Quat,le as Glow,ie as CurveTo,ye as ShiftArray,be as ShiftArray2D,xe as ShiftArray3D,z as ImageToPo2,b as LoadOBJ,ne as IsPowerOf2,ge as RGBToHSV,Me as HSVToHex,ve as HSVFromRGB,Ae as HexFromHSV,Ee as HSVToRGB,Te as RGBFromHSV,we as HexFromRGB,Pe as RGBToHex,_e as RGBFromHex,Le as HexToRGB,W as GeoSphere,e as ModuleBase,me as LoadFPSControls,re as GetGlyphLuminosities,oe as SceneToASCII,X as GeometryFromRaw,Ue as Overlay,ze as GenHash,Re as IsArray};